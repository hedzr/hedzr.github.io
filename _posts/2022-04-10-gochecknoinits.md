---
layout: single
title: 'gochecknoinits - init() æ˜¯ä¸æ˜¯çœŸçš„å¾ˆè¦ä¸å¾—'
date: 2022-04-10 05:00:00 +0800
last_modified_at: 2022-04-10 13:55:00 +0800
Author: hedzr
tags: [golang, logging]
categories: golang logging
comments: true
toc: true
header:
  teaser: https://cdn.jsdelivr.net/gh/hzimg/blog-pics@master/uPic/image-20220202111728058.png
  overlay_image: /assets/images/unsplash-image-3.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  bgo ç°åœ¨ä¸ä»…ä»…æ˜¯ä¸ª main åŒ…æ‰¹é‡æ„å»ºå™¨äº† ...
---



## ä¸èƒ½ä½¿ç”¨ init() å—



æœ€è¿‘ä¸€æ®µæ—¶é—´ï¼Œè¾ƒå¤šæ”¹ç”¨ golangci-lint å·¥å…·ã€‚è¿™æ˜¯å› ä¸º golint å·²ç»åœæ­¢ç»´æŠ¤äº†ï¼Œæ‰€ä»¥é¢å¯¹ä¸æ–­é‡Šå‡ºçš„ golang æ–°ç‰ˆæœ¬ï¼Œå°±å¿…é¡»å¯¹å„ç±»è¾…åŠ©å·¥å…·åŒæ­¥è¿›è¡Œæ›´æ–°ã€‚æ¯”å¦‚è¯´ gofmt æ—¶ä¸æ—¶æœ‰ç‚¹ä¸å¦¥äº†ï¼Œgocyclo è®¤ä¸å¾—æ³›å‹è¯­æ³•äº†ï¼Œç­‰ç­‰ã€‚å¾ˆå¤šå·¥å…·ç›®å‰å°šæœªæœ‰æ–°ç‰ˆæœ¬å‘æ”¾ï¼ŒGoLand ä¹Ÿæ€»æ˜¯çˆ±å´©æºƒäº†ï¼Œæ‰€ä»¥é¢å¯¹ go 1.18 æ¥è®²ï¼Œé—®é¢˜è¿˜å¾ˆå¤šã€‚

è¨€å½’æ­£ä¼ ï¼Œä½¿ç”¨æ–°çš„ lint å·¥å…·ï¼Œå¾ˆå¤šæŠ¥é”™ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯ Effective Go ä¸€æ–‡ä¸­æåŠçš„å„ç±»ä¸è‰¯å‘³é“ã€‚

å…¶ä¸­ gochecknoinits é”™è¯¯å°±æ˜¯ä¸€æ¡ã€‚

æŠ¥é”™æ˜¯è¿™æ ·çš„ï¼š

```bash
diff/v/a.go:3:1: don't use `init` function (gochecknoinits)
func init() {
^

```

å¯¹åº”çš„æºç æ˜¯è¿™æ ·çš„ï¼š

```go file=a.go
package v

func init() {
	println("a.init")
}

var A int
```

### æ¶ˆé™¤è¿™ä¸ªé”™è¯¯

ä½¿ç”¨ nolint æ³¨é‡Šå¯ä»¥æ¶ˆé™¤è¿™ä¸ªé”™è¯¯ï¼š

```go
package v

func init() { //nolint:gochecknoinits
	println("a.init")
}

var A int
```



### ç ”ç©¶è¿™ä¸ªé”™è¯¯

é‚£ä¹ˆï¼Œå®ƒæ˜¯ä¸æ˜¯çœŸçš„æ˜¯ä¸ªé”™è¯¯å‘¢ï¼Ÿ

å¯¹äºæˆ‘ä»¬çš„ä»£ç ï¼Œåœ¨ init å‡½æ•°ä¸­åšä¸€äº›å…¨å±€æ€§çš„åˆå§‹åŒ–ï¼Œä»¤å…¶é›†ä¸­åˆ°ä¸€å¤„ï¼Œæœ‰è‹¥å¹²å¥½å¤„ï¼š

1. æ¯”è¾ƒäºå…¨å±€å˜é‡åœ¨å£°æ˜å¤„å°±åœ°èµ‹å€¼æ¥è¯´ï¼Œinit() èƒ½å¤Ÿæ­£ç¡®çº¦æŸåˆå§‹åŒ–é¡ºåºï¼Œè¿™ä¸€ç‚¹æœ‰æ—¶å€™æ˜¯æˆ‘ä»¬æ‰€å¿…éœ€çš„
2. init èƒ½å¤Ÿæä¾›å¤æ‚çš„åˆå§‹åŒ–é€»è¾‘ï¼Œä»è€Œä¸å¿…å—åˆ¶äºå˜é‡å£°æ˜å¹¶èµ‹å€¼çš„è¯­æ³•
2. åœ¨å˜é‡å£°æ˜æ—¶ä½¿ç”¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥ç»™ä»˜åˆå€¼ï¼Œæœ‰å¯èƒ½æ˜¯å¦ä¸€ç§æ»¥ç”¨ï¼šä½ å¯ä»¥ä¼šä¸èƒ½è§‰å¯Ÿåˆ°æ²‰é‡çš„åˆå§‹åŒ–å»¶è¿Ÿæ˜¯æ¥è‡ªäºä¸æ°å½“çš„åˆå€¼æ„é€ ã€‚ä½†å¦‚æœä½¿ç”¨ init çš„è¯ï¼Œé€šå¸¸æ›´å®¹æ˜“è­¦é†’äºæ­¤ã€‚

è¿™äº›å¥½å¤„ä¸è§å¾—æ˜¯å¿…ç„¶çš„ã€å¿…éœ€çš„ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯ä»¥æœ‰å¤šç§æ–¹æ³•æ¥æ”¹å†™ä»£ç è¶Šè¿‡é™åˆ¶ã€‚

æ‰€ä»¥è¯´ init() å¦‚æ­¤çš„æœ‰ç”¨ï¼Œæ€ä¹ˆå°±æˆä¸ºäº† bad smell äº†å‘¢ï¼Ÿ

åå¯¹è€…ä»¬æ˜¯è¿™ä¹ˆè¯´çš„ï¼š

å› ä¸º init() çš„ç”¨é€”æœ¬è´¨ä¸Šå°±æ˜¯åˆå§‹åŒ–å…¨å±€å˜é‡ï¼Œè€Œè‰¯å¥½çš„ä»£ç ä¹ æƒ¯æ˜¯å°½å¯èƒ½åˆ«è¦ç”¨å…¨å±€å˜é‡ï¼Œæ‰€ä»¥é¡ºç†æˆç« åœ°ä¹Ÿå°±ä¸åº”è¯¥ä½¿ç”¨ init()ã€‚è¿™ä¸éš¾ç†è§£ï¼Œå¯¹å—ï¼Ÿ

ä¸ºä½•ä¸åº”è¯¥ä½¿ç”¨å…¨å±€å˜é‡å‘¢ï¼ŸæŒ‰ç…§ Golang åˆ›å§‹äººä¹‹ä¸€çš„è¯´æ³•æ˜¯ï¼Œé¿å…è¾¹é™…æ•ˆåº”ï¼Œä¸è¦ä½¿ç”¨åŒ…çº§åˆ«çš„å…¨å±€å˜é‡ã€‚

> \- no side effect imports
> \- no package level variables

æ‰€è°“è¾¹é™…æ•ˆåº”ï¼Œå…¶å®æ˜¯æŒ‡å…¨å±€å˜é‡è¢«åœ¨ init ä¸­è¢«ä»¥å„ç§æ½œåœ¨å¯èƒ½çš„æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´å˜é‡çš„å€¼è¢«æ„å¤–åœ°è®¾å®šåˆ°éé¢„æœŸçš„çŠ¶æ€ã€‚è¿™ä¸€ç‚¹æ¯”è¾ƒéº»çƒ¦ï¼Œå¾—æ˜¯è¦å¤šä¹ˆæ— ç†æ‰ä¼šå†™å‡ºé‚£ä¹ˆå¥‡è‘©çš„ä»£ç åºåˆ—å–ã€‚ç„¶è€Œï¼ŒDeve Cheney çš„è¯ä¹Ÿå¹¶ä¸å°½ç„¶æ˜¯å±è¨€è€¸å¬ã€‚

æ­¤å¤–ï¼Œç”±äºå˜é‡çš„åˆå§‹åŒ–è¢«è½¬ç§»åˆ°äº† init å‡½æ•°ä½“ä¸­ï¼ˆç”šè‡³äºè¿›ä¸€æ­¥åœ°è¿ç§»åˆ°æŸäº›å­å‡½æ•°ä¸­ï¼‰ï¼Œå®ƒçš„å£°æ˜å¤„çš„ä»£ç å°±æ— æ³•ä½“ç°å‡ºæ­£ç¡®çš„å˜é‡çŠ¶æ€ï¼Œä½ å¿…é¡»åœ¨æ•´ä¸ªåŒ…ä¸­ç¿»æ‹£å…¨éƒ¨çš„ init å‡½æ•°ï¼Œä»¥åŠå…¨éƒ¨ç›¸å…³çš„å­å‡½æ•°è°ƒç”¨ï¼Œæ‰èƒ½æŸ¥è¯åˆ°è¯¥å˜é‡ç©¶ç«Ÿä¼šå¾—åˆ°ä¸€ä¸ªä»€ä¹ˆæ ·çš„åˆå€¼ã€‚ä»è¿™ä¸ªç»“æœæ¥è¯´ï¼ŒæŠŠ init çœ‹ä½œæ˜¯ä¸è‰¯ä»£ç ä¹ æƒ¯ä¹Ÿä¸ç®—å¤ªå†¤æ‰ã€‚

è¯è¯´å›æ¥ï¼Œç”¨å¯¹äº†ï¼Œå°±æ˜¯å¥½åˆ€ï¼›ç”¨é”™äº†ï¼Œéš¾å…å°±ä¼šå‰²åˆ°æ‰‹ã€‚



### ç»“è®º

æ‰€ä»¥å¯¹äºç»ˆç«¯å¼€å‘è€…æ¥è¯´ï¼Œé¿å… init åŸºæœ¬ä¸Šæ˜¯æ­£ç¡®çš„æ€åº¦ã€‚é¡ºä¾¿ï¼Œä¹Ÿé¿å…æ»¥ç”¨å…¨å±€å˜é‡ã€‚

ä½†æ˜¯å¯¹äºåº“ä½œè€…æ¥è¯´ï¼Œå—¯ï¼Œæ˜¯çš„ï¼Œè¯´çš„å°±æ˜¯æˆ‘è‡ªå·±ï¼Œé‚£ä¹ˆè¯¥ç”¨å°±ç”¨ï¼Œæœ€å¤šä¸è¿‡åŠ æ¡ nolint æ³¨é‡Šä¹Ÿæ²¡ä»€ä¹ˆå¤§ä¸äº†çš„ã€‚

> Why?
>
> åº“ä½œè€…çŸ¥é“è‡ªå·±åœ¨å¹²ä»€ä¹ˆï¼Œä¹ŸçŸ¥é“è‡ªå·±è¯¥å¹²ä»€ä¹ˆï¼Œæ‰€ä»¥ä»–æœ‰æƒåˆ©å˜åºŸä¸ºå®ã€‚





### åè¯

é™¤äº† gochecknoinits ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª gochecknoglobals ï¼Œå¤§å®¶æ˜¯å·®ä¸å¤šçš„ï¼Œå°±ä¸å†å¦æ–‡äº†ã€‚

å¦å¤–ï¼Œæ›´æ°å½“çš„æ¶ˆé™¤æ–¹æ¡ˆæ˜¯é…ç½®ä¸€ä¸ªä¹…ç»è€ƒéªŒçš„ golangci é…ç½®æ–‡ä»¶ã€‚è¿™ä¸€æ–¹æ¡ˆï¼Œæˆ–è®¸æˆ‘ä¼šåœ¨ä»¥åçš„æ–‡ç« ä¸­æå‡ºä¸€ä»½å‚è€ƒï¼Œç›®å‰æ¥è¯´å…ˆæ”¾ä¸€æ”¾å§ã€‚



### REFs

- [Go: No globals, no init functions (leighmcculloch.com)](https://leighmcculloch.com/posts/tool-go-check-no-globals-no-inits/)
- [Is it really bad to use init in go? - Stack Overflow](https://stackoverflow.com/questions/56039154/is-it-really-bad-to-use-init-in-go)





ğŸ”š