---
layout: single
title: 'cmake 03 - Modern CMake Style'
date: 2020-11-21 16:03:00 +0800
last_modified: 2020-11-21 16:03:00 +0800
Author: hedzr
tags: [c++, cmake, build, modern cmake]
categories: cmake notes
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  First Look About Modern CMake...
---



ä»¥ä¸‹å†…å®¹å®Œå…¨é¢å‘åˆå­¦è€…ï¼Œå®Œå…¨æ²¡æœ‰å‚è€ƒç›¸å…³åŸæ–‡ï¼Œå®Œå…¨ä¾ç…§ä¸ªäººç†è§£æˆæ–‡ï¼Œæ‰€ä»¥æ¬ ç¼ºä½“ç³»æ€§ã€‚è‹¥è¦ç³»ç»Ÿå­¦ä¹  cmake çš„ modern style ä¸å¦¨ç›´è¾¾æˆ‘æ‰€åˆ—å‡ºçš„ Modern CMake çš„ç›¸å…³ç½‘ç«™ï¼Œä¹Ÿå¯ä»¥è¿½æ›´æˆ‘åç»­çš„æ–‡å­—ï¼Œæš‚æ—¶æ‰“ç®—çš„æ˜¯é€æ­¥æŠ½ç©ºå®Œæˆä¸€ä¸ªç³»åˆ—ï¼Œå±Šæ—¶æ‰èƒ½å‘ˆç°å‡ºè¾ƒä¸ºæ­£å¼çš„ç‰ˆæœ¬ã€‚

>æœ¬æ–‡å¯èƒ½éœ€è¦è¿›ä¸€æ­¥æ ¡è®¢ç»†å¾®ä¹‹å¤„ï¼Œæœªæ¥å…¨ç³»åˆ—æ–‡å­—å…¨æ•°å°±ç»ªä¹‹åå°†ä¼šä»¥æ–°ç‰ˆæœ¬å‘ˆç°ï¼ˆä½†åº”è¯¥ä¸ä¼šæœ‰æŠ€æœ¯å†…å®¹ä¸Šçš„å˜åŒ–ï¼Œè€Œæ˜¯åœ¨äºæªè¾ä¸ç»“æ„ä¸Šï¼‰ã€‚



## ç°ä»£ç¼–ç¨‹ç»“æ„

CMAKE è‡ªèº«ï¼Œå°±æ˜¯ä¸€ä¸ªç¼–ç¨‹è¯­è¨€ï¼Œè™½ç„¶å¾ˆç¬¨çš„æ ·å­ã€‚

è€å®è¯´æˆ‘å€’æ˜¯å¾ˆé„™è§† CMAKE è¿™æ‰€è°“çš„è¯­è¨€ï¼ŒçœŸçš„æ˜¯å¼„å¾—å¤ªå•°å—¦å¤ªåˆ«æ‰­äº†ã€‚

ä¸è¿‡æˆ‘ä¹Ÿæ‰¿è®¤ CMake æœ‰ä¸€ä¸ªå¾ˆå¥½çš„ç”Ÿæ€ï¼Œæ‰€ä»¥ç°åœ¨æˆ‘ä»¬çœ‹åˆ°ä»€ä¹ˆ ninjia scons åŸºæœ¬ä¸Šéƒ½åƒæ——æ¯é¼“äº†ï¼Œä½† CMake çš„æ´»è·ƒåº¦ä¾æ—§å¾ˆé«˜ã€‚

---

CMakeä»3.0å¼€å§‹è¿›å…¥Modernæ—¶ä»£ï¼Œå…³äºè¿™ä¸ªæ—¶ä»£çš„æ¼”è¿›å†å²å¯ä»¥å‚çœ‹  [What's new in CMake Â· Modern CMake](https://cliutils.gitlab.io/modern-cmake/chapters/intro/newcmake.html) ã€‚

ä½†æˆ–è®¸ä¹Ÿåº”æ³¨æ„åˆ°ï¼Œç›´åˆ°å¤§çº¦ v3.5 ä¹‹åï¼Œå…¶æ‰€è°“çš„ Modern é£æ ¼æ‰é€æ¸å®Œå–„ï¼Œä¸­é—´è¿‡ç¨‹ä¸­åˆæœ‰è‹¥å¹²çš„æ–°å¢å†…å®¹å’ŒåºŸå¼ƒå†…å®¹ï¼Œå¯æƒ³è€ŒçŸ¥è¿™ä¸­é—´æœ‰å¤šå°‘è¿‡æ¸¡æ€§çš„ä¸œè¥¿æ—©å·²è¯¥è¢«åºŸå¼ƒï¼Œåˆæœ‰å¤šå°‘ä»¥è®¹ä¼ è®¹çš„å†…å®¹åœ¨ä¸­æ–‡ç½‘è·¯ä¸Šæµä¼ ã€‚

---

é‚£ä¹ˆ CMake ç°åœ¨ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ Modern CMake[^1] çš„è„šæœ¬æ˜¯ç”¨è¿™ä¹ˆä¸€ç§ç¼–ç¨‹ç»“æ„ï¼š

1. æœ‰ä¸€ä¸ªæ ¹ç›®å½•ä»¥åŠ `CMakeLists.txt`ã€‚
2. æœ‰è‹¥å¹²å­ç›®å½•ä»¥åŠç›¸åº”çš„ `CMakeLists.txt`ï¼Œå¹¶ä¸”è¢«é€šè¿‡ add_subdirectory() çš„æ–¹å¼æ·»åŠ åˆ°æ ¹ç›®å½•çš„ `CMakeLists.txt` çš„æœ«å°¾ï¼Œä»è€Œæ„æˆä¸€ä¸ªå®Œæ•´çš„æ„å»ºé“¾ã€‚

æˆ‘ä»¬é€šè¿‡è¿™æ ·çš„ç¼–ç¨‹ç»“æ„æ¥ç®¡ç†ä¸€ä¸ª**å·¥ä½œåŒºï¼ˆWorkspaceï¼‰**ä¸­çš„è‹¥å¹²**å­é¡¹ç›®ï¼ˆProjectsï¼‰**ä»¥åŠå­é¡¹ç›®ä¸­çš„è‹¥å¹²**æ„å»ºç›®æ ‡ï¼ˆTargetsï¼‰**ã€‚

>Modern CMake æœ€è‘—åçš„æ˜¯çš„ä¸€ä¸ªå¼€æºä¹¦ç±ï¼š<https://cliutils.gitlab.io/modern-cmake/>ã€‚å®ƒç”± [Henry Schreiner](https://iscinumpy.gitlab.io/) ç¼–å†™ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›[è´¡çŒ®è€…](https://gitlab.com/CLIUtils/modern-cmake/-/network/master)ä¸ºå…¶å®Œå–„ã€‚
>
>æ­¤å¤–ï¼ŒYoutube ä¸Šæœ‰å‡ ä»½èµ„æºå¯ä»¥åº·åº·ï¼š
>
>1. More Modern CMake - Deniz Bahadir - Meeting C++ 2018[^2] - https://www.youtube.com/watch?v=y7ndUhdQuU8 
>
>2. C ++ç°åœ¨2017å¹´ï¼šä¸¹å°¼å°”Â·è²è´¹å°”â€œæœ‰æ•ˆçš„CMakeâ€ [^3] - https://www.youtube.com/watch?v=bsXLMQ6WgIk
>
>å¦å¤–ï¼Œ[Effective Modern CMake ä¸­è¯‘](https://phenix3443.github.io/notebook/cmake/effective-modern-cmake.html)[^4] æ˜¯ä¸€ç¯‡å¥½æ–‡ç« ã€‚è€Œæœ‰äººä¹Ÿåšäº†
>
>[<<Modern CMake>> ç¿»è¯‘ 1. CMake ä»‹ç» - æ•°æ®ç®¡ç†ä¹å›­ - åšå®¢å›­](https://www.cnblogs.com/hejiang/p/11247618.html)[^5] ä½†æ ¼å¼å¤ªå·®ï¼Œä¸æ˜“é˜…è¯»ã€‚ä¸è¿‡ Modern CMake è¿˜æœ‰å¦ä¸€ä»½è¯‘æ–‡ï¼š[github](https://github.com/RaymondZuo301/ModernCMake-Chinese), [gitbook](https://xiazuomo.gitbook.io/modern-cmake-chinese/[^6]ï¼Œåªä¸è¿‡ç¿»è¯‘è¿›åº¦æœ‰ç‚¹æ„Ÿäººã€‚



### é¡¶çº§ CMakeLists.txt

åœ¨ Source Tree æ ¹ç›®å½•çš„ `CMakeLists.txt` ä¸­ï¼Œé€šå¸¸å®ŒæˆåŸºæœ¬æ„å»ºç¯å¢ƒçš„å‡†å¤‡ï¼Œä¾‹å¦‚æ£€æµ‹æœ‰æ•ˆçš„æ„å»ºå·¥å…·ï¼Œæ£€æµ‹ä¾èµ–çš„ä¸‰æ–¹åº“ï¼Œå®šä¹‰å…¬å…±è¾¹å¢ƒï¼Œç­‰ç­‰ã€‚

æˆ‘ä»¬æŠŠæ ¹ç›®å½•çš„ CMakeLists.txt çœ‹ä½œæ˜¯ä¸€ä¸ª **Workspace**ï¼Œå…¶ä¸­çš„æ¯ä¸ªå­ç›®å½•å¯ä»¥ä½¿ç”¨ project å®æ¥å®šä¹‰å¤šä¸ª**å­é¡¹ç›®**ï¼Œè€Œæ¯ä¸ªå­é¡¹ç›®çš„ä½œç”¨åŸŸèŒƒå›´ä¸­åˆ†åˆ«ä¹Ÿå¯ä»¥å®šä¹‰ä¸€åˆ°å¤šä¸ª **Targets**ã€‚

ä¸€ä¸ªæ ·æœ¬æ˜¯ï¼š

```cmake
cmake_minimum_required(VERSION 3.9..3.13)

set(CMAKE_SCRIPTS "cmake")
set(CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/modules;${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS};${CMAKE_MODULE_PATH}")
# message("CMAKE_MODULE_PATH = ${CMAKE_MODULE_PATH}") ###


include(add-policies)     # ${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/
include(detect-systems)
include(target-dirs)
include(utils)


project(study-cmake
        VERSION 0.3.1.2
        DESCRIPTION "the examples of study-cmake"
        LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# set(CMAKE_CXX_EXTENSIONS OFF)

include(setup-build-env)

set(ARCHIVE_NAME ${CMAKE_PROJECT_NAME}-${PROJECT_VERSION})
set(xVERSION_IN ${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/version.h.in)
include(gen-versions)

debug_print_top_vars()


add_subdirectory(z01-hello-1)
add_subdirectory(z02-library-1)
add_subdirectory(z03-library-2)
add_subdirectory(z04-header-library)

debug_print_value(CMAKE_RUNTIME_OUTPUT_DIRECTORY)
```

å½“å‰æˆ‘ä»¬å¹¶ä¸å¯¹æ­¤æ ·æœ¬å¤šåŠ è§£é‡Šï¼Œä»Šåä¼šåœ¨ä»‹ç»äº†è¶³å¤Ÿçš„çŸ¥è¯†ç‚¹ä¹‹åå¦è¡Œä»‹ç»å®ƒçš„è¡ç”Ÿç‰ˆæœ¬â€”â€”æ‰€è°“çš„ CMake çš„æœ€ä½³å®è·µã€‚



### å­ç›®å½•ä¸­çš„ CMakeLists.txt

å­ç›®å½•è¢«ç”¨äºå®‰æ’æˆ‘ä»¬çš„æ¯ä¸ªå­é¡¹ç›®ã€‚è¿™äº›å­é¡¹ç›®ä¸­åŒ…å«ç€ä¸€ä¸ªæˆ–è€…å¤šä¸ª Targetsï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥è®©æŸä¸ªå­ç›®å½•ä¸­çš„ CMakeLists.txt ä¸å¿…ç¼–å†™ä¸€ä¸ª Target äºå…¶ä¸­ï¼Œè¿™æ˜¯è¢«å…è®¸çš„ã€‚



#### ä¼ ç»Ÿæ–¹æ³•

é¦–å…ˆçš„ä¸€ç§æ–¹æ¡ˆï¼Œå¯ä»¥å‚è€ƒå‰ä¸¤ç¯‡ç¬”è®°ä¸­çš„å®ä¾‹ã€‚åœ¨æ—©å‰çš„ç« èŠ‚é‡Œï¼Œæˆ‘ä»¬ç»™å‡ºäº†éå¸¸ä¼ ç»Ÿçš„ CMake è„šæœ¬ç¼–å†™æ–¹æ³•ã€‚

ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬çš„æ¯ä¸€ä¸ªå­é¡¹ç›®ï¼Œä»¥ project å¼€å¤´ï¼Œä»¥ include_directories, set(cxx_flags) ç­‰é…ç½®é¡¹ç»§ä¹‹ï¼Œåæ¥ add_executable/add_library å£°æ˜ä¸€ä¸ªç¡®åˆ‡çš„ targetï¼Œä½†ä½ ä¹Ÿå¯ä»¥å£°æ˜å¤šä¸ª Targetsã€‚

æ‰€ä»¥ä¸€ä¸ªæ ·æœ¬å½¢å¦‚è¿™æ ·ï¼š

```cmake
# The muchs library
# set (header_files ${CMAKE_CURRENT_SOURCE_DIR}/include/muchs/muchs.hh)
FILE(GLOB_RECURSE header_files ${CMAKE_CURRENT_SOURCE_DIR}/include/*.hh)
LIST(APPEND source_files library.cc)

# library
add_library(muchs STATIC ${source_files} ${header_files})
target_include_directories(muchs PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

# The main program

# The sources shared between the main program and the tests
set(PROJECT_SOURCES main.cc)

add_executable(library-1-test-program ${PROJECT_SOURCES})
target_link_libraries(library-1-test-program PRIVATE muchs)
```



#### Modern CMake æ–¹æ³•

ç„¶è€Œï¼Œä¼ ç»Ÿæ–¹æ³•è‡ªä» cmake 3.0 èµ·å°±è¢«å»ºè®®æ”¾å¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ‰€è°“çš„ Modern CMake æ–¹æ³•ã€‚è¿™ç§æ–¹æ³•ä¸­çš„å˜åŒ–åœ¨äºä¸ä½¿ç”¨è¯¸å¦‚ include_directoryï¼Œset(CXX_FLAGS ...) ä¹‹ç±»çš„æ—§å¼å·¥å…·ï¼Œæ”¹è€Œé‡‡ç”¨ target_compile_featruesï¼Œtarget_sourcesï¼Œtarget_include_directoriesï¼Œç­‰ç­‰æ–°å¼å·¥å…·ã€‚æ³¨æ„ target_link_libraries åŒæ—¶é€‚ç”¨äºä¸¤ç§æ–¹æ³•ã€‚

Modern CMake å½“ç„¶ä¸æ˜¯ä»…ä»…åŒ…å«ä¸Šè¿°å˜åŒ–ï¼Œå®é™…ä¸Šå…¶é‡ç‚¹åœ¨äºæ€è€ƒçš„è§†è§’å·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼šä»¥å‰çš„å·¥å…·è™½ç„¶ä¹Ÿæœ‰ targetï¼Œä½†å´é€šè¿‡å…¨å±€æ€§è´¨çš„ include_directories ç­‰ç­‰è®¾å®šæ¥ä½œç”¨äºæ¯ä¸€ä¸ª targetï¼Œå› è€Œä½ éœ€è¦å°å¿ƒæ§åˆ¶é¡ºåºï¼Œå¹¶é€šè¿‡æœ‰é™çš„å‡ ä¸ªå°å·¥å…·ï¼ˆä¾‹å¦‚ target_link_directoriesï¼Œtarget_properties ç­‰ç­‰ï¼‰è¿›è¡Œå¾®è°ƒï¼›ä½†æ–°ç‰ˆæœ¬ä¹‹åä½ ä¸åº”è¯¥éšæ—¶éšåœ°åœ°ä¿®æ”¹å…¨å±€æ€§çš„è®¾å®šï¼Œè€Œæ˜¯é¢å¯¹æ¯ä¸ª target è¿›è¡Œå…·ä½“è®¾ç½®ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒModern CMake æ›´å¼ºè°ƒæ¯ä¸€ä¸ª Target è‡ªèº«çš„é¢å‘å¯¹è±¡çš„æ€§è´¨ã€‚

æ­¤å¤–ï¼ŒModern CMake ä¹Ÿä¼šå°† Target ç»†åˆ†ä¸ºå‡ ç§ä¸åŒçš„å¯è§æ€§ï¼Œä¾‹å¦‚ PUBLICï¼ŒPRIVATE å’Œ INTERFACEã€‚å¯¹äºåº“ä½œè€…è€Œè¨€ï¼Œä½ çš„åº“æ‰€éœ€è¦çš„ä¾èµ–åº“é€šå¸¸åº”è¯¥è¢«æ ‡è®°ä¸º PRIVATEï¼Œä»è€Œä»¤ä½ çš„ä½¿ç”¨è€…ä¸å¿…å…³å¿ƒé—´æ¥çš„åº“å¼•ç”¨å…³ç³»ã€‚

æ‰€ä»¥æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼š

```cmake
cmake_minimum_required(VERSION 3.5)
project(MyLibrary VERSION 1.0.0 LANGUAGES CXX)

find_package(OpenCV REQUIRED)

# A Target:
add_library(MyLibrary)
target_compile_features(MyLibrary PRIVATE cxx_std_11)
target_sources(MyLibrary PRIVATE src/my_library.cpp)
target_include_directories(MyLibrary
        PUBLIC
            $<INSTALL_INTERFACE:include>
            $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        PRIVATE
            ${OpenCV_INCLUDE_DIRS}
        )
target_link_libraries(MyLibrary PRIVATE ${OpenCV_LIBRARIES})
```



#### è¿›ä¸€æ­¥çš„æ ¼å¼

åœ¨ Modern é£æ ¼ä¸­ï¼Œä¸ºäº†å…¼é¡¾å¤šç§ç›®çš„ï¼Œæˆ‘ä»¬æ¨èçš„æœ€ä½³æ ¼å¼æ˜¯å°†åº“æ”¾åœ¨ libs å­ç›®å½•ä¹‹ä¸‹ï¼Œä»è€Œå½¢æˆè¿™æ ·çš„æ–‡ä»¶å¤¹ç»“æ„ï¼š

![image-20201121165541697](https://i.loli.net/2020/11/21/6otwSMJn2eIDaRE.png)

> éœ€è¦æç¤ºçš„æ˜¯ï¼Œè¯·å‹¿ç€æ€¥ï¼Œè¿™ä»½ç›¸å…³çš„æºç æ˜¯å¼€æºçš„ï¼Œåªæ˜¯æˆ‘è¿˜å°šæœªæ•´ç†å®Œæˆï¼Œå› ä¸ºåç»­çš„ posts ä¹Ÿåœ¨è®¡åˆ’ä¹‹ä¸­ï¼Œå› æ­¤æœ¬ç³»åˆ—æ–‡å­—çš„åæœŸæ‰ä¼šä¸€å¹¶æ”¾å‡ºã€‚

è¿™ç§ç»“æ„ï¼Œå°†ä¼šä½¿å¾— sm-lib è¢«ä½ çš„ app-auto ç›´æ¥å¼•ç”¨çš„åŒæ—¶ï¼Œä¹Ÿèƒ½å…¼é¡¾åˆ°åˆ†å‘ sm-lib ä¹‹åä»–äººå¼•ç”¨ä¹‹ï¼Œå…·ä½“ç†ç”±åœ¨äºå…¶ `libs::sm-lib` å¼•ç”¨è¯­æ³•ä¸Šï¼Œæ— è®ºæ˜¯æœ¬åœ°è¿˜æ˜¯ä»–äººé€šè¿‡ `cmake --build build/ --target install` è‡ªè¡Œå®‰è£… sm-lib éƒ½èƒ½åŒæ ·åœ°é€šè¿‡è¯¥å¼•ç”¨è¯­æ³•é€æ˜åœ°å¯»æ‰¾åˆ°è¯¥åº“ã€‚

ä¸ºäº†è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬çš„ app-auto ä¼šåœ¨æˆ‘ä»¬çš„å¼€å‘è¿‡ç¨‹ä¸­è·Ÿéš sm-lib åŒæ­¥æ„å»ºå¹¶ç›´æ¥å¼•ç”¨åˆ° sm-libã€‚è€Œ app ä¸ä¼šå‚ä¸æˆ‘ä»¬å¼€å‘è¿‡ç¨‹ä¸­çš„æ„å»ºï¼Œè€Œæ˜¯åœ¨ sm-lib è¢«æ‰§è¡Œäº† --target install ä¹‹åå•ç‹¬åœ°è¿›è¡Œä¸€æ¬¡æ„å»ºï¼Œä»è€Œå¼•ç”¨åˆ°ä½ çš„ cmake å®‰è£…ç›®å½•ä¸­å·²è¢«æ³¨å†Œçš„ sm-libã€‚

è¿™ä¸€éƒ¨åˆ†çš„ç»†èŠ‚è¾ƒå¤šï¼Œå› è€Œè¯·ç›´æ¥å‚è€ƒæºç ã€‚

> æºç é‡Šå‡ºæ—¶ï¼Œæˆ‘å¯èƒ½ä¼šé‡å†™æœ¬ç¯‡ï¼Œå°†è¿™äº›ç»†èŠ‚ä¹Ÿä¸€ä¸€é˜è¿°ä¸€éï¼Œä¸è¿‡ä¹Ÿå¯èƒ½ä¸ï¼Œå› ä¸ºé‚£æ ·çš„ç»†èŠ‚æœ‰ç‚¹æ¯ç‡¥ï¼Œå¤ªè€ƒéªŒç¬”åŠ›äº†æœªå…ã€‚

> æˆ‘ç›®å‰è€ƒè™‘çš„æ˜¯æ˜¯å¦åº”è¯¥å°†è¿™ç»„æƒ¯ç”¨æ³•ç»„ç»‡ä¸ºä¸€ä¸ªå…¬å…±å‡½æ•°ï¼Œæˆ–è€…ä¸€ä¸ª cli å·¥å…·ï¼Œä»¥å¸®åŠ©ä½ å»ºç«‹è¿™æ ·çš„ä»£ç ç»“æ„ã€‚å› ä¸ºæ‰‹å·¥ç»„ç»‡å®ƒå®åœ¨æ˜¯å¤ªæ— è¶£äº†ã€‚



## æ„å»ºæ–¹æ³•

ç°åœ¨ï¼Œé’ˆå¯¹ä¸€ä¸ª Target æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥æ„å»ºï¼š

```bash
cd my-library
cmake -S . -B build/
cmake --build build/
```

å¦‚ä½ æ‰€è§ï¼Œæ–°çš„é£æ ¼ä¸å†æ˜¯ `mkdir build && cd build && cmake .. && make` äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ç›´æ¥åœ¨é¡¹ç›®ç›®å½•ä¸­å®Œæˆæ„å»ºï¼š

1. `cmake -S . -B build/` ä»æºä»£ç æ ¹ç›®å½•ï¼ˆ`-S .`ï¼‰å¤„ç† `CMakeLists.txt` æ–‡ä»¶å¹¶å°†æ„å»ºæ‰€éœ€çš„ä¸­é—´æ–‡ä»¶å†™å…¥æ„å»ºç›®å½•ï¼ˆ`-B build/`ï¼‰ä¸­ã€‚æ„å»ºç›®å½•å°†ä¼šè¢«è‡ªåŠ¨åˆ›å»ºï¼ˆä¹Ÿå¯èƒ½å¹¶ä¸ï¼‰ã€‚

   > éœ€è¦ cmake v3.13 ä»¥ä¸Šç‰ˆæœ¬ä»¥æ”¯æŒ `-S`
   >
   > å®ä¾‹ä¸­çš„ `-S .` å®é™…ä¸Šæ˜¯å¯ä»¥å¿½ç•¥çš„ã€‚

2. `cmake --build build/` å®Œæˆç›¸åº”çš„æ„å»ºï¼Œå…¶å†…å¹•ç­‰ä»·äº `cd build/ && make`ã€‚

   > See also: <https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#selecting-a-target>

å°½ç®¡æœ¬è´¨æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä½†ä½œä¸ºæ„å»ºè€…æ¥è¯´ï¼Œä¸å†éœ€è¦ cd build && cd .. è¿™æ ·çš„æ— æ„ä¹‰çš„ç›®å½•åˆ‡æ¢äº†ï¼Œæ„å»ºè€…å¯ä»¥ä»é¡¹ç›®æ ¹ç›®å½•å¼€å§‹å‘èµ·ä¸€åˆ‡åŠ¨ä½œã€‚

>**IMPORTANT**
>
>-B å¹¶ä¸ç­‰äº --buildã€‚-B æ˜¯åœ¨ç»™å®šçš„ binary dir ä¸­å†™å…¥ä¸­é—´æ–‡ä»¶ï¼Œ--build æ˜¯ä»ç»™å®šçš„ binary dir ä¸­æ‰§è¡Œæ„å»ºåŠ¨ä½œï¼ˆé€šè¿‡ make makefileï¼‰ã€‚
>
>ä¸è¦æ··æ·†ä¸¤æ¡å‘½ä»¤çš„ç”¨æ³•ï¼Œä¸¥æ ¼æŒ‰ç…§ç¤ºä¾‹çš„æ–¹å¼è¿›è¡Œé¥®ç”¨ã€‚



### `make install`

åœ¨é¡ºåˆ©å®Œæˆæ„å»ºä¹‹åï¼Œæˆ‘ä»¬å¾€å¾€éœ€è¦å°†æ„å»ºç»“æœï¼ˆé€šå¸¸æ˜¯åº“ï¼‰å®‰è£…åˆ°å·¥ä½œç³»ç»Ÿä¸­ï¼Œç„¶åä¾èµ–é¡¹ç›®æ‰èƒ½é¡ºåˆ©å¼•ç”¨å¯¹åº”çš„ä¾èµ–åº“å¹¶å®Œæˆé“¾æ¥ã€‚

åœ¨æ—§å¼ cmake ä¸­ï¼Œè¿™æ˜¯é€šè¿‡ `make install` æˆ–è€… `sudo make install` æ¥å®ç°çš„ã€‚

åœ¨ç°ä»£ cmake ä¸­ï¼Œç›¸åº”çš„å‘½ä»¤ä¸ºï¼š

```bash
cmake --build build/ --target install
# Or:
cmake --install build/ # CMake 3.15+ only
```

> See also: <https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#software-installation>

> å…³äºæ„å»ºç›®æ ‡ï¼ˆTargetï¼‰å¯ä»¥å‚è§ï¼š
>
> <https://cmake.org/cmake/help/latest/guide/user-interaction/index.html#selecting-a-target>

å¦‚æœä½ é‡‡ç”¨äº† generator expressionï¼Œé‚£ä¹ˆ cmake build å¯èƒ½ä¼šç”Ÿæˆå½¢å¦‚ install/fast ä¸€æ ·çš„ targetï¼Œæ‰€ä»¥è¿™æ—¶éœ€è¦ `cmake --build build/ --target install/fast` æ¥è°ƒç”¨é‚£æ ·çš„ç›®æ ‡ã€‚



### `make uninstall`

è¦æ³¨æ„çš„æ˜¯ï¼Œcmake å¹¶ä¸æä¾›ä¸€ä¸ªæ‰€è°“çš„ uninstall å‘½ä»¤æ¥å¸è½½é€šè¿‡ `make install` æ­¥éª¤å®‰è£…åˆ°ç³»ç»Ÿçš„æ–‡ä»¶ã€‚

ä½ ä¸å¾—ä¸è‡ªè¡ŒæŸ¥é˜… `build/install_manifest.txt` å¹¶æ‰‹åŠ¨åˆ é™¤é‚£äº›æ–‡ä»¶ã€‚

å¹¸è¿çš„æ˜¯ï¼Œè¿™å¹¶ä¸å¤æ‚ï¼š

```bash
$ xargs rm < build/install_manifest.txt
```

å¦‚æœ make install æ—¶ä½¿ç”¨äº† sudo æƒé™ï¼Œé‚£ä¹ˆå¸è½½æ—¶éœ€è¦ç¨å¾®æ³¨æ„ï¼š

```bash
$ cat build/install_manifest.txt | sudo xargs rm
$ cat build/install_manifest.txt | xargs -L1 dirname | sudo xargs rmdir -p
```



### é¿å… make install

é€šè¿‡åœ¨ app é¡¹ç›®ä¸­å®šä¹‰ ä¾èµ–åº“çš„æºç ä¸­ç›¸å…³è·¯å¾„çš„æ–¹å¼ï¼Œä½ å¯ä»¥ä¸å¿…åœ¨æ„å»º library æ—¶æ‰§è¡Œ `make install` çš„æ­¥éª¤ï¼Œè¿™åœ¨å¾ˆå¤šæƒ…å†µä¸‹æ˜¯å€¼å¾—æ¨èçš„ï¼Œå› å…¶é¿å…äº†ä¸´æ—¶æ€§çš„äºŒè¿›åˆ¶æ±¡æŸ“åˆ°å·¥ä½œä¸»æœºç³»ç»Ÿä¸­ã€‚

æˆ‘ä»¬ï¼ˆä½œä¸ºåº“ä½œè€…ï¼‰é€šå¸¸éƒ½è¦æ³¨æ„åœ¨å¼€å‘è¿‡ç¨‹ä¸­é¿å… make install å¸¦æ¥æŸäº›éš¾ä»¥é¢„æ–™çš„å‰¯ä½œç”¨ã€‚

ä½†è¿™å¹¶ä¸æ˜¯ç»å¯¹çš„ã€‚

å‡è®¾ä½ æ˜¯ä¸“èŒçš„åº“ä½œè€…ï¼Œé‚£ä¹ˆä½ çš„åº“çš„ä½¿ç”¨è€…ä»¬å°†ä¼šéœ€è¦ make install æˆ–è€… cmake --target install ç­‰æ–¹æ³•æ¥ä»æºç æ„å»ºä½ çš„åº“åˆ°ä»–ä»¬çš„å·¥ä½œç©ºé—´é‡Œã€‚

> æˆ‘ä»¬åœ¨å¼€æºç¤ºä¾‹ä¸­æä¾›äº† z11_m1/app å’Œ z11_m1/app_auto æ¥åˆ†åˆ«å±•ç¤ºåº“ä½œè€…æ€æ ·è‡ªè¡Œæ„å»ºå¹¶ä¾èµ–äºå…¶ libraryï¼ˆé€šè¿‡ app_autoï¼‰ï¼Œä»¥åŠåº“ä½¿ç”¨è€…å¦‚ä½•é€šè¿‡ cmake æ„å»ºå¹¶å®‰è£…çš„æ–¹å¼å»ä½¿ç”¨ libraryï¼ˆé€šè¿‡ appï¼‰ã€‚
>
> ä»¥åæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œä½¿ç”¨ cmake çš„**å¯ä¸‹è½½**çš„ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åŒ…å« github æˆ–å…¶å®ƒå¼€æºç«™ç‚¹çš„å…¬å¼€çš„ library å¹¶å®Œæˆè‡ªå·±çš„æ„å»ºï¼Œæ— éœ€æ‰‹å·¥æ‰§è¡Œ library çš„ `cmake --build build/ --target install`ã€‚



## è¾¨æ



### In-source Build vs Out-of-source Build

è¿™ä¸¤ä¸ªæœ¯è¯­å¯ä»¥å‚è€ƒä¸€ä¸‹  [directory structure - In-Source Build vs. Out-Of-Source Build - Software Engineering Stack Exchange](https://softwareengineering.stackexchange.com/questions/365460/in-source-build-vs-out-of-source-build) [^7] ä»¥åŠ  [IDisposable Thoughts - CMake and out-of-source build](https://cprieto.com/posts/2016/10/cmake-out-of-source-build.html) [^8]ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨ Source Tree ç›®å½•ç›´æ¥ä½¿ç”¨ `cmake && make` å°±æ˜¯æ‰€è°“çš„ In-source Build äº†ï¼Œæ­¤æ—¶ä¸­é—´ makefile è¾“å‡ºä»¥åŠæ„å»ºæ—¶çš„ .obj è¾“å‡ºéƒ½ä¼šæ··æ‚åœ¨æºä»£ç åŠå…¶ç›®å½•æ ‘ä¹‹ä¸­ï¼Œå°†ä¼šäº§ç”Ÿæ±¡æŸ“ï¼Œä¸”æœ‰è¯¯å†²ä¸è¦†ç›–æºä»£ç çš„æ½œåœ¨å±é™©ã€‚

Out-of-source Build é€šå¸¸ä»£è¡¨ç€åœ¨æ•´ä¸ªé¡¹ç›®å·¥ä½œåŒºçš„æ ¹ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª `build` ç›®å½•ï¼Œå¹¶åœ¨è¯¥å­ç›®å½•ä¸­è¿›è¡Œæ„å»ºã€‚è¿™ä»£è¡¨ä¸€ç§æ¨¡å¼ï¼Œä½†æ„å»ºç›®å½•åå´å¹¶éåªèƒ½é‡‡ç”¨ `build` è¿™ä¸ªå•è¯ï¼Œä½ ã€æˆ–è€… CIã€æˆ–è€… IDE å¯ä»¥ä½¿ç”¨è‡ªå·±çš„åå¥½åå­—ã€‚

è¿™å¾€å¾€æ˜¯é€šè¿‡å¦‚ä¸‹åºåˆ—æå®šçš„ï¼š

```bash
cd my-library
mkdir build && cd build
cmake ..
make
sudo make install
```

è€Œåœ¨æ–°ç‰ˆæœ¬ cmake ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ Modern CMake Style é£æ ¼çš„å‘½ä»¤æ¥å®Œæˆï¼š

```bash
cd my-library
cmake -S . --build build/
cmake --build build/
cmake --build build/ --target install
```



In-source build é€šå¸¸æ˜¯ä¸è¢«å…è®¸çš„ã€‚å®ƒå¾€å¾€å¼•èµ·æ½œåœ¨é—®é¢˜ä¸”æ±¡æŸ“ Source Tree ä¹‹ä¸­çš„å†…å®¹ã€‚è€Œæ–°ç‰ˆ cmake è¦æ±‚ä½ **å¿…é¡»**åœ¨ä¸€ä¸ªä¸ source tree åˆ†ç¦»çš„å•ç‹¬çš„æ„å»ºç›®å½•ä¸­è¿›è¡Œæ„å»ºï¼Œå‚è€ƒ out-of-source build ä»¥åŠ build ç›®å½•ã€‚

> **IMPORTANT**
>
> cmake ä¼šè¾“å‡º `CMakeCache.txt` ä½œä¸ºä¸­é—´æ–‡ä»¶ä¹‹ä¸€ï¼ˆæ­¤å¤–ä¸€ä¸ª makefile ä¹Ÿä¼šæ˜¯å¿…ç„¶çš„è¾“å‡ºä¹‹ä¸€ï¼‰ã€‚éœ€è¦å°å¿ƒçš„æ˜¯å¦‚æœ Source Tree çš„æ ¹ç›®å½•ä¸­åŒ…å«ä¸€ä¸ª `CMakeCache.txt` æ–‡ä»¶çš„è¯ï¼ˆæ— è®ºæ˜¯ä¸æ˜¯ä½ æ›¾ç»è¯¯ç”¨è¿‡ In-source Build æŒ‡ä»¤ï¼‰ï¼Œåˆ™ cmake å°†ä¼šæ€»æ˜¯è¿›å…¥ In-source Build æ¨¡å¼ï¼Œå“ªæ€•ä½ æ­£åœ¨é‡‡ç”¨ `mkdir build && cd build && cmake ..` è¿™æ ·çš„åºåˆ—å°è¯• OUt-of-source Buildã€‚



### Build Requirements vs Usage Requirements

å¯ä»¥å‚è€ƒ cmake å®˜æ–¹æ–‡æ¡£ä¹‹  [cmake-buildsystem(7) â€” CMake 3.19.0 Documentation](https://cmake.org/cmake/help/latest/manual/cmake-buildsystem.7.html#build-specification-and-usage-requirements) ã€‚ æ­¤å¤– [Itâ€™s Time To Do CMake Right - Pablo Arias](https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/#build-requirements-vs-usage-requirements) ä¸­æœ‰ç›¸åº”çš„é˜è¿°ã€‚

ç»¼åˆå®ƒä»¬çš„è¯´æ˜æ¥çœ‹ï¼Œæ‰€è°“ Usage Requirementsï¼ŒåŸºæœ¬ä¸Šç‰¹æŒ‡ INTERFACE ç±»å‹çš„ Targetï¼Œè¿™æ˜¯ cmake 3 ä»¥åçš„ä¸€ç§æ–°çš„ Target ç±»å‹ï¼Œä½ å¯ä»¥ç®€å•åœ°å°†å…¶ç†è§£ä¸º headers-only çš„åº“ï¼Œå³åªæœ‰å¤´æ–‡ä»¶çš„åº“ï¼Œä½¿ç”¨è€…å®é™…ä¸Šåªéœ€è¦ç¼–è¯‘æ—¶åŒ…å«ä¹‹ï¼Œè€Œæ— éœ€é“¾æ¥æ—¶å¯»æ‰¾å…¶ .a å¹¶é“¾å…¥å…¶äºŒè¿›åˆ¶æœºå™¨ç ã€‚

è€Œ Build Requirementsï¼ˆå®˜æ–¹æ–‡æ¡£ä»…ä½¿ç”¨äº† Build Specification ä¸€è¯ï¼‰ï¼ŒåŸºæœ¬ä¸Šç‰¹æŒ‡ PRIVATE ç±»å‹çš„ Targetï¼Œè¿™å…¶å®ä¹Ÿæ˜¯ cmake 3 ä»¥åçš„ä¸€ç§æ–°çš„ Target ç±»å‹ï¼ˆå›  cmake 2.8 ç­‰æ—©æœŸç‰ˆæœ¬ä¸­ Target æ— æ‰€è°“ç±»å‹ï¼Œå€’æ˜¯ DYNAMIC å’Œ STATIC å¯ä»¥å‹‰å¼ºè¢«è§†ä½œæ˜¯ library Target çš„ç±»å‹ï¼‰ï¼Œè€Œ PRIVATE Target è¡¨ç¤ºä¸€ä¸ª åŠ¨æ€åº“æˆ–é™æ€åº“ç›®æ ‡ Aï¼Œå®ƒå¦‚æœæœ‰è¿›ä¸€æ­¥æ‰€ä¾èµ–çš„å…¶å®ƒåº“ï¼Œåˆ™è¿™äº›åº“å¯¹äº A çš„ä½¿ç”¨è€…æ¥è¯´å…¶å®æ˜¯ä¸å¯è§çš„ï¼Œä½¿ç”¨è€…ä¹Ÿæ— éœ€å…³å¿ƒ A æ‰€ä¾èµ–çš„å…¶å®ƒåº“åº”è¯¥è¢«å¦‚ä½•æ‰¾åˆ°ï¼ˆç›¸åº”çš„ä¾èµ–å…³ç³»åœ¨ä½¿ç”¨è€…é€šè¿‡ `cmake --target install` å®‰è£… A æ—¶å·²ç»è¢«é€æ˜åœ°è§£å†³äº†ï¼‰ã€‚

- Build-Requirementsï¼š åŒ…å«äº†æ‰€æœ‰**æ„å»ºTarget**å¿…é¡»çš„ææ–™ã€‚å¦‚æºä»£ç ï¼Œincludeè·¯å¾„ï¼Œé¢„ç¼–è¯‘å‘½ä»¤ï¼Œé“¾æ¥ä¾èµ–ï¼Œç¼–è¯‘/é“¾æ¥é€‰é¡¹ï¼Œç¼–è¯‘/é“¾æ¥ç‰¹æ€§ç­‰ã€‚
- Usage-Requirementsï¼šåŒ…å«äº†æ‰€æœ‰**ä½¿ç”¨Target**å¿…é¡»çš„ææ–™ã€‚å¦‚æºä»£ç ï¼Œincludeè·¯å¾„ï¼Œé¢„ç¼–è¯‘å‘½ä»¤ï¼Œé“¾æ¥ä¾èµ–ï¼Œç¼–è¯‘/é“¾æ¥é€‰é¡¹ï¼Œç¼–è¯‘/é“¾æ¥ç‰¹æ€§ç­‰ã€‚è¿™äº›å¾€å¾€æ˜¯å½“å¦ä¸€ä¸ªTargetéœ€è¦ä½¿ç”¨å½“å‰targetæ—¶ï¼Œå¿…é¡»åŒ…å«çš„ä¾èµ–ã€‚





[^1]: [Modern CMake - Henry Schreiner](https://cliutils.gitlab.io/modern-cmake/)
[^2]: [More Modern CMake - Deniz Bahadir - Meeting C++ 2018](https://www.youtube.com/watch?v=y7ndUhdQuU8) 
[^3]: [C ++ç°åœ¨2017å¹´ï¼šä¸¹å°¼å°”Â·è²è´¹å°”â€œæœ‰æ•ˆçš„CMakeâ€](https://www.youtube.com/watch?v=bsXLMQ6WgIk)
[^4]: [Effective Modern CMake ä¸­è¯‘](https://phenix3443.github.io/notebook/cmake/effective-modern-cmake.html)
[^5]:  [<<Modern CMake>> ç¿»è¯‘ 1. CMake ä»‹ç» - æ•°æ®ç®¡ç†ä¹å›­ - åšå®¢å›­](https://www.cnblogs.com/hejiang/p/11247618.html) 
[^6]: Modern CMake è¯‘æ–‡ï¼š[github](https://github.com/RaymondZuo301/ModernCMake-Chinese), [gitbook](https://xiazuomo.gitbook.io/modern-cmake-chinese/)
[^7]:  [directory structure - In-Source Build vs. Out-Of-Source Build - Software Engineering Stack Exchange](https://softwareengineering.stackexchange.com/questions/365460/in-source-build-vs-out-of-source-build) 
[^8]: [IDisposable Thoughts - CMake and out-of-source build](https://cprieto.com/posts/2016/10/cmake-out-of-source-build.html) 









ğŸ”š