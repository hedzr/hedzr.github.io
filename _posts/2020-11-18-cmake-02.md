---
layout: single
title: 'cmake 02 - å¼€å§‹åº“å’Œæ‰§è¡Œæ–‡ä»¶'
date: 2020-11-18 14:23:00 +0800
last_modified: 2020-11-18 14:23:00 +0800
Author: hedzr
tags: [c++, cmake-hello, cmake, build, getting started]
categories: cmake notes
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  CMake ç›¸å…³ï¼Œå»ºç«‹åº“å’Œæ‰§è¡Œæ–‡ä»¶...
---



> æŒ‰ï¼š
>
> è¿™ä¸ªç³»åˆ—ä¸ cmake æœ‰å…³çš„è®°å½•ä¹Ÿå¥½ï¼Œç¬”è®°ä¹Ÿå¥½ï¼Œæˆä¹¦ä¹Ÿå¥½ï¼Œç›®å‰æš‚ä¸”å½’å±åœ¨ [cmake-hello](/tags/#cmake-hello) æ ‡è®°ä¹‹ä¸‹ã€‚



## å»ºç«‹åº“æˆ–æ‰§è¡Œæ–‡ä»¶



### åº“å’Œ add_library

[`add_library`](https://cmake.org/cmake/help/v3.8/command/add_library.html) æŒ‡ä»¤èƒ½å¤Ÿå®šä¹‰ä¸€ä¸ªåº“ä½œä¸ºç›®æ ‡ï¼ˆTargetï¼‰ã€‚

```cmake
# Normal Libraries
add_library(<name> [STATIC | SHARED | MODULE]
            [EXCLUDE_FROM_ALL]
            source1 [source2 ...])
# Imported Libraries
add_library(<name> <SHARED|STATIC|MODULE|UNKNOWN> IMPORTED
            [GLOBAL])
# Object Libraries
add_library(<name> OBJECT <src>...)
# Alias Libraries
add_library(<name> ALIAS <target>)
# Interface Libraries
add_library(<name> INTERFACE [IMPORTED [GLOBAL]])
```

#### åº“

ä½ å¯ä»¥å»ºç«‹ C++ çš„åŠ¨æ€åº“ã€é™æ€åº“ç­‰ç­‰ã€‚åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸­é™æ€åº“å’ŒåŠ¨æ€åº“æœ‰ç»†å¾®çš„å·®åˆ«ï¼Œä½†æ€»çš„æ¥è¯´å®ƒä»¬éƒ½æ˜¯å¯ä»¥å¤ç”¨çš„äºŒè¿›åˆ¶ä»£ç æ¨¡å—ã€‚

`MODULE` æ˜¯ç‰¹æ®Šçš„æ¨¡ç»„ï¼Œåˆè¢«ç§°ä½œ DSO ç»„ï¼Œè¿™ç§åº“æ— æ³•åƒåŠ¨æ€åº“ã€é™æ€åº“ä¸€æ ·è¢«é“¾æ¥åˆ°å…¶å®ƒç›®æ ‡ä¸­ï¼Œä½†å¯ä»¥è¢«åŠ¨æ€è£…è½½åˆ°æŸå¯æ‰§è¡Œæ–‡ä»¶çš„è¿è¡Œå®ä¾‹ä¸­ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ç§è¿è¡Œæ—¶æ’ä»¶ç‰¹æœ‰çš„å½¢æ€ï¼Œå…³äºè¿™æ–¹é¢éœ€è¦è¿›ä¸€æ­¥å‚é˜…å…¶å®ƒ DSO æœ‰å…³èµ„æ–™ã€‚

åŠ¨æ€åº“ï¼Œé™æ€åº“ï¼ŒMODULE éƒ½æ˜¯å¸¸è§„ç±»å‹çš„åº“ã€‚



#### Imported Libraries & `add-library`

https://cmake.org/cmake/help/v3.8/command/add_library.html#imported-libraries

```cmake
add_library(<name> <SHARED|STATIC|MODULE|UNKNOWN> IMPORTED
            [GLOBAL])
```

ä¸€ä¸ª [IMPORTED library ç›®æ ‡](https://cmake.org/cmake/help/v3.8/manual/cmake-buildsystem.7.html#imported-targets) ï¼ˆImported library targetï¼‰èƒ½å¤Ÿå¯¹é¡¹ç›®ä¹‹å¤–çš„åº“æ–‡ä»¶è¿›è¡Œå‚è€ƒå’Œå¼•ç”¨ï¼Œä¸”åœ¨æœ¬é¡¹ç›®æ„å»ºæ—¶æ— éœ€å¯¹è¯¥å¤–éƒ¨å¼•ç”¨åº“æ‰§è¡Œä»»ä½•æ„å»ºåŠ¨ä½œã€‚å¯¹äºå¤–éƒ¨å¼•ç”¨åº“æ¥è¯´ï¼Œ [`IMPORTED`](https://cmake.org/cmake/help/v3.8/prop_tgt/IMPORTED.html#prop_tgt:IMPORTED) ç›®æ ‡å±æ€§ä¸º `True`ã€‚ The target name has scope in the directory in which it is created and below, but the `GLOBAL` option extends visibility. It may be referenced like any target built within the project. `IMPORTED` libraries are useful for convenient reference from commands like [`target_link_libraries()`](https://cmake.org/cmake/help/v3.8/command/target_link_libraries.html#command:target_link_libraries). Details about the imported library are specified by setting properties whose names begin in `IMPORTED_` and `INTERFACE_`. The most important such property is [`IMPORTED_LOCATION`](https://cmake.org/cmake/help/v3.8/prop_tgt/IMPORTED_LOCATION.html#prop_tgt:IMPORTED_LOCATION) (and its per-configuration variant [`IMPORTED_LOCATION_`](https://cmake.org/cmake/help/v3.8/prop_tgt/IMPORTED_LOCATION_CONFIG.html#prop_tgt:IMPORTED_LOCATION_)) which specifies the location of the main library file on disk. See documentation of the `IMPORTED_*` and `INTERFACE_*` properties for more information.









### Add Static Library

ä¸‹é¢çš„ä¾‹å­å‡ºè‡ª z02-library-1ï¼Œå®šä¹‰äº†ä¸€ä¸ªåä¸º muchs çš„é™æ€åº“ï¼Œç„¶åå®šä¹‰äº†ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡ï¼Œåä¸º library-1-test-programï¼Œå¹¶ä¸”å°† muchs é“¾å…¥å…¶ä¸­ï¼š

```cmake
# The muchs library
# set (header_files ${CMAKE_CURRENT_SOURCE_DIR}/include/muchs/muchs.hh)
FILE(GLOB_RECURSE header_files ${CMAKE_CURRENT_SOURCE_DIR}/include/*.hh)
LIST(APPEND source_files library.cc)

# library
add_library(muchs STATIC ${source_files} ${header_files})
target_include_directories(muchs PUBLIC ${CMAKE_CURRENT_SOURCE_DIR})

# The main program

# The sources shared between the main program and the tests
set(PROJECT_SOURCES main.cc)

add_executable(library-1-test-program ${PROJECT_SOURCES})
target_link_libraries(library-1-test-program PRIVATE muchs)
```

åœ¨ linux ä¸­ï¼Œmuchs é™æ€åº“çš„è¾“å‡ºæ–‡ä»¶åä¸º libmuchs.aï¼Œå¦‚æœæ˜¯åŠ¨æ€åº“ï¼Œåˆ™åä¸º libmuchs.soã€‚

[`target_include_directories`](https://cmake.org/cmake/help/v3.8/command/target_include_directories.html)  æŒ‡ä»¤ä¸º muchs æŒ‡æ˜äº†åŒ…å«æ–‡ä»¶çš„æœç´¢è·¯å¾„ã€‚è¿™ä¸æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨å…¨å±€çš„ [`include_directories`](https://cmake.org/cmake/help/v3.8/command/include_directories.html) æŒ‡ä»¤æ¥æŒ‡æ˜å¤´æ–‡ä»¶æœç´¢è·¯å¾„ã€‚

[`target_link_libraries`](https://cmake.org/cmake/help/v3.8/command/target_link_libraries.html) æŒ‡ä»¤ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡æŒ‡æ˜äº†è¦é“¾æ¥çš„åŠ¨æ€åº“æˆ–è€…é™æ€åº“ã€‚`PRIVATE` æ˜¯æŒ‡ä¸å…³å¿ƒè¦é“¾å…¥çš„åº“çš„ä¾èµ–åº“ã€‚ä¹Ÿå¯ä»¥æŒ‡å®šä¸º `INTERFACE` æˆ– `PUBLIC`ï¼Œå…¶ä¸­ `PUBLIC` å¯ä»¥é€‚åº”å¤§å¤šæ•°ä¾èµ–åœºæ™¯ï¼Œè€Œ `PRIVATE` å¯¹ä¾èµ–å…³ç³»åˆ‡æ–­çš„æœ€ä¸¥å‰ã€‚è€Œ `INTERFACE` è¡¨æ˜ä»…ä»…å…³å¿ƒåº“åŠå…¶ä¾èµ–åº“çš„å¤´æ–‡ä»¶ï¼Œå¿½ç•¥ .a æˆ– .soï¼ˆå³ä½¿æœ‰ä¹Ÿå¿½ç•¥ï¼‰ï¼Œé€‚ç”¨äºä»…æœ‰å¤´æ–‡ä»¶çš„åº“ï¼Œåç»­çš„å°èŠ‚ä¼šä¸“é—¨ä»‹ç»ã€‚

`PUBLIC`, `PRIVATE` å’Œ `INTERFACE` çš„æ›´ç²¾ç¡®çš„ä»‹ç»åç»­å°†åœ¨ä¸“é—¨çš„å°èŠ‚ä¸­äºˆä»¥è¯´æ˜ã€‚





### Add Shared Library

æ·»åŠ ä¸€ä¸ªåŠ¨æ€åº“çš„ç›®æ ‡ï¼ˆTargetï¼‰å’Œé™æ€åº“ç›®æ ‡æ²¡æœ‰ä»€ä¹ˆä¸åŒï¼Œä»…ä»…æ˜¯å°† `STATIC` æ”¹ä¸º `SHARED`ï¼š

```cmake
# add_library(muchs STATIC ${source_files} ${header_files})
add_library(muchs SHARED ${source_files} ${header_files})
```

æˆ‘ä»¬ä¹Ÿæœ‰ä¸€ä¸ªå®Œæ•´ç‹¬ç«‹çš„ç¤ºä¾‹ z03-library-2ã€‚





### Add a header only library

å¯¹äºC++é¡¹ç›®æ¥è¯´ï¼Œä¸€ç§å¯èƒ½æ˜¯åˆ¶ä½œä¸€ä¸ªä»…æœ‰å¤´æ–‡ä»¶ï¼ˆæ²¡æœ‰é“¾æ¥æ—¶çš„ .a æˆ– .so æ–‡ä»¶ï¼‰çš„åº“ã€‚é€šå¸¸å½“ä½ å¼€å‘äº†ä¸€ä¸ªæ¨¡ç‰ˆåº“ï¼ˆC++ Templateï¼‰çš„æ—¶å€™ï¼Œä½ éœ€è¦å»ºç«‹è¿™æ ·ä¸€ä¸ªä»…å¤´æ–‡ä»¶çš„åº“ä½œä¸ºç›®æ ‡ï¼ˆTargetï¼‰ã€‚

ä¸‹é¢æ˜¯è¿™æ ·çš„ä¸€ä¸ª Library é¡¹ç›®çš„ `CMakeLists.txt`ï¼š

```cmake
SET(header_files ${CMAKE_CURRENT_SOURCE_DIR}/include/monid/monid.hh)

# Header only library, therefore INTERFACE
add_library(monid INTERFACE)
# INTERFACE targets only have INTERFACE properties
target_include_directories(monid INTERFACE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
        ${header_files}
        )
target_compile_features(monid INTERFACE cxx_std_11)


# The main program ---------------

# The sources shared between the main program and the tests
set(PROJECT_SOURCES main.cc)

add_executable(library-3-test-program ${PROJECT_SOURCES})
target_link_libraries(library-3-test-program PRIVATE monid)
```

è¿™ä¸ªç‰‡æ®µå–è‡ªäº z04-header-libraryï¼Œå¹¶ç•¥å¾®æœ‰æ‰€ä¿®æ”¹ä»¥ä¾¿æ›´æ˜æ™°ã€‚

[`target_compile_features`](https://cmake.org/cmake/help/v3.8/command/target_compile_features.html)  æŒ‡ä»¤çš„ç”¨é€”åœ¨äºä¸ºåº“æˆ–å¯æ‰§è¡Œæ–‡ä»¶æŒ‡æ˜ç¼–è¯‘å™¨å¿…é¡»å…·å¤‡çš„ç‰¹æ€§çº¦æŸã€‚å¦‚æœæŒ‡å®šçš„ç‰¹æ€§åœ¨ [`CMAKE_C_COMPILE_FEATURES`](https://cmake.org/cmake/help/v3.8/variable/CMAKE_C_COMPILE_FEATURES.html#variable:CMAKE_C_COMPILE_FEATURES) æˆ– [`CMAKE_CXX_COMPILE_FEATURES`](https://cmake.org/cmake/help/v3.8/variable/CMAKE_CXX_COMPILE_FEATURES.html#variable:CMAKE_CXX_COMPILE_FEATURES) ä¸­æ²¡æœ‰è¢«å®šä¹‰å’Œè¯·æ±‚çš„è¯ï¼ŒCMakeå°†ä¼šæŠ¥å‘Šä¸€ä¸ªé”™è¯¯ã€‚é€šå¸¸å¯¹äºåº“æ¥è¯´ï¼Œè¿™æ ·çš„æŒ‡å®šå¯ä»¥è¢«å»¶ä¼¸åˆ°å¼•å…¥è¯¥åº“çš„æ–°Targetï¼Œä»è€Œè§£å†³ç‰¹å®šçš„ç¼–è¯‘å™¨ç‰¹å¾çš„å»¶ç»­æ€§é—®é¢˜ï¼Œä¾‹å¦‚ç¼–è¯‘å™¨è¢«çº¦æŸä¸ºæ”¯æŒC++11æ ‡å‡†ï¼š

```cmake
target_compile_features(monid INTERFACE cxx_std_11)
```

å…³äº CXX å·²çŸ¥çš„ç‰¹æ€§ï¼Œå¯ä»¥æŸ¥é˜…ï¼š[CMAKE_CXX_KNOWN_FEATURES](https://cmake.org/cmake/help/v3.8/prop_gbl/CMAKE_CXX_KNOWN_FEATURES.html#prop_gbl:CMAKE_CXX_KNOWN_FEATURES)ã€‚å½“æŸä¸ªç‰¹æ€§è¢«è¯·æ±‚ï¼Œé‚£ä¹ˆç›¸å…³çš„ç¼–è¯‘å™¨å‘½ä»¤è¡Œé€‰é¡¹å°†è¢«è‡ªåŠ¨è¿½åŠ åˆ° CMAKE_C_FLAGS æˆ– CMAKE_CXX_FLAGS ä¹‹ä¸­ï¼Œä¾‹å¦‚å¯¹äº gcc çš„ `-std=gnu++11`ã€‚





















ğŸ”š