---
layout: single
title: 'cmake 04 - Basics - Part I'
date: 2020-11-23 10:23:00 +0800
last_modified_at: 2020-11-25 08:17:00 +0800
Author: hedzr
tags: [c++, cmake-hello, cmake, build, basics]
categories: cmake notes
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  CMake ç›¸å…³ï¼ŒBasics Part Iï¼šåŸºæœ¬è¯­æ³•ç»“æ„ã€æµç¨‹æ§åˆ¶...
---



> æŒ‰ï¼š
>
> è¿™ä¸ªç³»åˆ—ä¸ cmake æœ‰å…³çš„è®°å½•ä¹Ÿå¥½ï¼Œç¬”è®°ä¹Ÿå¥½ï¼Œæˆä¹¦ä¹Ÿå¥½ï¼Œç›®å‰æš‚ä¸”å½’å±åœ¨ [cmake-hello](/tags/#cmake-hello) æ ‡è®°ä¹‹ä¸‹ã€‚
>
> æºç è¯·è®¿é—®ï¼š
>
> > <https://github.com/hedzr/study-cmake>  
> > è¯·æ³¨æ„æºç ä»åœ¨è·Ÿéšæˆ‘çš„ç¬”è®°å†…å®¹çš„è¿­ä»£è€Œæ›´æ–°ä¸­ã€‚



> **æŒ‰**ï¼š
>
> å½“å‰å…ˆæœŸå‡†å¤‡ç½—åˆ—å†…å®¹ï¼Œä½†ä»Šåå¯èƒ½ä¼šè¿›ä¸€æ­¥å¡«å……ä»¥ä¾¿ä»¤å…¶ä¸è‡³äºä»…ä»…æˆä¸ºä¸€ä¸ªå®˜æ–¹æ–‡æ¡£çš„è¯‘æœ¬ã€‚  
>
> ---
>
> æ­¤åå„ç« èŠ‚å†…å®¹å¹¶ä¸æ˜¯æŒ‰ç…§ä¸€æœ¬å‚è€ƒæ‰‹å†Œçš„å½¢å¼æ¥ç¼–å†™çš„ï¼Œè€Œæ˜¯åŸºäºä¸€ä¸ªæ¨¡æ¿å‹é¡¹ç›®è¿›è¡Œä»‹ç»ï¼Œä½†å°½åŠ›åšåˆ°æ¶µç›–é¢è¶…è¿‡ 50% è€Œä¸æ˜¯åƒä¸€èˆ¬çš„å…¥é—¨é¡µé¢é‚£æ ·æœ€å¤šæ¶‰åŠåˆ° 10% çš„å†…å®¹ã€‚  
>
> å¦‚æœä½ æƒ³è¦é˜…è¯»å–œé—»ä¹è§çš„å…¥é—¨é¡µé¢ä»¥æ±‚å¿«é€Ÿå¼€å§‹çš„è¯ï¼Œå¯ä»¥é˜…è¯»æ­¤å‰çš„å‡ ä¸ªç« èŠ‚ï¼Œé‚£é‡Œæ˜¯æŒ‰ç…§ Getting Started çš„é£æ ¼ç¼–å†™çš„ã€‚

---

è¿™é‡Œæ˜¯åŸºæœ¬è¯­æ³•ç¬¬ä¸€éƒ¨åˆ†ï¼ŒåŒ…æ‹¬åŸºæœ¬è¯­æ³•ç»“æ„ï¼Œæµç¨‹æ§åˆ¶ç­‰å†…å®¹ã€‚



## ä½¿ç”¨

cmake é»˜è®¤è½½å…¥å½“å‰ç›®å½•ä¸­çš„ `CMakeLists.txt` å¹¶å±•å¼€è„šæœ¬è§£é‡Šï¼š

```bash
$ cmake
```

æ­¤æ—¶æ­¤å‘½ä»¤ç­‰åŒäº `cmake .`ã€‚

ä½ å¯ä»¥å»ºç«‹ build å­ç›®å½•æ¥å¼€å§‹ä¸€ä¸ª Out-of-source Buildï¼š

```bash
mkdir build
cd build
cmake ..
```

æ­¤å¤–ï¼Œä½ å¯ä»¥ç›´æ¥æ‰§è¡Œä¸€ä¸ªè„šæœ¬æ–‡ä»¶ï¼š

```bash
cmake -P inc-version.cmake
```

è¿™æ—¶ cmake å·¥ä½œå¾—å¦‚åŒå¸¸è§çš„è„šæœ¬è§£é‡Šå™¨ã€‚

---

éšåçš„ç« èŠ‚å°†ä¼šé’ˆå¯¹ cmake è„šæœ¬çš„è¯­æ³•è¿›è¡Œä»‹ç»ã€‚





## åŸºæœ¬è¯­æ³•



cmake è„šæœ¬ç”±ä¸€ç³»åˆ—æŒ‡ä»¤æ„æˆï¼Œæ‰€ä»¥ä»æ–‡æ³•ä¸Šçœ‹ï¼Œcmake æ˜¯æ³¨é‡Šã€ç©ºç™½ã€æŒ‡ä»¤çš„é›†åˆã€‚



### æ³¨é‡Š

æ³¨é‡Šä»¥ '#' å¼€å¤´ï¼Œä»…æ”¯æŒè¡Œæ³¨é‡Šï¼Œç±»ä¼¼äº shellã€‚



### ç©ºç™½

cmake è„šæœ¬ä¸­çš„ ç©ºç™½ï¼Œæ¢è¡Œï¼Œtab å…¨è¢«å¿½ç•¥ã€‚

ç”±äºæ¯æ¡æŒ‡ä»¤æ€»æ˜¯ä»¥å³æ‹¬å·ç»“å°¾ï¼Œæ‰€ä»¥ cmake ä¸éœ€è¦ ';' è¿™æ ·çš„å¥æœ«æ ‡è¯†ç¬¦ï¼ŒåŒæ—¶è¿™ä¹Ÿæ„å‘³ç€ cmake çš„è¯æ³•åˆ†æå™¨å¯ä»¥å°†ä¸€åˆ‡ç©ºç™½å…¨æ•°æŠ¹é™¤ï¼Œè€Œè¯­ä¹‰åˆ†æä¾ç„¶ä¸å—å½±å“ã€‚

> æœ‰çš„é«˜çº§è¯­è¨€åœ¨è¢«ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨å¿…é¡»å°†æ‰€æœ‰ç©ºç™½å‹ç¼©ä¸ºä¸€ä¸ªå•ç‹¬çš„è¯æ³•å•ä½ï¼Œæ­¤æ—¶ç©ºç™½è¢«å½“ä½œæœ‰æ„ä¹‰çš„åˆ†éš”ç¬¦ã€‚æœ‰çš„è¯­è¨€åˆ™æœ‰èµ–äºæ¢è¡Œå­—ç¬¦ä½œä¸ºè¯­ä¹‰åˆ†æçš„åˆ†ç•Œçº¿ã€‚

### æŒ‡ä»¤

éæ³¨é‡Šçš„éç©ºè¡Œï¼Œä¸€å¾‹è¢«è§†ä½œæŒ‡ä»¤ã€‚

è¡Œæœ«å¦‚æœæœ‰æ³¨é‡Šï¼Œæ³¨é‡Šè¢«å®Œå…¨å¿½ç•¥ã€‚

æŒ‡ä»¤éƒ½æ˜¯ç”±æŒ‡ä»¤ååŠå…¶å‚æ•°æ„æˆï¼Œæ ¼å¼å½¢å¦‚ï¼š

```cmake
directive ( [param1 [param2 ...]] )
```

å…¶ä¸­ï¼Œå‚æ•°å¯ä»¥ä¸ºç©ºã€‚è€Œä¸”æ‹¬å·ä¹‹é—´çš„å†…å®¹å…è®¸è¢«åˆ†åˆ—äºå¤šè¡Œä¸­ã€‚å¦‚æœæœªèƒ½è¯†åˆ«åˆ°ç»“æŸæ—¶çš„å³æ‹¬å·ï¼Œcmake ä¼šæŒç»­åœ°å°†åç»§è¡Œå½“ä½œæ—¶æŒ‡ä»¤å‚æ•°çš„ä¸€éƒ¨åˆ†è¿›è¡Œåˆ†æã€‚ä¾‹å¦‚ä¸€ä¸ªå®ä¾‹ï¼š

```cmake
set(A v1
   v2
   v3 # v3 is another one
   )
```

è¿™ä¸€å®ä¾‹çš„å«ä¹‰ä¸ºå»ºç«‹å’Œè®¾ç½®ä¸€ä¸ªå˜é‡ 'A' å…¶å€¼è¢«è®¾å®šä¸º â€œv1 v2 v3â€ åºåˆ—ã€‚â€˜A' æ˜¯å˜é‡åã€‚

> è¡Œæœ«çš„æ³¨é‡Šä¸ä¼šå½±å“è¯­ä¹‰ã€‚

> å…³äºå˜é‡çš„ç»†èŠ‚åç»­ç« èŠ‚ä¼šè¿›ä¸€æ­¥é˜è¿°ã€‚

å¯¹äºæŒ‡ä»¤æ¥è¯´ï¼Œåªæœ‰å‚æ•°åˆ—è¡¨çš„å­˜åœ¨ã€‚

ä½†å¯¹äºç‰¹å®šæŒ‡ä»¤æ¥è¯´ï¼Œåƒå˜é‡åã€å˜é‡å€¼è¿™æ ·çš„è¯­æ³•å•ä½è¿˜æ˜¯å­˜åœ¨çš„ï¼Œå°½ç®¡ä»å…·ä½“æŒ‡ä»¤çš„è§’åº¦çœ‹å®ƒä»¬ä»ç„¶æ˜¯æŒ‡ä»¤çš„å‚æ•°è¡¨ã€‚

æŒ‡ä»¤å°šå¯è¢«æŒ‰ç…§åŠŸç”¨ç»†åˆ†ä¸ºå‡½æ•°ã€å®ã€å‘½ä»¤ç­‰å„ç§ç»†ç±»ã€‚ä½†è¿™åªæ˜¯æœ‰åŠ©äºä½ çš„ç†è§£ï¼Œè€Œ cmake è‡ªèº«åˆ™æ˜¯ä¸€å¾‹è§†ä½œä¸ºæŒ‡ä»¤ã€‚



#### æŒ‡ä»¤åä¸å˜é‡å

cmake è„šæœ¬ä¸­çš„æŒ‡ä»¤åï¼ˆå‘½ä»¤åï¼Œfunction åï¼Œmacro åç­‰ï¼‰ï¼Œå…¶å¤§å°å†™å¹¶ä¸æ•æ„Ÿï¼Œæ‰€ä»¥ â€œSETâ€ å’Œ â€œsetâ€ ç”šè‡³ â€œSeTâ€ æ˜¯ç­‰ä»·çš„ã€‚

CMake æ¨å´‡ä½ æŒ‡ä»¤åä¸€å¾‹å°å†™ï¼Œå†…å»ºå˜é‡åä¸€å¾‹å¤§å†™ã€‚

è‡³äºç”±è„šæœ¬ç¼–å†™è€…å¦‚ä½ æ‰€å»ºç«‹çš„å˜é‡ååˆ™è§†ä¸ªäººåå¥½è€Œå®šã€‚

ä½œä¸ºä¸€ä¸ªå»ºè®®ï¼Œä½œä¸º cmake å·¥å…·è„šæœ¬åº“ä½œè€…çš„ä½ å˜é‡åé‡‡ç”¨å¤§å†™ï¼Œä½ å¯¹å†…å»ºå˜é‡ä½“ç³»çš„æ‰©å±•é‡‡ç”¨å¤§å†™ï¼Œä½ çš„å†…éƒ¨å˜é‡å°å†™å¹¶ä»¥ â€œ_â€ å¼€å¤´ã€‚

è€Œå¯¹äº cmake æœ€ç»ˆè¿ç”¨è€…æ¥è¯´ï¼Œåˆ™ä»»ç”±è‡ªå®šã€‚



> å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼

åˆæ³•çš„å˜é‡åç”±å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿æ„æˆã€‚äº‹å®ä¸Š â€œ-â€ ä¹Ÿæ˜¯åˆæ³•çš„ï¼Œä½†ä¸ºå…ä¹–ç¦»è¿˜æ˜¯ä¸å®œä½¿ç”¨ã€‚









## æµç¨‹æ§åˆ¶

### æ¡ä»¶

å®Œæ•´çš„æ¡ä»¶è¯­å¥ç”± [if](https://cmake.org/cmake/help/latest/command/if.html) ,  [elseif](https://cmake.org/cmake/help/latest/command/elseif.html) ,  [else](https://cmake.org/cmake/help/latest/command/else.html) ,  [endif](https://cmake.org/cmake/help/latest/command/endif.html)  æŒ‡ä»¤ç»„åˆæ„æˆï¼š

```cmake
if(condition)
  command_for_expr1_true(...)
elseif(condition)
  command_for_expr2_true(...)
else()
  command_for_all_false(...)
endif()
```

elseif å’Œ else æŒ‡ä»¤ä¸æ˜¯å¿…é¡»çš„æ„æˆï¼Œå¯ä»¥è¢«çœç¼ºã€‚

> å¤ä»£çš„ cmake è¦æ±‚ else() å’Œ endif() åº”è¯¥ä½¿ç”¨ if(condition) ä¸­çš„ condition ç‰‡æ®µï¼Œä¾‹å¦‚
>
> ```cmake
> if (EXISTS "${CMAKE_SOURCE_DIR}/.git")
> else (EXISTS "${CMAKE_SOURCE_DIR}/.git")
> endif (EXISTS "${CMAKE_SOURCE_DIR}/.git")
> ```
>
> è¿™å¾ˆè ¢è€Œä¸”å¾ˆæ··æ·†ï¼šæ‰€ä»¥ else(EXISTS "${CMAKE_SOURCE_DIR}/.git") åˆ°åº•æƒ³è¡¨è¾¾å“ªä¸€ä¸ªå«ä¹‰å‘¢ï¼Ÿ
>
> æ‰€ä»¥ç°åœ¨çš„ cmake ä¸å†æœ‰è¿™æ ·çš„è¦æ±‚äº†ã€‚
>
> ä¸è¿‡ä½ éœ€è¦çŸ¥é“ä¸Šè¿°ä¼ ç»Ÿï¼Œå› ä¸ºä½ ä»ç„¶ä¼šé‡åˆ°è¿™æ ·çš„å¤ä»£é£æ ¼çš„ if è¯­å¥ï¼Œè€Œä¸”ï¼Œå®ƒä»¬ç°åœ¨ä»ç„¶æ˜¯æ­£ç¡®çš„ã€‚

expr1 è¿™æ ·çš„æ¡ä»¶è¡¨è¾¾å¼å¯ä»¥ä½¿ç”¨è¿ç®—å­æ¥ç»„åˆï¼š

```cmake
if((expr1) AND (expr2 OR (expr3)))
```

åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ï¼Œä¸€ä¸ª token åå­—ä¼šè¢«è‡ªåŠ¨å°è¯•åšå˜é‡æ±‚å€¼ï¼Œæ‰€ä»¥ä½ æ²¡æœ‰å¿…è¦æ˜¾å¼ä½¿ç”¨ `${var}` è¡¨è¾¾å¼ï¼š

```cmake
set(DEBUG TRUE)

if(DEBUG)
  ...
endif()
if(${DEBUG})
  ...
endif()
```

æ­¤æ—¶ä¸¤æ¡ if è¯­å¥çš„æ•ˆæœæ˜¯ç›¸åŒçš„ã€‚



#### æ¡ä»¶è¡¨è¾¾å¼çš„æœ‰æ•ˆå½¢å¼

[if](https://cmake.org/cmake/help/latest/command/if.html) æ¡ä»¶è¡¨è¾¾å¼æœ‰å¤šç§å˜ä½“ï¼š

> ç”±äºå®ƒæ˜¯å¦‚æ­¤åœ°å¼±æ™ºï¼ˆæˆ–è€…è¯´ï¼Œuglyï¼Œæˆ–è€…è¯´ï¼Œç®€æ˜æ˜“æ‡‚æ˜“æ¨å€’ï¼‰ï¼Œå¦‚æœä½ ä¸èƒ½çœ‹åˆ°ä»¥ä¸‹å½¢å¼äº†è§£åˆ°å…¶ç›®çš„çš„è¯ï¼Œè¯·å‚è€ƒ cmake å®˜ç½‘æ–‡æ¡£è·å¾—è¯¦æƒ…ã€‚

```
if(<constant>)
if(<variable|string>)
if(NOT <condition>)
if(<cond1> AND <cond2>)
if(<cond1> OR <cond2>)
if(COMMAND command-name)
if(POLICY policy-id)
if(TARGET target-name)
if(TEST test-name)
if(EXISTS path-to-file-or-directory)
if(file1 IS_NEWER_THAN file2)
if(IS_DIRECTORY path-to-directory)
if(IS_SYMLINK file-name)
if(IS_ABSOLUTE path)
if(<variable|string> MATCHES regex)
if(<variable|string> LESS <variable|string>)
if(<variable|string> GREATER <variable|string>)
if(<variable|string> EQUAL <variable|string>)
if(<variable|string> LESS_EQUAL <variable|string>)
if(<variable|string> GREATER_EQUAL <variable|string>)
if(<variable|string> STRLESS <variable|string>)
if(<variable|string> STRGREATER <variable|string>)
if(<variable|string> STREQUAL <variable|string>)
if(<variable|string> STRLESS_EQUAL <variable|string>)
if(<variable|string> STRGREATER_EQUAL <variable|string>)
if(<variable|string> VERSION_LESS <variable|string>)
if(<variable|string> VERSION_GREATER <variable|string>)
if(<variable|string> VERSION_EQUAL <variable|string>)
if(<variable|string> VERSION_LESS_EQUAL <variable|string>)
if(<variable|string> VERSION_GREATER_EQUAL <variable|string>)
if(<variable|string> IN_LIST <variable>)
if(DEFINED <name>|CACHE{<name>}|ENV{<name>})
if((condition) AND (condition OR (condition)))
```

> åŸåˆ™ä¸Šè¯´ï¼Œè¿™äº›æ¡ä»¶è¡¨è¾¾å¼çš„å„ç±»å˜ä½“é€‚ç”¨äº ifï¼Œwhile ç­‰éœ€è¦æ¡ä»¶è¡¨è¾¾å¼çš„åœºæ™¯ã€‚

è¿™äº›å˜ä½“å®é™…ä¸Šä»£è¡¨ç€ä¸åŒç±»åˆ«çš„è¿ç®—ï¼Œä¸‹é¢ç®€è¦å½’ç±»ä¸ºï¼š



#### é€»è¾‘è¿ç®—

åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­çš„ä¸æˆ–éï¼š

```cmake
if(NOT condition)
if(condition1 AND condition2)
if(condition1 OR condition2)
if(condition1 OR (condition2 AND condition3))
```

è¿™æ ·çš„è¡¨è¾¾å¼è¿ç®—æ—¶åˆæ³•çš„ï¼š

```cmake
set(TTT 1)  # set to TRUE
set(SSS 0)  # set to FALSE
if (TTT AND NOT SSS)
  message(FATAL_ERROR "TTT AND NOT SSS")
endif ()
```

å®ƒå°†ä¼šè¾“å‡ºé”™è¯¯è¯Šæ–­æ¥è¡¨è¾¾åˆ†æ”¯å·²ç»è¢«åŒ¹é…ï¼š

```
CMake Error at cmake/diag-1.cmake:25 (message):
  TTT AND NOT SSS
Call Stack (most recent call first):
  CMakeLists.txt:1 (include)
```



#### æ¯”è¾ƒè¿ç®—

##### æ•°å€¼

```cmake
if(variable LESS number)
if(string LESS number)

if(variable GREATER number)
if(string GREATER number)

if(variable EQUAL number)
if(string EQUAL number)
```

##### å­—ç¬¦ä¸²

```cmake
if(string STRLESS string)

if(variable STRGREATER string)
if(string STRGREATER string)

if(variable STREQUAL string)
if(string STREQUAL string)
```

##### æ­£åˆ™å¼

```cmake
if(variable MATCHES regex)
if(string MATCHES regex)
```

##### æ–‡ä»¶æ¯”è¾ƒ

è¯·æ³¨æ„å¿…é¡»æä¾›å®Œæ•´è·¯å¾„åã€‚

```cmake
if(EXISTS file-name)
if(EXISTS directory-name)
```

å½“ file1 æ¯” file2 æ–°ï¼Œæˆ–è€…å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶ä¸å­˜åœ¨æ—¶ï¼š

```cmake
if(file1 IS_NEWER_THAN file2)
```


åˆ¤æ–­ç»™å®šçš„pathæ˜¯å¦æ˜¯ç»å¯¹è·¯å¾„ï¼š

```cmake
if(IS_ABSOLUTE path)
```

åˆ¤æ–­ç»™å®špathæ˜¯å¦ä¸ºæ–‡ä»¶å¤¹ï¼š

```cmake
if(IS_DIRECTORY path-to-directory)
```

åˆ¤æ–­ç»™å®šçš„pathæ˜¯å¦ç¬¦å·é“¾æ¥æ–‡ä»¶ï¼š

```cmake
if(IS_SYMLINK file-name)
```

##### ç‰ˆæœ¬æ¯”è¾ƒ

cmake è®¤ä¸ºç‰ˆæœ¬å·å…·æœ‰ `major[.minor[.patch[.tweak]]]` çš„æ ¼å¼ï¼Œè¿™æ˜¯ç­‰æ•ˆäº semver çš„ä¸€ç§æ ¼å¼ï¼Œä½†å¹¶ä¸æ”¯æŒ semver çš„å¤æ‚æ ¼å¼ã€‚

å°äº

```
if(<variable|string> VERSION_LESS <variable|string>)
```

å¤§äº

```
if(<variable|string> VERSION_GREATER <variable|string>)
```

ç­‰äº

```
if(<variable|string> VERSION_EQUAL <variable|string>)
```

å°äºç­‰äº

```
if(<variable|string> VERSION_LESS_EQUAL <variable|string>)
```

å¤§äºç­‰äº

```
if(<variable|string> VERSION_GREATER_EQUAL <variable|string>)
```



##### å…¶å®ƒ

åˆ¤æ–­ç»™å®šçš„ command-name æ˜¯å¦å±äºå‘½ä»¤ï¼ˆcommandï¼‰ã€functionã€macroï¼š

```cmake
if(COMMAND command-name)
```

åˆ¤æ–­ç»™å®šçš„ variable-name æ˜¯å¦å·²ç»è¢«å®šä¹‰è¿‡ï¼š

```cmake
if(DEFINED variable-name)
if(DEFINED <name>|CACHE{<name>}|ENV{<name>})
```



åˆ¤æ–­æŸä¸ª policy æ˜¯å¦å·²ç»è¢«å®šä¹‰ï¼ˆä¸ºNEWçŠ¶æ€ï¼‰

```cmake
if(POLICY policy-id)
```

True if the given name is an existing policy (of the form `CMP<NNNN>`).

å®ƒæ£€æµ‹æ˜¯å¦æ›¾ç»æœ‰ `cmake_policy(SET CMP0048 NEW)` è¿™æ ·çš„æŒ‡ä»¤æ›¾ç»è¢«æ‰§è¡Œè¿‡ã€‚



åˆ¤æ–­æŸä¸ªå­—ç¬¦ä¸²æ˜¯å¦åœ¨æŸä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ä¹‹ä¸­ï¼š

```
if(<variable|string> IN_LIST <variable>)
```



åˆ¤æ–­æŸä¸ªåå­—æ˜¯å¦æ›¾ç»è¢« [`add_executable()`](https://cmake.org/cmake/help/latest/command/add_executable.html#command:add_executable), [`add_library()`](https://cmake.org/cmake/help/latest/command/add_library.html#command:add_library), æˆ– [`add_custom_target()`](https://cmake.org/cmake/help/latest/command/add_custom_target.html#command:add_custom_target) è¿™æ ·çš„ Target å®šä¹‰è¯­å¥æ‰€å£°æ˜è¿‡ï¼š

```cmake
if(TARGET target-name)
```

åˆ¤æ–­ä¸€ä¸ªåå­—æ˜¯å¦æ›¾è¢« [`add_test()`](https://cmake.org/cmake/help/latest/command/add_test.html#command:add_test) æ‰€å£°æ˜è¿‡ï¼š

```cmake
if(TEST test-name)
```







### å¾ªç¯

CMake æœ‰ä¸¤ç§å¾ªç¯ï¼š

1. foreach..endforeach
2. while..endwhile

#### foreach

[foreach](https://cmake.org/cmake/help/latest/command/foreach.html) æŒ‡ä»¤å…·æœ‰å¦‚ä¸‹æ ¼å¼ï¼š

```cmake
foreach(<loop_var> <items>)
  <commands>
endforeach()
```

å¹¶ä¸”æ”¯æŒå¦‚ä¸‹çš„å˜ä½“ï¼š

```cmake
foreach(<loop_var> RANGE <stop>)
foreach(<loop_var> RANGE <start> <stop> [<step>])
foreach(<loop_var> IN [LISTS [<lists>]] [ITEMS [<items>]])
```

[foreach](https://cmake.org/cmake/help/latest/command/foreach.html) æŒ‡ä»¤æ‰€å¼•å¯¼çš„å¾ªç¯å¯ä»¥è¢«ç”¨äºéå†å­—ç¬¦ä¸²åˆ—è¡¨ï¼š

```cmake
set(V alpha beta gamma)
message(${V})

foreach(i ${V})
    message(${i})
endforeach()
```

å…¶ç»“æœç±»ä¼¼äºï¼š

```
alphabetagamma
alpha
beta
gamma
```



#### while

[while](https://cmake.org/cmake/help/latest/command/while.html) å¾ªç¯é‡‡ç”¨æ¡ä»¶è¡¨è¾¾å¼æ¥åˆ¤å®šå¾ªç¯æ˜¯å¦ç»“æŸï¼š

```cmake
while(<condition>)
  <commands>
endwhile()
```

åœ¨å¾ªç¯ä½“ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ [`break()`](https://cmake.org/cmake/help/latest/command/break.html#command:break) å’Œ [`continue()`](https://cmake.org/cmake/help/latest/command/continue.html#command:continue) æŒ‡ä»¤ï¼Œå«ä¹‰è‡ªç°ã€‚



### å‡½æ•°ä¸å®

å‡½æ•°å’Œå®è¢«ç”¨äºç»„å»ºä½ çš„å­ç¨‹åºã€‚å…¶ä¸­ function çš„å‡½æ•°ä½“ä¸­ set å»ºç«‹çš„æ˜¯ local å˜é‡ï¼Œè€Œ macro çš„ body ä¸­ set ä¼šå½±å“åˆ°å…¨å±€å˜é‡ã€‚

```cmake
# å®šç¾©åç‚º print1 çš„ macro 

macro(print1 MESSAGE)
    set(k ${MESSAGE})
    message(${MESSAGE})
endmacro(print1)

# å®šç¾©åç‚º print2 çš„ function
function(print2 MESSAGE)
    set(k ${MESSAGE})
    message(${MESSAGE})
endfunction(print2) 

print1("from print1")
print2("from print2")
message("k=${k}")

è¼¸å‡ºçµæœç‚º
from print1
from print2
k="from print1"
```

> ä¾‹å­å–è‡ª  [CMake å…¥é—¨/æµç¨‹æ§åˆ¶ - ç»´åŸºæ•™ç§‘ä¹¦ï¼Œè‡ªç”±çš„æ•™å­¦è¯»æœ¬](https://zh.m.wikibooks.org/wiki/CMake_%E5%85%A5%E9%96%80/%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6) 



#### debug_print_value ç­‰

æˆ‘ä»¬åœ¨ utils.cmake ä¸­æä¾›äº†ä¸€ç³»åˆ—çš„å‡½æ•°ä¸å®å·¥å…·ï¼Œå…¶ä¸­ debug_print_value çš„å®šä¹‰å¦‚åŒè¿™æ ·ï¼š

```cmake
macro(debug msg)
  message(STATUS "DEBUG ${msg}")
endmacro()

macro(debug_print_value variableName)
  debug("${variableName}=\${${variableName}}")
endmacro()

macro(dump_list listName)
  message("- List of ${listName} -------------")
  foreach (lib ${${listName}})
    message("                         ${lib}")
  endforeach (lib)
endmacro()
```

ä½¿ç”¨æ–¹æ³•ç®€å•ï¼š

```cmake
include(utils)
set(DEBUG 1)
debug_print_value(DEBUG)
```



#### debug_dump_cmake_variables

debug_dump_cmake_variables æ˜¯æ›´å¤æ‚ä¸€ç‚¹çš„å‡½æ•°å®ä¾‹ï¼Œå®ƒèƒ½ dump å‡ºå…¨éƒ¨çš„ cmake å˜é‡ã€‚

```cmake
function(debug_dump_cmake_variables)
  get_cmake_property(_variableNames VARIABLES)
  list(SORT _variableNames)
  foreach (_variableName ${_variableNames})
    if (ARGV0)
      unset(MATCHED)

      #case sensitive match
      # string(REGEX MATCH ${ARGV0} MATCHED ${_variableName})
      #
      #case insenstitive match
      string(TOLOWER "${ARGV0}" ARGV0_lower)
      string(TOLOWER "${_variableName}" _variableName_lower)
      string(REGEX MATCH ${ARGV0_lower} MATCHED ${_variableName_lower})

      if (NOT MATCHED)
        continue()
      endif ()
    endif ()
    message(STATUS "  - ${_variableName} = ${${_variableName}}")
  endforeach ()
endfunction()
```

debug_dump_cmake_variables ä¹Ÿæ”¯æŒç­›é€‰ã€‚æ‰€ä»¥å®ƒçš„ç”¨æ³•å¦‚ä¸‹ï¼š

```cmake
debug_dump_cmake_variables()           # dump å…¨éƒ¨ cmake å˜é‡
debug_dump_cmake_variables("^Boost")   # dump ä»¥ Boost å¼€å¤´çš„å˜é‡
```







ğŸ”š

