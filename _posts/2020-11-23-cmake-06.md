---
layout: single
title: 'cmake 06 - æ·»åŠ ç‰¹æ€§'
date: 2020-11-24 10:23:00 +0800
last_modified_at: 2020-11-24 10:23:00 +0800
Author: hedzr
tags: [c++, cmake-hello, cmake, build, modern cmake, cmake tutorial, cmake examples]
categories: cmake notes
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  Modern CMake Tutorial ç›¸å…³ï¼ŒAdd Featuresï¼Œå¢åŠ ç‰¹æ€§...
---



> æŒ‰ï¼š
>
> è¿™ä¸ªç³»åˆ—ä¸ cmake æœ‰å…³çš„è®°å½•ä¹Ÿå¥½ï¼Œç¬”è®°ä¹Ÿå¥½ï¼Œæˆä¹¦ä¹Ÿå¥½ï¼Œç›®å‰æš‚ä¸”å½’å±åœ¨ [cmake-hello](/tags/#cmake-hello) æ ‡è®°ä¹‹ä¸‹ã€‚
>
> æºç è¯·è®¿é—®ï¼š
> > <https://github.com/hedzr/study-cmake>  
> > è¯·æ³¨æ„æºç ä»åœ¨è·Ÿéšæˆ‘çš„ç¬”è®°å†…å®¹çš„è¿­ä»£è€Œæ›´æ–°ä¸­ã€‚







> **æŒ‰**ï¼š
>
> æœ¬ç« ä¸­é€æ­¥è§£é‡Š `study-cmake` æ‰€å»ºç«‹çš„ cmake èŒƒæœ¬æ‰€å¤„ç†çš„ä»»åŠ¡ã€‚





## C++11 ç­‰

[CMAKE_CXX_STANDARD](https://cmake.org/cmake/help/latest/variable/CMAKE_CXX_STANDARD.html?highlight=cmake_cxx_standard) æ˜¯ä¸€ä¸ªå†…å»ºçš„å˜é‡ï¼Œå…¶ç”¨é€”æ˜¯ä¸ºäº†å»æ‰ -stdc++11 -gnuc++11 -std=gnu++11 ç­‰ç­‰ç­‰è¿™æ ·çš„ä¹±è±¡ã€‚

æˆ‘ä»¬ç°åœ¨ä¹Ÿæœ‰äº†æ¯”è¾ƒå®‰å…¨ç®€ç»ƒçš„å®£å‘Šæ–¹æ³•ï¼š

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# set(CMAKE_CXX_EXTENSIONS OFF)
```

[CMAKE_CXX_STANDARD_REQUIRED](https://cmake.org/cmake/help/latest/variable/CMAKE_CXX_STANDARD_REQUIRED.html?highlight=cmake_cxx_standard#variable:CMAKE_CXX_STANDARD_REQUIRED) å¯ä»¥ä¸ºæ¯ä¸ª Target åˆå§‹åŒ– [`CXX_STANDARD_REQUIRED`](https://cmake.org/cmake/help/latest/prop_tgt/CXX_STANDARD_REQUIRED.html#prop_tgt:CXX_STANDARD_REQUIRED) å±æ€§ã€‚è€Œ CXX_STANDARD_REQUIRED å­˜åœ¨çš„ç›®çš„æ˜¯å¦‚æœç”¨æˆ·æ²¡æœ‰å¯¹è‡ªå·±çš„ CXX_STANDARD ä½œå‡ºå®£å‘Šçš„è¯ï¼Œé‚£å®ƒå°±ä¼šæ­»â€”â€”ä½† `set(CMAKE_CXX_STANDARD 17)` å¯ä»¥ä»¤è¿™äº›æªæ–½ä¸€å¾‹æ— æ„ä¹‰ã€‚è¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿå¯¹ç¼–è¯‘å™¨çš„C++æ ‡å‡†å…¼å®¹æ€§è¿›è¡Œæ›´å¥½çš„çº¦æŸï¼Œä½†å¯¹ç»å¤§å¤šæ•°äººæ¥è¯´æ¯«æ— æ„ä¹‰ã€‚



### é’ˆå¯¹å…·ä½“ Target

#### æ—§æ–¹æ³•

å¯¹äºæ¯ä¸ª Target æ¥è¯´ï¼Œä½ åŸæœ¬åº”è¯¥è¿™æ ·å®£å‘Š [CXX_STANDARD](https://cmake.org/cmake/help/latest/prop_tgt/CXX_STANDARD.html):

```cmake
set_property(TARGET tgt PROPERTY CXX_STANDARD 11)
```

ä½† CMAKE_CXX_STANDARD å·²ç»è¢«é¢„è®¾çš„æƒ…å†µä¸‹ï¼ŒCXX_STANDARD ä¼šè·å¾—ç›¸åº”å€¼ã€‚

#### æ–°æ–¹æ³•

```cmake
set_target_properties(myTarget PROPERTIES
    CXX_STANDARD 11
    CXX_STANDARD_REQUIRED YES
    CXX_EXTENSIONS NO
)
```







## Policies

[Policies](https://www.mankier.com/7/cmake-policies) ä¸çŸ¥é“è¯¥è¯‘ä½œæ”¿ç­–ã€å‡†åˆ™è¿˜æ˜¯å‰ææ¡ä»¶ï¼Œæˆ–è€…æ˜¯çº¦å®šï¼Ÿæ‰€ä»¥å¹²è„†ä¸è¯‘äº†ï¼Œåæ­£å½“å¹´æ C++ Template æ—¶æˆ‘ä¹Ÿä»æœªç¿»è¯‘è¿‡ policyã€‚

CMake Policies æ˜¯ä¸€ç³»åˆ—çš„å…¼å®¹æ€§çº¦å®šï¼Œå®ƒå†³å®šäº† CMake åœ¨å¤„ç† `CMakeLists.txt` æ—¶æ€ä¹ˆè¿›è¡Œè§£é‡Šï¼Œè¦ä¸è¦åˆ¤å®šæ— æ•ˆã€è¿‡æ—¶è¯­æ³•æˆ–è€…å°šä¸èƒ½è¯†åˆ«çš„è¯­æ³•å¹¶å¯¹å…¶æŠ¥é”™ã€‚

å¯¹äºç°å®ç”Ÿæ´»æ¥è¯´ï¼Œä½ å¾€å¾€å¹¶ä¸éœ€è¦å…³å¿ƒè¯¥é‡‡ç”¨å“ªäº› policiesï¼Œåˆè¯¥å°†å“ªäº› policies ç½®ä¸ºå‘å‰å…¼å®¹ã€‚å› ä¸ºå¾ˆå¤šé”™è¯¯æç¤ºéƒ½å°†ä¼šæç¤ºä½ åº”è¯¥å¯ç”¨ CMP#### çš„ Policy å…¼å®¹æ€§å¼€å…³ã€‚

ä¸€äº›å¸¸å¸¸è¢«ç”¨åˆ°çš„ï¼š

```cmake
# CMake Warning (dev) at CMakeLists.txt:5 (ADD_EXECUTABLE):
# Policy CMP0049 is not set: Do not expand variables in target source
# entries.  Run "cmake --help-policy CMP0049" for policy details.  Use the
# cmake_policy command to set the policy and suppress this warning.
if (POLICY CMP0049)
  cmake_policy(SET CMP0049 NEW)
endif ()

if (COMMAND cmake_policy)
  # we prefer the more strict behavior, to find out more:
  # cmake --help-policy CMP0003
  cmake_policy(SET CMP0003 NEW)
endif ()


cmake_policy(SET CMP0042 NEW) # ENABLE CMP0042: MACOSX_RPATH is enabled by default.
cmake_policy(SET CMP0048 NEW)
cmake_policy(SET CMP0054 NEW) # ENABLE CMP0054: Only interpret if() arguments as variables or keywords when unquoted.
cmake_policy(SET CMP0063 NEW) # ENABLE CMP0063: Honor visibility properties for all target types.
cmake_policy(SET CMP0069 NEW)
cmake_policy(SET CMP0077 NEW) # ENABLE CMP0077: option() honors normal variables

if (POLICY CMP0068)
  cmake_policy(SET CMP0068 NEW)
endif ()

if (${CMAKE_VERSION} VERSION_LESS 3.12)
  cmake_policy(VERSION ${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION})
endif ()
```

ä½ å¯ä»¥è·³è¿‡äº†è§£ Policyï¼Œå®ƒä¸ä¼šé˜»ç¢ä½ æŒæ¡ cmake çš„è¿ç”¨ã€‚

åœ¨å°†æ¥å½“ä½ é‡åˆ°ç›¸å…³é—®é¢˜æ—¶ï¼Œè·Ÿéšæç¤ºé˜…è¯»åœ¨çº¿æ–‡æ¡£å³å¯ã€‚ä¾‹å¦‚å¯¹äº CMP0054 æ¥è¯´ï¼Œå‘½ä»¤è¡Œ `cmake --help-policy CMP0054` èƒ½å¤Ÿè·å¾—ä¸€ä¸ªç®€è¦çš„è¯´æ˜ï¼š

```bash
CMP0054
-------

Only interpret ``if()`` arguments as variables or keywords when unquoted.

CMake 3.1 and above no longer implicitly dereference variables or
interpret keywords in an ``if()`` command argument when
it is a :ref:`Quoted Argument` or a :ref:`Bracket Argument`.

The ``OLD`` behavior for this policy is to dereference variables and
interpret keywords even if they are quoted or bracketed.
The ``NEW`` behavior is to not dereference variables or interpret keywords
that have been quoted or bracketed.

Given the following partial example:

::

 set(A E)
 set(E "")

 if("${A}" STREQUAL "")
   message("Result is TRUE before CMake 3.1 or when CMP0054 is OLD")
 else()
   message("Result is FALSE in CMake 3.1 and above if CMP0054 is NEW")
 endif()

After explicit expansion of variables this gives:

::

 if("E" STREQUAL "")

With the policy set to ``OLD`` implicit expansion reduces this semantically to:

::

 if("" STREQUAL "")

With the policy set to ``NEW`` the quoted arguments will not be
further dereferenced:

::

 if("E" STREQUAL "")

This policy was introduced in CMake version 3.1.
CMake version 3.18.3 warns when the policy is not set and uses
``OLD`` behavior.  Use the ``cmake_policy()`` command to set
it to ``OLD`` or ``NEW`` explicitly.

.. note::
  The ``OLD`` behavior of a policy is
  ``deprecated by definition``
  and may be removed in a future version of CMake.
```

è¿™ç©æ„å„¿è€é•¿çš„ï¼Œä½†æœ¬è´¨ç‰¹æ€§å°±ä¸€å¥è¯ï¼Œä»¥å‰ if() ä¸­çš„å˜é‡åä¸ç®¡æœ‰æ²¡æœ‰å¼•å·åŒ…å›´éƒ½ä¼šè¢«å°è¯•åšå˜é‡æ±‚å€¼å’Œå±•å¼€ï¼ˆä¹Ÿä¸ç®¡æœ‰æ²¡æœ‰ `${var}` å±•å¼€è¡¨è¾¾å¼ï¼‰ï¼Œä½†å¦‚æœä½ å¯ç”¨äº† `cmake_policy(SET CMP0054 NEW)` å‘¢ï¼Œå¼•å·åŒ…å›´çš„å˜é‡åå°±ä¸ä¼šè¢«å°è¯•æ±‚å€¼äº†ï¼Œå®ƒå°±æ˜¯ä¸ªç®€å•çš„å­—ç¬¦ä¸²è€Œå·²ï¼Œå¼•å·ä¸­æƒ³è¦æ±‚å€¼å°±å¿…é¡»é‡‡ç”¨ `${var}` å±•å¼€è¡¨è¾¾å¼æ‰è¡Œäº†ã€‚

ä½œä¸ºä¸€ä¸ªæ‹“å±•ï¼Œä½ ä¹Ÿå¯ä»¥å‚è€ƒï¼š

- <https://cmake.org/cmake/help/latest/manual/cmake-policies.7.html>
- <https://www.mankier.com/7/cmake-policies>
- <https://community.kde.org/Policies/CMake_Coding_Style>

ç­‰ç­‰ã€‚



## Modules

ä½ å¯ä»¥è‡ªå®šä¹‰ FindXXX.cmakeï¼Œå½“ä½ åœ¨ä½¿ç”¨ `find_library(XXX)` æ—¶ï¼Œfind_library å°†ä¼šå¯»æ‰¾ FindXXX.cmake å¹¶ç”¨äºå®šä½ç‰¹å®šçš„ Moduleã€‚

ä¾‹å¦‚ä½ å¯ä»¥ç¼–å†™ä¸€ä¸ª FindFLEX.cmakeï¼Œé‚£ä¹ˆä»Šåç”¨åˆ° find_library(FLEX) çš„æ—¶å€™ï¼Œä½ çš„è„šæœ¬å°±å¯ä»¥è¢«ç”¨äºå¯»æ‰¾ `flex`ï¼Œè¿™æ˜¯ä¸€ä¸ªè‘—åçš„è¯æ³•ç¼–è¯‘å™¨çš„ç¼–è¯‘å™¨ã€‚

å¯¹äº find_package æŒ‡ä»¤æ¥è¯´ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

ä¸è¿‡ï¼Œåœ¨æœ¬èŠ‚ä¹‹ä¸­ï¼Œåªæ˜¯ä¸ºäº†ç»™ä¼ ç»Ÿï¼ˆæ—§å¼çš„ï¼‰Modulesç•™ä¸€ä¸ªä½ç½®ï¼Œå› ä¸ºæ—©æœŸ cmake ç¼–å†™æƒ¯ä¾‹ä¸­éœ€è¦é¦–å…ˆç¼–å†™ä¸€ç³»åˆ—çš„ FindXXX æ¯”å¦‚è¯´ find_package(BOOST REQUIRED) ä»€ä¹ˆçš„æ¥å®šä½å’Œå®‰æ’æˆ‘ä»¬æ‰€éœ€è¦ç”¨åˆ°çš„ç¬¬ä¸‰æ–¹ä¾èµ–åº“ã€‚

è¿™å¾€å¾€è¿˜ä¼šæ¶‰åŠåˆ°ç¬¬ä¸‰æ–¹ä¾èµ–åº“è¢«å®‰æ”¾åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œè¦ä¸è¦äº‹å…ˆç¼–è¯‘ç­‰ç­‰é—®é¢˜ã€‚

è€Œåœ¨ Modern CMake ä¸­ï¼Œæˆ‘ä»¬åªä¼šåœ¨æ¯ä¸ª Target ä¸­æœ‰é€‰æ‹©åœ°è¿›è¡Œ FindXXX è°ƒç”¨ï¼Œæœ‰çš„æ—¶å€™ç”šè‡³å¯ä»¥ç•¥è¿‡å®ƒã€‚







### æ›´å¤šæœ‰ç”¨çš„æ¨¡å—

cmake æä¾›äº†å¤§é‡å†…ç½®çš„ Modulesï¼ŒCheckXXXã€FindXXX æ˜¯å…¶ä¸­æœ€è‘—åçš„ä¸¤å¤§ç±»ã€‚CheckXXX é€šå¸¸æä¾›æŸç§ç¯å¢ƒæ¡ä»¶çš„æ£€æµ‹å¹¶ä»¥å†…å»ºå˜é‡çš„æ–¹å¼è¿”å›æ£€æµ‹ç»“æœï¼ŒFindXXX ä¸€èˆ¬è¢« find_package æˆ– find_library æŒ‡ä»¤æ‰€è°ƒç”¨ï¼Œç›®çš„æ˜¯æ‰¾åˆ°æ„å»ºä¸»æœºä¸ŠæŸä¸ªç¬¬ä¸‰æ–¹åº“çš„å®‰è£…ä½ç½®ã€å¤´æ–‡ä»¶ã€åº“æ–‡ä»¶ç­‰ç­‰é…ç½®å€¼ï¼Œè§£å†³ç›¸åº”çš„ä¾èµ–å…³ç³»ã€‚

æœ‰ä¸€äº› Modules å¯èƒ½æ˜¯ç›¸å½“æœ‰ç”¨çš„ï¼Œæ‰€ä»¥ä¸‹é¢é€‰æ‹©å‡ ä¸ªç®€å•ä»‹ç»ï¼Œä½ å¯ä»¥åœ¨ [Modules at GitHub](https://github.com/Kitware/CMake/tree/master/Modules) æµè§ˆå…¨éƒ¨ cmake å†…ç½® Modulesï¼Œæ­¤å¤–ï¼Œå®˜ç½‘æ–‡æ¡£çš„ [cmake-modules(7) â€” CMake 3.19.0 Documentation](https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html) åŒºæœ‰ç›¸åº”çš„æ–‡æ¡£ï¼Œéƒ½èƒ½æä¾›å¾ˆå¥½çš„å¸®åŠ©ã€‚



#### CheckCXXCompilerFlag

`CheckCXXCompilerFlag` ï¼ˆ[doc](https://cmake.org/cmake/help/latest/module/CheckCXXCompilerFlag.html), [src](https://github.com/Kitware/CMake/blob/master/Modules/CheckCXXCompilerFlag.cmake)ï¼‰å¯è¢«ç”¨äºæ£€æµ‹ç¼–è¯‘å™¨æ ‡å¿—æ˜¯å¦æ˜¯è¢«å½“å‰ç¼–è¯‘å™¨æ‰€æ”¯æŒçš„ã€‚

```cmake
include(CheckCXXCompilerFlag)
check_cxx_compiler_flag("-std=c++21" COMPILER_SUPPORTS_CXX21)
check_cxx_compiler_flag("-std=c++17" COMPILER_SUPPORTS_CXX17)
check_cxx_compiler_flag("-std=c++14" COMPILER_SUPPORTS_CXX14)
check_cxx_compiler_flag("-std=c++11" COMPILER_SUPPORTS_CXX11)
check_cxx_compiler_flag("-std=c++0x" COMPILER_SUPPORTS_CXX0X)
if(COMPILER_SUPPORTS_CXX11)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -std=c++11")
    add_definitions(-DCOMPILEDWITHC11)
    message(STATUS "Using flag -std=c++11.") 
endif()
```

æ³¨æ„ç±»ä¼¼çš„å†…å»º Modules è¿˜å¯ä»¥æœ‰ [CheckForPthreads]ï¼Œ[CheckFunctionExists]ï¼Œ[CheckLanguage]ï¼Œ[CheckLibraryExists]ï¼Œ[CheckLinkerFlag] ç­‰ç­‰ã€‚åœ¨ [cmake-modules(7)](https://cmake.org/cmake/help/latest/manual/cmake-modules.7.html) é¡µé¢ä¸­å¯ä»¥æ‰¾åˆ°å®ƒä»¬ã€‚



#### CMakePrintHelpers

`CMakePrintHelpers` ï¼ˆ[doc](https://cmake.org/cmake/help/v3.8/module/CMakePrintHelpers.html?highlight=i), [src](https://github.com/Kitware/CMake/blob/master/Modules/CMakePrintHelpers.cmake)ï¼‰åŒ…å«ä¸€äº›è°ƒè¯•è¾“å‡ºå‡½æ•°ï¼Œä¾‹å¦‚ `cmake_print_variables`ï¼Œ`cmake_print_properties`ã€‚

ç¤ºä¾‹ï¼š

```cmake
cmake_print_variables(var1 var2 ..  varN)
cmake_print_variables(CMAKE_C_COMPILER CMAKE_MAJOR_VERSION DOES_NOT_EXIST)
cmake_print_properties(TARGETS foo bar PROPERTIES
                       LOCATION INTERFACE_INCLUDE_DIRECTORIES)
```

cmake_print_properties å…·æœ‰å¦‚ä¸‹çš„è¯­æ³•å’Œæ ¼å¼ï¼š

```
  cmake_print_properties([TARGETS target1 ..  targetN]
                        [SOURCES source1 .. sourceN]
                        [DIRECTORIES dir1 .. dirN]
                        [TESTS test1 .. testN]
                        [CACHE_ENTRIES entry1 .. entryN]
                        PROPERTIES prop1 .. propN )

```





#### FeatureSummary

åœ¨ CMakeLists.txt ä¸€å¼€å§‹åŠ å…¥å‘½ä»¤ï¼š

```cmake
include(FeatureSummary)
```

æ¥ç€ç…§å¸¸ä½¿ç”¨ä»»ä½• find_package è¯­å¥ã€‚ç°åœ¨æœ‰æ‰€ä¸åŒçš„æ˜¯ï¼Œfind è¿‡ç¨‹ä¸­çš„ç›¸å…³ä¿¡æ¯éƒ½èƒ½è¢«æ”¶é›†åˆ°æŸå¤„ã€‚æœ€ç»ˆï¼Œä½ å¯ä»¥å°†è¿™äº›ä¿¡æ¯è¾“å‡ºåˆ°æŸå¤„ï¼š

```cmake
if(CMAKE_PROJECT_NAME STREQUAL PROJECT_NAME)
    feature_summary(WHAT ENABLED_FEATURES DISABLED_FEATURES PACKAGES_FOUND)
    feature_summary(FILENAME ${CMAKE_CURRENT_BINARY_DIR}/features.log WHAT ALL)
endif()
```

åœ¨ä½ ä½¿ç”¨å¤§é‡ find_package çš„è¿‡ç¨‹ä¸­ï¼Œè¿˜å¯ä»¥ä½¿ç”¨ add_feature_info æ¥åµŒå…¥ä½ è‡ªå·±çš„æ–‡å­—ã€‚ä¾‹å¦‚è¿™æ ·ï¼š

```cmake
include(FeatureSummary)

...
find_package(OpenMP)
add_feature_info(WITH_OPENMP OpenMP_CXX_FOUND "OpenMP (Thread safe FCNs only)")
...

...
```

ä½ è¿˜å¯ä»¥ä¸ºæŸä¸ªç¨‹åºåŒ…æ‰©å±•ä¸€äº›å…ƒæ•°æ®ï¼š

```cmake
set_package_properties(OpenMP PROPERTIES
    URL "http://www.openmp.org"
    DESCRIPTION "Parallel compiler directives"
    PURPOSE "This is what it does in my package")
```







#### GNUInstallDirs

CMake æä¾›ä¸€ä¸ªå†…å»ºçš„æ ‡å‡†åŒ–ç›®å½•é›†ï¼Œè¿™æ˜¯ä¸€ç»„ç¬¦åˆ [GNU Coding Standard](https://www.gnu.org/prep/standards/html_node/Directory-Variables.html) çš„æ–‡ä»¶å¤¹çš„é¢„å®šä¹‰å˜é‡é›†åˆã€‚å®ƒä»¬å°†è¢«ç”¨äº install() æŒ‡ä»¤ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥é¦–å…ˆåŒ…å«å®ƒï¼š

```cmake
# Must use GNUInstallDirs to install libraries into correct locations on all platforms.
include(GNUInstallDirs)
```

ç„¶åæˆ‘ä»¬å°†ä¼šè·å¾—ä¸€å †å˜é‡ï¼Œå®ƒä»¬æ˜¯ `CMAKE_INSTALL_<dir>` ä»¥åŠ `CMAKE_INSTALL_FULL_<dir>`ï¼š

```
CMAKE_INSTALL_<dir>      - destination for files of a given type
CMAKE_INSTALL_FULL_<dir> - corresponding absolute path
```

è€Œ `<dir>` å°†ä¼šæ˜¯è¿™äº›åå­—ï¼š

```
BINDIR           - user executables (bin)
SBINDIR          - system admin executables (sbin)
LIBEXECDIR       - program executables (libexec)
SYSCONFDIR       - read-only single-machine data (etc)
SHAREDSTATEDIR   - modifiable architecture-independent data (com)
LOCALSTATEDIR    - modifiable single-machine data (var)
LIBDIR           - object code libraries (lib or lib64 or lib/<multiarch-tuple> on Debian)
INCLUDEDIR       - C header files (include)
OLDINCLUDEDIR    - C header files for non-gcc (/usr/include)
DATAROOTDIR      - read-only architecture-independent data root (share)
DATADIR          - read-only architecture-independent data (DATAROOTDIR)
INFODIR          - info documentation (DATAROOTDIR/info)
LOCALEDIR        - locale-dependent data (DATAROOTDIR/locale)
MANDIR           - man documentation (DATAROOTDIR/man)
DOCDIR           - documentation root (DATAROOTDIR/doc/PROJECT_NAME)
```

è¿™äº›ç›®å½•ä¸ PREFIX æœ‰å…³ï¼šåœ¨ configure ä½“ç³»ä¸­ï¼ŒæŒ‡çš„æ˜¯ `./configure --prefix`ï¼Œé€šå¸¸æˆ‘ä»¬æ˜¯ä½¿ç”¨ `./configure --prefix=/usr/local` æ¥è®© INSTALL_DIR ä¸º `/usr/local/{bin,include,lib}` ç­‰ç­‰ä½ç½®è€Œä¸æ˜¯ `/usr/{bin,include,lib}` ç­‰ä½ç½®ä»¥é¿å… sudo/root ç‰¹æƒè¯·æ±‚ï¼›è€Œåœ¨ cmake ä½“ç³»ä¸­ï¼Œå®ƒæŒ‡çš„æ˜¯ `CMAKE_INSTALL_PREFIX` è¿™ä¸ªå˜é‡ï¼Œä½ å¯ä»¥è®¾ç½®è¯¥å˜é‡è¾¾åˆ°ç­‰åŒçš„æ•ˆæœã€‚

> ä¾‹å¦‚å…¸å‹åœ° CMAKE_INSTALL_FULL_BINDIR=/usr/local/bin

ä¸åš `CMAKE_INSTALL_PREFIX` è®¾å®šçš„è¯ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯ `/usr/local`ï¼Œè¿™æ˜¯ç°ä»£ cmake ä»¥åŠç°ä»£ linux å‘è¡Œç‰ˆï¼ˆä»¥åŠmacOSï¼‰çš„ç»å¸¸æ€§çš„é»˜è®¤è®¾å®šã€‚ä¸è¿‡è¿™ä¸ªè¯é¢˜ç›¸å½“å¤æ‚ï¼Œå› ä¸ºæœ‰çš„æ—¶å€™å¯èƒ½ä¼šæœ‰ empty å€¼ï¼Œ`/` ä»¥åŠ `/opt` ç­‰å¯èƒ½æ€§ã€‚å…³äºæ–‡ä»¶ç³»ç»Ÿä¸­çš„è¿™äº›ç»“æ„ä¹Ÿå¯ä»¥å‚è€ƒ [Filesystem Hierarchy Standard](https://refspecs.linuxfoundation.org/FHS_3.0/fhs/index.html)ã€‚

`CMAKE_INSTTALL_PREFIX` æ›´å¤šæ˜¯ä¸ºåº“çš„ä½¿ç”¨è€…å‡†å¤‡çš„ï¼Œä½¿ç”¨è€…å¯ä»¥é€šè¿‡ cmake -D CMAKE_INSTALL_PREFIX=xxx çš„æ–¹å¼æ¥é€‰æ‹©è‡ªå·±æƒ³è¦çš„æ„å»ºç›®çš„ã€‚

å¯¹äºæƒ³è¦æ”¯æŒ Multi-arch çš„ä½¿ç”¨è€…æ¥è¯´ï¼Œä»–ä¹Ÿè®¸ä¼šä½¿ç”¨ `/usr/local/lib/x86` ä½œä¸ºä¸€ä¸ªæ„å»ºç›®çš„ï¼Œè¿™é¿å…äº†æ±¡æŸ“æ„å»ºä¸»æœºä¸Šçš„æ´»åŠ¨ archã€‚è‡³äºä½¿ç”¨ `/usr/local` è€Œä¸æ˜¯ `/usr` æ¥é¿å… sudo è¯·æ±‚ä¹Ÿæ˜¯ä¸€ç§å¯èƒ½ã€‚å…¶å®ƒçš„å¯èƒ½æ€§è¿˜æœ‰ä¸åŒçš„ lib å˜ä½“ï¼ˆä¾‹å¦‚ `/usr/local/{lib,lib64,lib32,libx32}`ï¼‰ï¼Œäº¤å‰ç¼–è¯‘ç¯å¢ƒï¼Œç­‰ç­‰ã€‚





#### GoogleTest

TODO

- [GoogleTest](https://cmake.org/cmake/help/latest/module/GoogleTest.html)



#### UsewxWidgets

TODO

- [UsewxWidgets](https://cmake.org/cmake/help/latest/module/UsewxWidgets.html)



#### WriteCompilerDetectionHeader

- [WriteCompilerDetectionHeader](https://cmake.org/cmake/help/latest/module/WriteCompilerDetectionHeader.html)

åœ¨ä¸‹ä¸€èŠ‚ä¸­ä¼šæœ‰è¯¦ç»†ä»‹ç»







## æ£€æµ‹ç³»ç»Ÿï¼Œæ£€æµ‹ç¼–è¯‘å™¨ç¯å¢ƒ

### æ£€æµ‹æ„å»ºæ—¶ç³»ç»Ÿç¯å¢ƒ

å¯¹äºç³»ç»Ÿç¯å¢ƒï¼Œcmake ä¼šåœ¨é¦–æ¬¡æ„å»ºå‡†å¤‡æ—¶è¯†åˆ«å¹¶ç½®æ”¾å†…å»ºå˜é‡ [CMAKE_SYSTEM_NAME](https://cmake.org/cmake/help/latest/variable/CMAKE_SYSTEM_NAME.html) ï¼Œ[CMAKE_SYSTEM_VERSION](https://cmake.org/cmake/help/latest/variable/CMAKE_SYSTEM_VERSION.html) å’Œ [CMAKE_SYSTEM_PROCESSOR](https://cmake.org/cmake/help/latest/variable/CMAKE_SYSTEM_PROCESSOR.html)ï¼ˆå¯èƒ½çš„å–å€¼å¯ä»¥å‚é˜… [Possible values for uname -m](https://stackoverflow.com/a/45125525/6375060)ï¼‰ã€‚å¦‚æœå¯¹å†…å¹•æ„Ÿå…´è¶£è¿˜å¯ä»¥å‚è€ƒ [CMakeDetermineSystem.cmake](https://github.com/Kitware/CMake/blob/master/Modules/CMakeDetermineSystem.cmake) ä¸­çš„ä»£ç ã€‚

ç”±äºæˆ‘ä»¬å–œæ¬¢ MACOSï¼Œä»¥åŠå…¶å®ƒä¸€äº›åŸå› ï¼Œæ‰€ä»¥åˆ¶ä½œäº†ä¸€ä¸ª `detect-systems.cmake`

```cmake
# for MacOS X or iOS, watchOS, tvOS (since 3.10.3)
if (${CMAKE_SYSTEM_NAME} MATCHES "Darwin" OR APPLE)
  # MESSAGE("** Darwin detected.")
  SET(MACOSX TRUE)
  SET(MACOS TRUE)
  SET(macOS TRUE)
  SET(DARWIN TRUE)
  SET(MAC TRUE)
  SET(Mac TRUE)
endif ()

if (UNIX AND NOT MACOS)
  # for Linux, BSD, Solaris, Minix
  if (${CMAKE_SYSTEM_NAME} MATCHES "Linux")
    set(LINUX TRUE)
    set(Linux TRUE)
  elseif (${CMAKE_SYSTEM_NAME} MATCHES "^GNU/kFreeBSD|NetBSD|OpenBSD")
    set(BSD TRUE)
  elseif (${CMAKE_SYSTEM_NAME} MATCHES "Minix")
    set(Minix TRUE)
  endif ()
endif ()

if (WIN32)
  #do something
endif (WIN32)

if (MSVC OR MSYS OR MINGW)
  # for detecting Windows compilers
endif ()


if (LINUX)
  message(STATUS ">>> Linux" " FOUND")
elseif (MAC)
  message(STATUS ">>> macOS" " FOUND")
elseif (UNIX)
  message(STATUS ">>> Unix (BSD+,Unix+)" " FOUND")
elseif (MSVC)
  message(STATUS ">>> MSVC" " FOUND")
elseif (WIN32)
  message(STATUS ">>> Win32" " FOUND")
else ()
  message(STATUS ">>> Unknown" " FOUND")
endif ()
```



### æ£€æµ‹ç¼–è¯‘å™¨ç¯å¢ƒ

cmake ä¹Ÿè‡ªåŠ¨å®Œæˆç¼–è¯‘å™¨çš„æ£€æµ‹ã€‚æ£€æµ‹çš„ç»“æœè¢«åˆ†æ•£åœ¨ä¸–ç•Œå„åœ°ï¼Œæ‰€ä»¥æˆ‘ä»¬é€šå¸¸ä¸é’ˆå¯¹ç¼–è¯‘å™¨åšç‰¹å®šçš„æ ¡æ­£ï¼Œè€Œä¸”ä¾èµ–äºå…¼å®¹ CXX_STANDARD å¹¶ä¸”æœŸå¾…ç¼–è¯‘å™¨èƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„ CXX_STANDARD å®£å‘Šã€‚

å¦‚æœå­˜åœ¨ç‰¹æ®Šçš„è¯­æ³•å…¼å®¹é—®é¢˜ï¼Œåˆ™æˆ‘ä»¬å¾€å¾€æ˜¯é€šè¿‡åœ¨ C++ ä»£ç æ–‡ä»¶ä¸­ä½¿ç”¨ #if å®æ¥æå®šçš„ã€‚

å¤å…¸çš„ C++ ä»£ç ä¸­çš„ç¼–è¯‘å™¨åŠå…¶ç‰¹æ€§æ£€æµ‹å·²ç»è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸åšå±•å¼€ã€‚ä½†å®é™…ä¸Šä½ ä¹Ÿå¯ä»¥ä¸å†å­¦ä¹ ä¼ ç»Ÿçš„ #if å®å¥—è·¯ï¼Œè€Œæ˜¯åˆ©ç”¨ cmake çš„æ£€æµ‹ç»“æœã€‚

æ‰€ä»¥ç°åœ¨æˆ‘ä»¬æ›´å¤šæ˜¯é‡‡ç”¨ cxx æ ‡å‡†ä»¥åŠ cxx ç‰¹æ€§çš„æ”¯æŒåº¦æ¥è¿›è¡Œä»£ç ç¼–å†™ã€‚åœ¨C++çš„ç°ä»£å¼€å‘ä¸­ï¼Œå¦‚æœé€šè¿‡æµ‹è¯•ç¼–è¯‘å™¨æ”¯æŒåº¦çš„æ–¹å¼æ¥ç¼–å†™å¥½çš„æ¨¡æ¿ä»£ç åŸºæœ¬ä¸Šæ˜¯ C++ å…ƒç¼–ç¨‹çš„å¿…é¡»å­¦ä¹ çš„æ­¥éª¤ï¼Œä¸è¿‡è¿™ä¸ªæ–¹é¢å…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆç³»ç»Ÿçš„æ•™æã€æ–‡ç« å¯ä»¥æ±‚å–ï¼Œåªèƒ½é€šè¿‡ç ”ç©¶ä»–äººæºç ã€è·Ÿè¿› CppCon ä¹‹ç±»çš„é£å‘å»è®¾æ³•å­¦ä¹ ã€‚

ä¸è¿‡ CMake æä¾›äº†å¦ä¸€ç§æ–¹æ¡ˆï¼Œæ¯”è¾ƒè½»é‡å’Œç®€ä¾¿ï¼Œåªæ˜¯ç•¥æœ‰ä¸€ç‚¹è¢«ç»‘å®šçš„å±é™©ã€‚è¯·ç»§ç»­é˜…è¯»ä¸‹é¢çš„å°èŠ‚ï¼š



### WriteCompilerDetectionHeader

CMake ç°åœ¨æ”¯æŒä¸€ç§å«åš [WriteCompilerDetectionHeader](https://cmake.org/cmake/help/latest/module/WriteCompilerDetectionHeader.html) ( [src](https://github.com/Kitware/CMake/blob/master/Modules/WriteCompilerDetectionHeader.cmake) ) çš„æ–°ç‰¹æ€§ï¼Œå®ƒå¯ä»¥å°†ç¼–è¯‘å™¨å®šä¹‰ä¸ºä¸€ä¸ªC++å®å˜é‡å¹¶å†™å…¥ä¸€ä¸ª C++ å¤´æ–‡ä»¶ã€‚é™¤æ­¤è€Œå¤–ï¼Œå®ƒè¿˜é€šè¿‡æ£€æµ‹å„ CXX ç¼–è¯‘å™¨é¢„å®šä¹‰å®çš„æ–¹å¼æ¥æä¾›å¯¹ CXX ç‰¹æ€§çš„åˆ¤å®šã€‚

ä¾æ®è¿™äº›åˆ¤å®šï¼Œæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡è¾ƒä¸ºç®€å•çš„æ–¹å¼æ¥ç¡®å®šå½“å‰ç¼–è¯‘å™¨å¯¹ CXX æ ‡å‡†ç‰¹æ€§çš„æ”¯æŒåº¦ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æŒ‡å®š `FEATURES cxx_variadic_templates` æ¥æ£€æµ‹ç¼–è¯‘å™¨å¯¹å¯å˜æ•°é‡å‚æ•°çš„æ¨¡æ¿çš„æ”¯æŒåº¦ã€‚

> æ›´å¤šçš„ cxx ç‰¹æ€§åå­—å¯ç›´è¾¾ [Symbol Macros](https://cmake.org/cmake/help/v3.15/module/WriteCompilerDetectionHeader.html#symbol-macros)ï¼Œ[Compatibility Implementation Macros](https://cmake.org/cmake/help/v3.15/module/WriteCompilerDetectionHeader.html#compatibility-implementation-macros) ç­‰ç­‰ä¸€ç³»åˆ—åœ¨çº¿æ–‡æ¡£ã€‚

#### æ£€æµ‹ variadic template ç‰¹æ€§

æˆ‘ä»¬åˆ¶ä½œäº†åä¸º cxx-detect-compilers.cmake çš„ç‰‡æ®µæ¥å¼•ç”¨è¯¥ç‰¹æ€§ï¼š

```cmake
# https://cmake.org/cmake/help/latest/module/WriteCompilerDetectionHeader.html
# include(WriteCompilerDetectionHeader)
# https://cmake.org/cmake/help/v3.14/manual/cmake-compile-features.7.html#manual:cmake-compile-features(7)
set(WriterCompilerDetectionHeaderFound NOTFOUND)
# This module is only available with CMake >=3.1, so check whether it could be found
# BUT in CMake 3.1 this module doesn't recognize AppleClang as compiler, so just use it as of CMake 3.2
if (${CMAKE_VERSION} VERSION_GREATER "3.2")
  include(WriteCompilerDetectionHeader OPTIONAL RESULT_VARIABLE WriterCompilerDetectionHeaderFound)
endif ()
if (WriterCompilerDetectionHeaderFound)
  write_compiler_detection_header(
          FILE the-compiler.h
          PREFIX The
          COMPILERS GNU Clang MSVC Intel  # AppleClang SunPro
          FEATURES cxx_variadic_templates
  )
endif ()
```

å½“ cmake çš„æ„å»ºå‡†å¤‡å®Œæˆä¹‹åï¼Œä½ å¯ä»¥å¼•ç”¨è¿™ä¸ªç‰‡æ®µçš„è¾“å‡ºæ–‡ä»¶ `the-compiler.h` ï¼Œ

```c++
#include "the-compiler.h"

#if The_COMPILER_IS_AppleClang
#define COMPILER 1
#endif

#if The_COMPILER_IS_GNU
#define COMPILER 2
#endif

// ç”±äºæˆ‘ä»¬è¯·æ±‚äº† variadic template ç‰¹æ€§çš„æ£€æµ‹ï¼Œæ‰€ä»¥ä¸‹é¢çš„é¢„ç¼–è¯‘
// æ¡ä»¶å¯ä»¥ä¿è¯ç¼–è¯‘æ­£ç¡®æ€§ã€‚
#if The_COMPILER_CXX_VARIADIC_TEMPLATES
template<int I, int... Is>
struct Interface;

template<int I>
struct Interface<I>
{
  static int accumulate()
  {
    return I;
  }
};

template<int I, int... Is>
struct Interface
{
  static int accumulate()
  {
    return I + Interface<Is...>::accumulate();
  }
};
#else
template<int I1, int I2 = 0, int I3 = 0, int I4 = 0>
struct Interface
{
  static int accumulate() { return I1 + I2 + I3 + I4; }
};
#endif
```

ä¹Ÿåˆ«å¿½ç•¥äº†çœŸæ­£çš„å®è—æ˜¯åœ¨ the-compiler.h ä¸­ï¼Œè¯»å®ƒï¼Œæ€ä¹ˆæ­£ç¡®åœ°å¤„ç†ç¼–è¯‘å™¨å·®åˆ«ä½ ä¼šå­¦åˆ°å¾ˆå¤šä¸œè¥¿ã€‚









## è¾“å‡ºæ–‡ä»¶å¤¹



### è¾“å‡ºä½ç½®ä¸å®‰è£…

è¿™äº›è·¯å¾„éƒ½æ˜¯ç»å¯¹è·¯å¾„ï¼š

- CMAKE_SOURCE_DIR

  å†…å®¹ä¸º source tree æ ¹ç›®å½•ã€‚

- CMAKE_BINARY_DIR

  å†…å®¹ä¸º binary tree æ ¹ç›®å½•ï¼Œåœ¨ in-source build æ—¶ä¸ CMAKE_SOURCE_DIR ç›¸åŒã€‚

- PROJECT_SOURCE_DIR

  å¯¹äºæ¯ä¸ª project è€Œè¨€ï¼Œç›¸åº”çš„ project æŒ‡ä»¤æ‰€åœ¨çš„ CMakeLists.txt æ–‡ä»¶æ‰€å¤„çš„æ–‡ä»¶å¤¹ã€‚

- PROJECT_BINARY_DIR

  å’Œ CMAKE_BINARY_DIR ç›¸ä¼¼ï¼Œå¾€å¾€ç­‰äº`${CMAKE_BIANRY_DIR}/<project-name>`ã€‚åœ¨ in-source build æ—¶å’Œ PROJECT_SOURCE_DIR ç›¸åŒã€‚

- CMAKE_CURRENT_SOURCE_DIR

  å½“å‰æ­£åœ¨å¤„ç†çš„ CMakeLists.txt æ‰€åœ¨çš„æ–‡ä»¶å¤¹ã€‚

- CMAKE_CURRENT_BINARY_DIR

  å½“å‰æ­£åœ¨å¤„ç†çš„ CMakeLists.txt æ‰€å¯¹åº”çš„æ„å»ºæ–‡ä»¶å¤¹ä½ç½®ã€‚

æ­¤å¤–ï¼Œå¯¹äºæ¯ä¸ª PROJECT æ¥è¯´ï¼Œ`<project_name>_SOURCE_DIR` å’Œ `<project_name>_BIANRY_DIR`  ä¹Ÿæ˜¯æœ‰æ•ˆçš„ã€‚æŸäº›åœºåˆä¸‹ä½ æˆ–è®¸ç”¨å¾—ä¸Šã€‚

æ­¤å¤–ï¼Œå®‰è£…ä½ç½®ä¹Ÿæœ‰ä¸€ç»„å˜é‡ï¼Œä½†æˆ‘ä»¬åªéœ€è¦çŸ¥é“



#### print

åˆ©ç”¨æˆ‘ä»¬æä¾›çš„ debug_print_value() å®ä½ å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è°ƒè¯•å’Œæ£€è§†è¿™äº›å˜é‡çš„å®é™…å€¼ï¼Œä»¥ä¾¿æ·±åˆ»ç†è§£ä»–ä»¬çš„ç›¸åº”å…³ç³»ã€‚

```cmake
include(utils)
debug_value_print(PROJECT_SOURCE_DIR)
```



### å…¶å®ƒè¾“å‡ºä½ç½®

`EXECUTABLE_OUTPUT_PATH` æ˜¯æ‰§è¡Œæ–‡ä»¶çš„è¾“å‡ºä½ç½®ï¼Œexecutable target å°†è¢«å†™å…¥è¯¥ä½ç½®ã€‚

`LIBRARY_OUTPUT_PATH` æ˜¯åº“æ–‡ä»¶çš„è¾“å‡ºä½ç½®ï¼Œlibrary target å°†è¢«å†™å…¥è¯¥ä½ç½®ã€‚

é»˜è®¤æ—¶ï¼Œè¯¥ä¸¤å˜é‡å‡ä½äº `CMAKE_BINARY_DIR` ä¹‹ä¸­ã€‚

ä½†æˆ‘ä»¬å¯ä»¥å°†å…¶ç§»å‡º build æ–‡ä»¶å¤¹ä»¥ä¾¿äºè°ƒç”¨ï¼Œä¾‹å¦‚ï¼š

```cmake
set(EXECUTABLE_OUTPUT_PATH "${CMAKE_SOURCE_DIR}/bin")
set(LIBRARY_OUTPUT_PATH "${CMAKE_SOURCE_DIR}/bin/lib")

# Note that CMAKE_GENERATED_DIR is NOT a cmake builtin variable.
set(CMAKE_GENERATED_DIR "${CMAKE_BINARY_DIR}/generated")
```



`CMAKE_GENERATED_DIR` å¹¶ä¸æ˜¯å†…å»ºå˜é‡ï¼Œä½†æˆ‘ä»¬å®šä¹‰å®ƒä»¥ä¾¿äºè¢« version-gen æ‰€ä½¿ç”¨ã€‚æœ‰å…³ version-gen çš„å†…å®¹ï¼Œè¯·å‚è€ƒâ€œç”Ÿæˆç‰ˆæœ¬å·æ–‡ä»¶â€ç« èŠ‚ä»¥åŠ  [version.in å’Œç‰ˆæœ¬è¿­ä»£çš„ç®¡ç†](./S03.md#version-in-%E5%92%8C%E7%89%88%E6%9C%AC%E8%BF%AD%E4%BB%A3%E7%9A%84%E7%AE%A1%E7%90%86)ã€‚





## è°ƒè¯•å’Œè¾“å‡º



`--trace` å¯ä»¥æä¾›æ¯”è¾ƒè¯¦ç»†çš„æ„å»ºç»†èŠ‚ï¼Œå®ƒå¯èƒ½ä¼šæœ‰åŠ©äºä½ å¯»æ‰¾è‡ªå·±çš„ cmake è„šæœ¬ä¸­çš„é—®é¢˜ã€‚

`--verbose` å¾ˆå¤šæ—¶å€™æ˜¯æœ‰æ•ˆçš„ï¼Œä¾‹å¦‚åœ¨ `cmake --build ....` æ—¶ï¼Œå®ƒçš„ä½œç”¨ä¹Ÿæ˜¯å¢åŠ è¾“å‡ºå†…å®¹çš„ä¸°å¯Œç¨‹åº¦ã€‚



### CMAKE_VERBOSE_MAKEFILE

ä¿®æ”¹ CMakeLists.txt åŠ å…¥ä¸‹é¢çš„è¡Œï¼š

```cmake
set(CMAKE_VERBOSE_MAKEFILE ON)
```

åˆ™ cmake ä¼šåœ¨æ„å»ºæ—¶æ˜¾ç¤ºå‡ºæ„å»ºå‘½ä»¤è¡Œï¼Œä¾‹å¦‚ ccï¼Œlinkåˆ°åº•åœ¨æ‰§è¡Œä»€ä¹ˆæ ·çš„é€‰é¡¹ï¼Œé“¾å…¥ä»€ä¹ˆæ ·çš„ä¸­é—´æ–‡ä»¶ç­‰ç­‰ã€‚

#### å‘½ä»¤è¡Œæ–¹å¼

ä½ å¯ä»¥ä¸å¿…ä¿®æ”¹ CMakeLists.txt åŠ å…¥ä¸Šé¢çš„è¡Œï¼Œè€Œæ˜¯ç›´æ¥é‡‡ç”¨å‘½ä»¤è¡Œæ–¹å¼ï¼š

```bash
cmake -DCMAKE_VERBOSE_MAKEFILE=ON ...options...
```

æˆ–è€…è¿˜å¯ä»¥ä½¿ç”¨å¾ˆä¸¥æ ¼çš„å£°æ˜ï¼š

```bash
cmake -DCMAKE_VERBOSE_MAKEFILE:BOOL=ON
```

å¼ºè¿«ç—‡æ‚£è€…ä¼šå–œæ¬¢è¿™æ ·çš„ã€‚



### utils

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª utils.cmake æ–‡ä»¶ï¼ŒåŒ…å«äº† debug_print_value ä»¥åŠ debug_print_top_value ç­‰é¢„å®šä¹‰çš„å®æˆ–è€…å‡½æ•°ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯å°†å¯¹åº”å˜é‡çš„å€¼æ‰“å°å‡ºæ¥ä»¥ä¾¿åˆ©äºä¾¦é”™ã€‚

å®ƒä»¬æ˜¯å¯¹`CMakePrintHelpers` çš„è¡¥å……ã€‚

ç®€å•çš„ç¤ºä¾‹ï¼š

```cmake
set(A "hello world")
debug_print_value(A)
# å°†ä¼šè¾“å‡ºï¼š
# DEBUG - A = hello world
```



### è°ƒè¯•ç”Ÿæˆè¡¨è¾¾å¼

è¯·å‚è€ƒå‰é¢çš„ç« èŠ‚ [ç”Ÿæˆå¼è¡¨è¾¾å¼/è°ƒè¯•](./S03.md#è°ƒè¯•)ã€‚





## ç”Ÿæˆç‰ˆæœ¬å·æ–‡ä»¶

è¯·å‚è€ƒå‰é¢çš„ç« èŠ‚ [version.in å’Œç‰ˆæœ¬è¿­ä»£çš„ç®¡ç†](./S03.md#version-in-%E5%92%8C%E7%89%88%E6%9C%AC%E8%BF%AD%E4%BB%A3%E7%9A%84%E7%AE%A1%E7%90%86)ã€‚





## æŒ‡å®šç¼–è¯‘é€‰é¡¹

ä»¥å‰æˆ‘ä»¬éœ€è¦è®¾ç½® CXX_FLAGS ä¹‹ç±»çš„å…¨å±€å˜é‡ã€‚ä¾‹å¦‚ï¼š

```cmake
SET(CMAKE_CXX_FLAGS "-std-c++11 ${CMAKE_CXX_FLAGS}")
```

ä½†åæ¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ [add_compile_options](https://cmake.org/cmake/help/v3.1/command/add_compile_options.html) å’Œ [add_definitions](https://cmake.org/cmake/help/v3.1/command/add_definitions.html) è€Œä¸å¿…å»æ“ä½œå…¨å±€å˜é‡äº†ï¼š

```cmake
add_definitions(-DFOO -DBAR ...)
add_definitions(-std=c++11)     # CMake 2.8.11 or older
add_compile_options(-std=c++11) # CMake 2.8.12 or newer
```

å†åˆ°åæ¥æˆ‘ä»¬å¯ä»¥ä¸å¿…ä¸ºäº† c++11 å»ç›´æ¥æ“ä½œç¼–è¯‘å™¨é€‰é¡¹äº†ï¼š

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
# set(CMAKE_CXX_EXTENSIONS OFF)
```

ä½†å…¶å®ƒçš„æƒ…å†µï¼ˆé -std=c++11ï¼‰ä¾æ—§æ˜¯å¯ä»¥åˆ©ç”¨ add_compiler_options çš„ã€‚

åˆ°äº† Modern CMake æ—¶ä»£å‘¢ï¼Œå…¨å±€çš„ add_compiler_options è¢«æ¨èä»¥é¢å‘ target çš„æ–°æŒ‡ä»¤ [target_compile_features](https://cmake.org/cmake/help/latest/command/target_compile_features.html?highlight=target_compile_features)ï¼Œ[target_compile_definitions](https://cmake.org/cmake/help/latest/command/target_compile_definitions.html) ä»¥åŠ [target_compile_options](https://cmake.org/cmake/help/latest/command/target_compile_options.html) æ‰€æ›¿ä»£äº†ã€‚

```cmake
target_compile_features(${PROJECT_NAME} PRIVATE cxx_std_11)
```

åˆ©ç”¨ generator expression çš„æ”¯æŒï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å¾ˆå¥½åœ°è¿ç”¨å¤šç§æ„å»ºé…ç½®ã€‚ä¾‹å¦‚å½“ä½ æƒ³è¦æ”¯æŒ Debug å’Œ Release ä¸¤ç§æ„å»ºé…ç½®æ—¶ï¼Œå¯ä»¥å¯ç”¨ä¸‹é¢çš„è¯­å¥ï¼š

```cmake
set(MY_DEBUG_OPTIONS "-DDEBUG=1")
set(MY_RELEASE_OPTIONS "-DNDEBUG=1")

target_compile_options(foo PUBLIC "$<$<CONFIG:DEBUG>:${MY_DEBUG_OPTIONS}>")
target_compile_options(foo PUBLIC "$<$<CONFIG:RELEASE>:${MY_RELEASE_OPTIONS}>")
```





## å®ï¼Œå‡½æ•°

### å®ç”¨å·¥å…·

TODO

### è‡ªå®šä¹‰å®å’Œå‡½æ•°

åœ¨ `study-cmake` æ ·æœ¬é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ç³»åˆ—çš„ cmake å·¥å…·å‡½æ•°ï¼ˆè‡ªå®šä¹‰å®å’Œå‡½æ•°ï¼‰ï¼Œå®ƒä»¬è¢«ä»¥å¤šç§æ–¹å¼ç»„ç»‡åœ¨ `cmake` å­æ–‡ä»¶å¤¹ä¸­ã€‚

åœ¨ Source Tree æ ¹ç›®å½•çš„ `CMakeLists.txt` ä¸­æˆ‘ä»¬ä»¥ä¸€å®šçš„é¡ºåºåŠ è½½å®ƒä»¬ï¼Œä»è€Œæä¾›ä¸€ä¸ªè¾ƒä¸ºå®Œå¤‡çš„åŸºæœ¬ç¯å¢ƒâ€”â€”æ‰€ä»¥ä½ å¯ä»¥é‡ç‚¹è€ƒè™‘å¦‚ä½•åœ¨å­ç›®å½•çš„ `CMakeLists.txt` ä¸­é’ˆå¯¹ä½ çš„ Target ç¼–å†™æ„å»ºå¤„ç†è„šæœ¬ï¼Œè€Œä¸å¿…å…³å¿ƒæ„å»ºçš„æ•´ä½“æ¡†æ¶â€”â€”æ„å»ºè„šæœ¬çš„æ•´ä½“æ¡†æ¶ç°åœ¨å·²ç»å…·å¤‡äº†å¤§é‡çš„åŸºç¡€ç‰¹æ€§ã€‚

Source Tree æ ¹ç›®å½•çš„ `CMakeLists.txt` æ ·æœ¬ï¼š

```cmake
cmake_minimum_required(VERSION 3.9..3.19)
set(CMAKE_SCRIPTS "cmake")
set(CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/modules;${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS};${CMAKE_SOURCE_DIR};${CMAKE_MODULE_PATH}")
include(prerequisites)
include(version-def)
include(add-policies)     # ${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/
include(detect-systems)
include(target-dirs)
include(utils)


project(study-cmake
        VERSION ${VERSION}
        DESCRIPTION "study for cmake"
        LANGUAGES C CXX)

include(cxx-standard-def)
include(cxx-detect-compilers)
include(setup-build-env)
include(versions-gen)

debug_print_top_vars()


# add_subdirectory(third-party/catch)
# add_subdirectory(src)
# add_subdirectory(test)

# add_library(study_cmake library.cxx library.h)


debug_print_value(CMAKE_RUNTIME_OUTPUT_DIRECTORY)

add_subdirectory(z01-hello-1)
add_subdirectory(z02-library-1)
add_subdirectory(z03-library-2)
add_subdirectory(z04-header-library)

add_subdirectory(z11-m1)
```





## ä¸‹è½½æ–‡ä»¶

### FetchContent

TODO

[FetchContent](https://cmake.org/cmake/help/latest/module/FetchContent.html) å¯ç”¨äºä¸‹è½½è¿œç¨‹æ–‡ä»¶ï¼Œgit repo ç­‰è¿œç¨‹å¯¹è±¡ã€‚



## ä¸‹è½½è¿œç¨‹é¡¹ç›®

cmake ç°åœ¨æ”¯æŒ [ExternalProject](https://cmake.org/cmake/help/latest/module/ExternalProject.html) ( [src](https://github.com/Kitware/CMake/blob/master/Modules/ExternalProject.cmake) ) ç‰¹æ€§ï¼Œå…è®¸ä½ ç›´æ¥ä»è¿œç¨‹æœåŠ¡å™¨ä¸‹è½½é¡¹ç›®å¹¶åµŒå…¥å½“å‰é¡¹ç›®ä¸­ã€‚è¿™ç§æ–¹æ¡ˆå¾ˆå¥½åœ°è§£å†³äº†ç¬¬ä¸‰æ–¹ä¾èµ–åº“çš„ä¾èµ–é—®é¢˜ã€‚

### ExternalProject

å…¸å‹çš„ç”¨æ³•æ˜¯ä» githubï¼ˆæˆ–è€…å…¶å®ƒ git æœåŠ¡å•†ï¼‰ï¼š

```cmake
ExternalProject_Add(foobar
  GIT_REPOSITORY git@github.com:FooCo/FooBar.git
  GIT_TAG        origin/release/1.2.3
  STEP_TARGETS   build
)
```

ä¹Ÿå¯ä»¥ä» source tarballï¼š

```cmake
find_program(MAKE_EXE NAMES gmake nmake make)
ExternalProject_Add(secretsauce
  URL               http://intranet.somecompany.com/artifacts/sauce-2.7.tgz
                    https://www.somecompany.com/downloads/sauce-2.7.zip
  URL_HASH          MD5=d41d8cd98f00b204e9800998ecf8427e
  CONFIGURE_COMMAND ""
  BUILD_COMMAND     ${MAKE_EXE} sauce
)
```

[ExternalProject](https://cmake.org/cmake/help/latest/module/ExternalProject.html) çš„è¯­æ³•çœ‹èµ·æ¥ç›¸å½“å¤æ‚ï¼Œä¸è¿‡é‚£æ˜¯å› ä¸ºå„ç§æ¥æºæœ‰ç€å„è‡ªçš„ä¸‹è½½å’Œç¼–è¯‘å‚æ•°éœ€æ±‚ï¼Œå®é™…ä¸Šè¿ç”¨èµ·æ¥è¿˜æ˜¯æ²¡æœ‰ä»€ä¹ˆéš¾åº¦çš„ã€‚

å¯¹äºé‚£äº›æ”¯æŒ modern cmake é£æ ¼çš„é¡¹ç›®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ BUILD_COMMAND/COMMAND æ—¶ä½¿ç”¨ cmake æ„å»ºå‘½ä»¤è¡Œè¯­æ³•ï¼Œç”šè‡³å¯ä»¥ï¼š

```cmake
ExternalProject_Add(example
  ... # Download options, etc.
  BUILD_COMMAND ${CMAKE_COMMAND} -E echo "Starting $<CONFIG> build"
  COMMAND       ${CMAKE_COMMAND} --build <BINARY_DIR> --config $<CONFIG>
  COMMAND       ${CMAKE_COMMAND} -E echo "$<CONFIG> build complete"
)
```



## ä½¿ç”¨ OPTION

[option]() æŒ‡ä»¤æä¾›ä¸€ä¸ªå¼€å…³é‡ï¼Œå¦‚æœä½ åœ¨å‘½ä»¤è¡Œä¸­æ˜¾å¼å®šä¹‰äº†è¯¥å¼€å…³é‡çš„è¯ï¼Œåˆ™ä»¥å‘½ä»¤è¡Œä¸­å®šä¹‰çš„å€¼ï¼Œå¦åˆ™çš„è¯ option æŒ‡ä»¤æ‰€æŒ‡å®šçš„é»˜è®¤å€¼è¢«åº”ç”¨ã€‚ä¾‹å¦‚ï¼š

```cmake
option(ENABLE_BOOST "Enable Boost" ON)

if(ENABLE_BOOST)
  set(BOOST_STRING "foo")
endif()

configure_file(config.h.in config.h)
```

ä½ é€šè¿‡ `cmake -DENABLE_BOOST=OFF` çš„æ–¹å¼å¯ä»¥æŒ‡ç¤º ENABLE_BOOST ä¸º false å€¼ï¼Œé‚£æ ·çš„è¯ï¼ŒLine 3 çš„æ£€æµ‹å°±ä¸ä¼šè¢«é€šè¿‡äº†ã€‚

åœ¨å¾ˆå¤šå¤§å‹ä»£ç åº“ä¸­ï¼Œå€ŸåŠ©è¿™ç§æ–¹å¼èƒ½å¤Ÿä¸ºä»£ç åº“çš„æ„å»ºæä¾›çµæ´»çš„é…ç½®ã€‚ä¾‹å¦‚ï¼š

```cmake
option(BUILD_SHARED_LIBS "Build DOLFIN with shared libraries." ON)
option(CMAKE_USE_RELATIVE_PATHS "Use relative paths in makefiles and projects." OFF)
option(DOLFIN_AUTO_DETECT_MPI "Detect MPI automatically (turn this off to use the MPI compiler wrappers directly via setting CXX, CXX, FC)." ON)
option(DOLFIN_ENABLE_CODE_COVERAGE "Enable code coverage." OFF)
option(DOLFIN_WITH_LIBRARY_VERSION "Build with library version information." ON)
option(DOLFIN_ENABLE_TESTING "Enable testing." OFF)
option(DOLFIN_ENABLE_GTEST "Enable C++ unit tests with Google Test if DOLFIN_ENABLE_TESTING is true (requires Internet connection to download Google Test when first configured)." ON)
option(DOLFIN_ENABLE_BENCHMARKS "Enable benchmark programs." OFF)
option(DOLFIN_ENABLE_DOCS "Enable generation of documentation." ON)
option(DOLFIN_SKIP_BUILD_TESTS "Skip build tests for testing usability of dependency packages." OFF)
option(DOLFIN_DEPRECATION_ERROR "Turn deprecation warnings into errors." OFF)
option(DOLFIN_IGNORE_PETSC4PY_VERSION "Ignore version of PETSc4py." OFF)

...
```









## å…¶å®ƒç¼–è¯‘å™¨

åœ¨ä½¿ç”¨ cmake æ—¶ï¼ŒCC è¿™æ ·çš„ç¯å¢ƒå˜é‡å¾ˆéš¾å¥æ•ˆäº†ã€‚è¿œå¤æ—¶æˆ‘ä»¬éƒ½æ˜¯é€šè¿‡ `CC=/usr/devel/gcc-9/bin/g++ ./configure` çš„æ–¹å¼æ¥ä½¿èƒ½ä¸€ä¸ªéç³»ç»Ÿé»˜è®¤çš„ç¼–è¯‘å™¨çš„ã€‚ä½†å¯¹äº cmake æ¥è¯´ï¼Œä¸‹é¢çš„æ–¹æ³•æ‰èƒ½è¾¾åˆ°ç›¸ä¼¼çš„ç›®çš„ï¼š

```bash
cmake -DCMAKE_C_COMPILER=/usr/local/opt/bin/gcc -DCMAKE_CXX_COMPILER=/usr/local/opt/bin/g++ ...
```



















ğŸ”š