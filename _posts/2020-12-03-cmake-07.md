---
layout: single
title: 'cmake 07 - z11_m1 ç»†èŠ‚'
date: 2020-12-03 23:07:00 +0800
last_modified_at: 2020-12-03 23:07:00 +0800
Author: hedzr
tags: [c++, cmake-hello, cmake, build, testing, CTest, CDash, modern cmake, cmake tutorial, cmake examples]
categories: cmake notes
comments: true
toc: true
header:
  teaser: /assets/images/unsplash-image-11.jpg
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  Modern CMake Tutorial ç›¸å…³ï¼Œz11_m1 å­é¡¹ç›®çš„ç»†èŠ‚ ...
---



> æŒ‰ï¼š
>
> è¿™ä¸ªç³»åˆ—ä¸ cmake æœ‰å…³çš„è®°å½•ä¹Ÿå¥½ï¼Œç¬”è®°ä¹Ÿå¥½ï¼Œæˆä¹¦ä¹Ÿå¥½ï¼Œç›®å‰æš‚ä¸”å½’å±åœ¨ [cmake-hello](/tags/#cmake-hello) æ ‡è®°ä¹‹ä¸‹ã€‚
>
> æºç è¯·è®¿é—®ï¼š
> > <https://github.com/hedzr/study-cmake>  
> > è¯·æ³¨æ„æºç ä»åœ¨è·Ÿéšæˆ‘çš„ç¬”è®°å†…å®¹çš„è¿­ä»£è€Œæ›´æ–°ä¸­ã€‚





æˆ‘ä»¬åšäº†è¾£ä¹ˆå¤šçš„å‡†å¤‡å·¥ä½œäº†ï¼Œæ—©å°±æƒ³è¦ä»‹å…¥å…·ä½“é¡¹ç›®çš„ç¼–å†™å·¥ä½œäº†ã€‚





## `z11-m1`

ä»¥å‰æˆ‘ä»¬åšäº† z01 åˆ° z04 ç­‰ä¸€ç»„ä»¥ä¼ ç»Ÿ cmake é£æ ¼ç¼–å†™çš„å…·ä½“é¡¹ç›®ï¼Œç°åœ¨æˆ‘ä»¬å°†è¦å¼€å§‹åä¸º z11-m1 çš„æ–°çš„å­é¡¹ç›®ï¼Œå®ƒåŒ…å«è‡³å°‘ä¸€ä¸ª library Targetï¼Œä»¥åŠä½¿ç”¨è¿™ä¸ª library çš„ç›¸åº”çš„ executablesã€‚

é¦–å…ˆæˆ‘ä»¬æ€»è§ˆä¸€ä¸‹ z11-m1 çš„ç›®å½•ç»“æ„ï¼š

![image-20201124152515280](https://i.loli.net/2020/11/26/ERZqnO2U38GgcFL.png)

åœ¨æˆªå›¾é‡Œæ²¡æœ‰å±•ç°ä¸Šçº§ç›®å½•ï¼ˆå³ study-cmake çš„æ ¹ç›®å½•ï¼‰ï¼Œå› ä¸ºç°åœ¨æˆ‘ä»¬åªå…³å¿ƒä¸‹çº§å­ç›®å½•ä¸­çš„è¿™äº›å­é¡¹ç›®åº”è¯¥æ€ä¹ˆå¸ƒå±€ã€‚

ä½ å·²ç»çœ‹åˆ°äº†æˆ‘ä»¬çš„ `z11-m1` åŒ…å« app, app-auto, libs/sm-lib è¿™å‡ ä¸ªå­ç›®å½•ï¼Œå¹¶ä¸”å…¨éƒ½æœ‰ä¸€ä¸ª `CMakeLists.txt` è´Ÿè´£æ·»åŠ å’Œç®¡ç†å„è‡ªçš„ä¸‹çº§å­ç›®å½•ã€‚



### `z11-m1/CMakeLists.txt`

`z11-m1/CMakeLists.txt` çš„å†…å®¹æ˜¯ï¼š

```cmake
cmake_minimum_required(VERSION 3.5..3.19)
set(CMAKE_SCRIPTS "../cmake")
set(CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/modules;${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS};${CMAKE_SOURCE_DIR};${CMAKE_SOURCE_DIR}/..;${CMAKE_MODULE_PATH}")
include(prerequisites)
include(version-def)
include(add-policies)     # ${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/
include(detect-systems)
#include(target-dirs)
include(utils)


project(z11-m1)

include(cxx-standard-def)

add_subdirectory(libs/sm-lib)
add_subdirectory(app-auto)
# add_subdirectory(app)

```

è¿™äº›ä»£ç ä¸å¤æ‚ï¼Œä¸ºäº†èƒ½å¤Ÿä¸ä¾é  study-cmake çš„é¡¶çº§ CMakeLists.txt æ‰€æä¾›çš„åŸºæœ¬ç¯å¢ƒä¹Ÿèƒ½ç‹¬ç«‹ç¼–è¯‘ app/ å­é¡¹ç›®ï¼Œæ‰€ä»¥ `z11-m1/CMakeLists.txt`  å†—ä½™äº†ç›¸åº”çš„åˆå§‹åŒ–ç»“æ„ï¼Œæ³¨æ„åœ¨è®¾ç½® `CMAKE_MODULE_PATH` æ—¶æœ‰çŸ«æ­£ `CMAKE_SCRIPTS` çš„å€¼ä»¥ä¿è¯èƒ½å¤Ÿæœç´¢åˆ°çˆ¶ç›®å½•ä¸­çš„ cmake/ æ–‡ä»¶å¤¹ã€‚

 `z11-m1/CMakeLists.txt`  çš„çœŸæ­£ç›®çš„åªæ˜¯åŒ…å« libs/sm-lib å’Œ app-auto å­é¡¹ç›®ã€‚



### `z11-m1/libs/sm-lib`

ç°åœ¨æˆ‘ä»¬è¦ç¼–å†™ä¸€ä¸ª libraryï¼Œä¸”ä»¤å…¶å…·æœ‰ Modern CMake çš„é£æ ¼ï¼Œä¸ä½†æ—¶ä¸€ä¸ªå…·æœ‰è‡ªæˆ‘æ„è¯†çš„ Targetï¼Œè€Œä¸”èƒ½å¤Ÿæä¾›è‡ªå·±çš„å®šä½ä¿¡æ¯ï¼Œå¯ä»¥å¾ˆå®¹æ˜“åœ°åµŒå…¥åˆ°ä¸€ä¸ª cmake hosted çš„æ„å»ºä¸»æœºç¯å¢ƒä¸­ã€‚

#### å®šä¹‰ project

é¦–å…ˆè¿˜æ˜¯çœ‹çœ‹ `CMakeLists.txt` çš„å†…å®¹ï¼Œå…¶å¼€å§‹éƒ¨åˆ†å¦‚ä¸‹ï¼š

```cmake
cmake_minimum_required(VERSION 3.5)
project(sm-lib VERSION 1.0.0 LANGUAGES CXX)
```

#### æŸ¥æ‰¾ package ï¼ˆä¾èµ–åº“ï¼‰

```cmake
find_package(ZLIB REQUIRED)

#if ( ZLIB_FOUND )
#    include_directories( ${ZLIB_INCLUDE_DIRS} )
#    target_link_libraries( YourProject ${ZLIB_LIBRARIES} )
#endif( ZLIB_FOUND )

#if (ZLIB_FOUND)
#    debug_print_value(ZLIB_INCLUDE_DIRS)
#    debug_print_value(ZLIB_LIBRARIES)
#endif ()
```

æˆ‘ä»¬ä¼šæŸ¥æ‰¾ zlib package çš„å®‰è£…ä¿¡æ¯ï¼ˆåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­å®ƒåº”è¯¥éƒ½æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœæ²¡æœ‰ï¼Œä½ å¯èƒ½éœ€è¦ apt install zlib1-dev è¿™æ ·çš„å‘½ä»¤å»å®‰è£…å®ƒï¼‰ã€‚

åƒ zlib è¿™æ ·çš„ package å¹¶ä¸éœ€è¦åšåˆ° Modern CMake é£æ ¼å…¼å®¹ï¼Œå› ä¸ºå®ƒå®åœ¨æ˜¯å¤ªå¸¸è§äº†ï¼Œè€Œä¸”å®ƒè¢«ä½œä¸ºå„ç§å‘è¡Œç‰ˆçš„ bundle ç»„æˆå…ƒç´ ä¹‹ä¸€çš„å†å²ç”šè‡³è¿œè¶…è¿‡ cmakeã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦ `find_package(ZLIB REQUIRED)` æŒ‡ä»¤å»æŸ¥æ‰¾ zlib çš„å®‰è£…ä½ç½®ã€‚å¹¶ä¸”æˆ‘ä»¬ä¹Ÿéœ€è¦å°†æŸ¥æ‰¾çš„ç»“æœåŠ å…¥åˆ° Target Properties ä¸­ã€‚

> æ›´å¤šå…³äºæŸ¥æ‰¾ package çš„å†…å®¹åœ¨åé¢ç« èŠ‚ä¸“é—¨è®¨è®ºã€‚



#### å®šä¹‰ sm-lib Target

```cmake
add_library(${PROJECT_NAME})
add_library(libs::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

target_compile_features(${PROJECT_NAME} PRIVATE cxx_std_11)
target_sources(${PROJECT_NAME} PRIVATE src/${PROJECT_NAME}.cc)
target_link_libraries(${PROJECT_NAME} PRIVATE ${ZLIB_LIBRARIES})
target_include_directories(${PROJECT_NAME}
        PUBLIC
          $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
          $<INSTALL_INTERFACE:include>
        PRIVATE
          ${ZLIB_INCLUDE_DIRS}
        )
```

æ¥ä¸‹æ¥æˆ‘ä»¬é€šè¿‡ `add_library(${PROJECT_NAME})` å£°æ˜åä¸º sm-lib çš„ Library Targetã€‚

è¯·æ³¨æ„ä¸‹ä¸€è¯­å¥ `add_library(libs::${PROJECT_NAME} ALIAS ${PROJECT_NAME})` ä¸º sm-lib Library Target å»ºç«‹ä¸€ä¸ªåˆ«å `libs::sm-lib`ã€‚è¿™ä¸ªåˆ«åå¾ˆé‡è¦ï¼Œå®ƒç¬¦åˆæˆ‘ä»¬å»ºç«‹çš„ libs/sm-lib æ–‡ä»¶å¤¹ç»“æ„ï¼Œå› ä¸º `app-auto` å­æ¨¡å—å°†ä¼šé€šè¿‡æ­¤åˆ«åç›´æ¥å¼•ç”¨ sm-libã€‚ç†è®ºä¸Šè¯´ï¼Œå†…éƒ¨çš„ä¾èµ–å…³ç³»æ˜¯å¯ä»¥ç›´æ¥ä½¿ç”¨ sm-lib è¿™ä¸ª Target åå­—æ¥è§£å†³çš„ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨ `libs::` åå­—ç©ºé—´å¯ä»¥å…·æœ‰æ›´å¥½çš„å¯è¯»æ€§ã€‚

æ¥ä¸‹æ¥çš„ target_xxx è¯­å¥è´Ÿè´£ä¸º sm-lib Library Target è®¾å®šCXXæ ‡å‡†ã€æºæ–‡ä»¶ã€é“¾å…¥ä¾èµ–åº“ä»¥åŠåŒ…å«æ–‡ä»¶æœç´¢è·¯å¾„ï¼š

- `${ZLIB_LIBRARIES}` å’Œ `${ZLIB_INCLUDE_DIRS}` æ˜¯ `find_package(ZLIB)` çš„ç»“æœã€‚

  - `${ZLIB_LIBRARIES}` ä½œä¸ºé“¾æ¥ä¾èµ–åº“ï¼Œå¯¹ä½¿ç”¨è€…é€æ˜ï¼Œæ‰€ä»¥é‡‡ç”¨äº† PRIVATE é™å®šã€‚
  - åŒæ ·é“ç†ï¼Œ`${ZLIB_INCLUDE_DIRS}` åœ¨ `target_include_directories` ä¸­ä¹Ÿæ˜¯è¢« PRIVATE æ‰€ä¿®é¥°çš„ã€‚

- é‡‡ç”¨ `PRIVATE` é™å®šçš„æºæ–‡ä»¶æ˜¯å› ä¸º sm-lib çš„ cpp æ–‡ä»¶å¯¹äºä½¿ç”¨è€…æ¥è¯´æ˜¯æ— æ„ä¹‰çš„ã€‚sm-lib ç¼–è¯‘ååªæœ‰å¤´æ–‡ä»¶å’Œ .a æ–‡ä»¶å°†è¢«åˆ†å‘ç»™ä½¿ç”¨è€…ã€‚

- å°†è¢«å…¬å¸ƒç»™ç±»åº“ä½¿ç”¨è€…çš„å¤´æ–‡ä»¶ï¼Œä¹Ÿå³é‡‡ç”¨ PUBLIC å®£å‘Šçš„æœ‰ï¼š

  - `$<INSTALL_INTERFACE:include>` æ˜¯ä¸€ä¸ª generator expressionï¼Œå®ƒæ„å‘³ç€ install-tree ä¸­çš„`include` ç›®å½•ä¼šè¢«åŒ…å«åœ¨å¤´æ–‡ä»¶æœç´¢è·¯å¾„ä¸­ã€‚

  - `$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>` æ˜¯ä¸€ä¸ª generator expressionï¼Œå®ƒæ„å‘³ç€ build-tree ä¸­çš„ sm-lib/include æ–‡ä»¶å¤¹ï¼Œå°†è¢«åŒ…å«åœ¨å¤´æ–‡ä»¶æœç´¢è·¯å¾„ä¸­ã€‚

  - ä¸ºäº†èƒ½å¤Ÿåœ¨ä¸¤ç§åœºæ™¯ä¸‹éƒ½èƒ½æ­£ç¡®åœ°å®Œæˆå¤´æ–‡ä»¶æœç´¢å¹¶æ­£ç¡®ç¼–è¯‘ sm-lib åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åŒæ—¶å£°æ˜ä»¥ä¸Šä¸¤æ¡è®°å½•ã€‚

    å…¶ä¸­ `$<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>`  å°†ä¼šåœ¨åº“ä½œè€…ç¼–è¯‘ app-auto æ—¶èµ·ä½œç”¨ï¼Œè¿™æ—¶å®é™…ä¸Šæ˜¯ä¸€ç§å†…éƒ¨åº“å¼•ç”¨å…³ç³»ã€‚

    è€Œ`$<INSTALL_INTERFACE:include>` æ˜¯æä¾›ç»™ sm-lib çš„ä½¿ç”¨è€…çš„ï¼Œå› ä¸ºå¯¹äºä½¿ç”¨è€…æ¥è¯´ï¼Œsm-lib çš„å¤´æ–‡ä»¶å°†ä¼šè¢«å®‰è£…åœ¨ `${CMAKE_INSTALL_PREFIX}/include/sm-lib` ã€‚`include` ä¹‹æ‰€ä»¥ä¸å¸¦æœ‰ CMAKE_INSTALL_PREFIX å‰ç¼€ï¼Œæ˜¯ä¸ºäº†è®© cmake èƒ½å¤Ÿæ ¹æ®å®é™…æƒ…å†µè§£å†³å‰ç¼€ï¼Œå³æ‰€è°“çš„ [Relocatable Package](https://cmake.org/cmake/help/latest/manual/cmake-packages.7.html#creating-relocatable-packages)ã€‚



#### åŠ å…¥æµ‹è¯•èŠ‚

```cmake
if (BUILD_TESTING)
    message("tests enabled")
    add_subdirectory(tests)
endif ()
```

æˆ‘ä»¬ä¼šåœ¨ä¸€ä¸ªå­ç›®å½• `tests` ä¸­ç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼ˆå­é¡¹ç›®ï¼‰ã€‚

å…·ä½“çš„å†…å®¹äº¤ç”± Testing ç« èŠ‚è¯¦è§£ã€‚

> ç”±äº CTest è¦æ±‚ add_test åº”è¯¥æ˜¯åŸºäºä¸€ä¸ª executable æ‰èƒ½é™„ç€ï¼Œæ‰€ä»¥åœ¨ sm-lib ä¸Šæˆ‘ä»¬å¹¶ä¸èƒ½ç›´æ¥é€šè¿‡ add_test çš„æ–¹å¼ä¸ºå…¶å»ºç«‹æµ‹è¯• Targetã€‚
>
> å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œæˆ‘ä»¬æ˜¯åœ¨ app-auto æ¨¡å—ä¸­å»ºç«‹ç›¸åº”çš„ test target æ¥å¯¹ sm-lib åšå•å…ƒæµ‹è¯•çš„ã€‚



#### åŠ å…¥å®‰è£…æ–¹æ¡ˆ

ç°åœ¨åŠ å…¥å®‰è£…è„šæœ¬ç”¨äºå°† sm-lib å®‰è£…åˆ°ç›®æ ‡ä½ç½®ã€‚

é¦–å…ˆæˆ‘ä»¬è¦äº†è§£çš„æ˜¯ CMAKE_INSTALL_PREFIX æ˜¯æ‰€è°“çš„ install-tree ç›®æ ‡ä½ç½®ã€‚ä¸€ä¸ª Library çš„å…¬å¼€å¤´æ–‡ä»¶å°†è¢«å®‰è£…åˆ° `<prefix>/include`ï¼Œåº“æ–‡ä»¶ï¼ˆ.aï¼‰å°†è¢«å®‰è£…åˆ° `<prefix>/lib` ï¼ˆå¯¹äºä¸åŒçš„å‘è¡Œç‰ˆä¸åŒçš„å¤„ç†å™¨æ¶æ„ï¼Œä¹Ÿå¯èƒ½å®‰è£…åˆ° `<prefix>/lib64` ç­‰ç­‰ä½ç½®ï¼‰ã€‚å¦å¤–å¦‚æœä½ æƒ³è¦ï¼Œè¿˜å¯ä»¥æä¾› man æ‰‹å†Œï¼Œé™„åŠ æ–‡ä»¶ç­‰ç­‰ã€‚

##### install æŒ‡ä»¤

[`install`](https://cmake.org/cmake/help/latest/command/install.html) æ˜¯ä¸€ä¸ªè§„åˆ™ç»„ï¼Œå¯ç”¨äºæŒ‡å®šå®‰è£…æ—¶åˆ»å°†ä¼šè¢«è¿è¡Œçš„è§„åˆ™ã€‚

è¿™äº›è§„åˆ™åŒ…æ‹¬ï¼›

```cmake
install(TARGETS <target>... [...])
install({FILES | PROGRAMS} <file>... [...])
install(DIRECTORY <dir>... [...])
install(SCRIPT <file> [...])
install(CODE <code> [...])
install(EXPORT <export-name> [...])
```

å®ƒä»¬çš„ç²¾ç¡®è¯­æ³•å·²ç»ä½¿ç”¨ç»†èŠ‚å¯ä»¥æŸ¥çœ‹å®˜ç½‘æ–‡æ¡£ã€‚

##### æˆ‘ä»¬çš„å®ä¾‹

æˆ‘ä»¬ä¸º sm-lib è¿™æ ·å®‰æ’å…¶å®‰è£…æ–¹æ¡ˆï¼š

```cmake
install(TARGETS ${PROJECT_NAME}
        EXPORT ${PROJECT_NAME}Targets
        LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
        ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
        )

install(EXPORT ${PROJECT_NAME}Targets
        FILE ${PROJECT_NAME}Targets.cmake
        NAMESPACE ${PROJECT_NAME}::
        DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/${PROJECT_NAME})

install(DIRECTORY include/${PROJECT_NAME}
        DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
        )

install(FILES
        ${CMAKE_CURRENT_LIST_DIR}/cmake/${PROJECT_NAME}Config.cmake
        DESTINATION
        ${CMAKE_INSTALL_LIBDIR}/cmake/${PROJECT_NAME})
```



ç†è§£æˆ‘ä»¬ç¼–å†™çš„å®‰è£…è§„åˆ™é›†ä¹Ÿå¾ˆå®¹æ˜“ï¼š

- ç¬¬ä¸€æ¡å‘½ä»¤å®šä¹‰äº† sm-lib åº“ è¿™ä¸ª Target å…·æœ‰ä¸€ä¸ªæ§åˆ¶æ–‡ä»¶ï¼Œåä¸º sm-libTargets.cmake ã€‚æ­¤å¤–æˆ‘ä»¬ä¹ŸæŒ‡å®š install-tree ä¸ç›®æ ‡æœºæ–‡ä»¶å¤¹çš„ç›¸å¯¹å…³ç³»ï¼Œåœ¨è¿™é‡Œå®é™…ä¸Šæˆ‘ä»¬æŒ‡æ˜äº† install-tree çš„æ ¹ç›®å½•åº”è¯¥ç­‰ä»·äº `${CMAKE_INSTALL_LIBDIR}`ã€‚ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä¹ŸæŒ‡æ˜äº†åº“çš„æ„å»ºç»“æœå°†è¢«å®‰è£…åˆ°ä½•å¤„ï¼š

  - ARCHIVE DESTINATION è¡¨ç¤ºé™æ€åº“çš„å®‰è£…ä½ç½®ï¼Œå¦å¤–ï¼ŒåŠ¨æ€åº“éƒ½ä¼šå…·æœ‰ä¸€ä¸ª import lib ç”¨äºé“¾æ¥ç›®çš„ï¼Œä¹Ÿä¼šè¢«å®‰è£…åˆ°è¯¥ä½ç½®
  - LIBRARY DESTINATION è¡¨ç¤ºåŠ¨æ€åº“ï¼Œä¾‹å¦‚ .so, .dylib, .dll ç­‰ï¼Œçš„å®‰è£…ä½ç½®
  - åŠ¨æ€åº“æˆ–é™æ€åº“éƒ½æ˜¯åœ¨æ„å»ºä¸­ç”Ÿæˆçš„ï¼Œå®ƒä»¬éƒ½æ˜¯æœ¬ Target çš„æ„å»ºç»“æœ

  > ä½ å¯ä»¥æŒ‡å®šä¸åŒçš„ install-tree æ ¹ç›®å½•ï¼Œä¾‹å¦‚ /temp/x86 ä¹‹ç±»ï¼Œè¿™æ˜¯è¢«å…è®¸çš„ï¼Œå°½ç®¡å®ƒä¸ç¬¦åˆ GNU è·¯å¾„è§„èŒƒï¼Œå¯èƒ½å½±å“åˆ°å…¼å®¹æ€§ã€‚

  > æ³¨æ„ CMAKE_INSTALL_DIR ä¸åŠ é™å®šæ—¶ï¼Œæˆ‘ä»¬éƒ½è®¤ä¸ºå®ƒå…·æœ‰é»˜è®¤å€¼ `/usr/local`

- ç¬¬äºŒæ¡å‘½ä»¤æè¿°äº†æˆ‘ä»¬çš„ sm-libTargets.cmake åº”è¯¥è¢«å®‰è£…åˆ° install-tree ä¸­ä½•å¤„è¢«æ‰¾åˆ°ã€‚å½“å‰çš„é…ç½®æŒ‡å®šäº†ä¼šå®‰è£…åˆ° `${CMAKE_INSTALL_LIBDIR}/cmake/${PROJECT_NAME}`ï¼Œå…¸å‹çš„çœŸå®è·¯å¾„å¸¸å¸¸æ˜¯ `/usr/local/cmake/sm-lib/sm-libTargets.cmake`ã€‚

  æ­¤å¤–ä¹ŸæŒ‡æ˜äº†åº”è¯¥ä½¿ç”¨ â€œsm-libâ€ ä½œä¸ºå…¶åå­—ç©ºé—´ã€‚

  å› æ­¤ï¼Œåº“çš„ä½¿ç”¨è€…é€šè¿‡ cmake å¼•ç”¨ sm-lib æ—¶ï¼Œå°†ä¼šé‡‡ç”¨ `sm-lib::sm-lib` è¿™ä¸ªå…¨é™å®šåã€‚å…·ä½“ç”¨æ³•è¯·å‚è€ƒ `app` é¡¹ç›®ä¸­çš„å¼•ç”¨è¯­å¥ã€‚

- ç¬¬ä¸‰æ¡å‘½ä»¤è¡¨ç¤ºè¯´æˆ‘ä»¬éœ€è¦å®‰è£… sm-lib çš„å…¬å¼€å¤´æ–‡ä»¶åˆ° install-tree çš„å¤´æ–‡ä»¶ç›®å½•ä¸­ã€‚æ­¤å¤„çš„ `include/${PROJECT_NAME}` ä»£è¡¨ç€ source-tree ä¸­çš„ sm-lib æ–‡ä»¶å¤¹ä¸­çš„ include/sm-lib å­ç›®å½•ã€‚

- ç¬¬å››æ¡å‘½ä»¤è´Ÿè´£å°† source-tree ä¸­çš„ sm-libConfig.cmake å¤åˆ¶åˆ° install-tree ä¸­ã€‚`sm-libConfig.cmake` æ˜¯æˆ‘ä»¬ä½œä¸ºåº“ä½œè€…éœ€è¦ç»´æŠ¤å’Œç¼–å†™çš„ä¸€ä¸ªæ§åˆ¶æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«åœ¨ç›®æ ‡æœºä¸Šæˆ‘ä»¬çš„åº“è¢«å®‰è£…åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œåº”è¯¥è¢«å¦‚ä½•æ‰¾åˆ°ã€‚

ç”±äºæ²¡æœ‰æ¶‰åŠåˆ°æ–‡æ¡£æ„å»ºï¼Œman æ‰‹å†Œæ„å»ºï¼Œä»¥åŠé¡¹ç›®é™„åŠ æ–‡ä»¶çš„å®‰è£…é—®é¢˜ï¼Œå› ä¸ºå½“å‰åªéœ€è¦ä¸Šé¢åˆ—ä¸¾çš„å››æ¡ install æŒ‡ä»¤å°±è¶³ä»¥å®Œæˆåº“çš„å®‰è£…ä¸åˆ†å‘äº†ã€‚





> æˆ‘ä»¬æ²¡æœ‰ç»™å‡ºå…³äº executable çš„ installing å®ä¾‹ï¼Œä½†å®ƒå¹¶ä¸æ¯” library Target çš„ install è„šæœ¬æ›´éš¾ï¼Œå› è€Œå½“å‰é™äºç²¾åŠ›å°±æš‚ä¸”æç½®äº†ã€‚

> ä½ å¯èƒ½å·²ç»æ³¨æ„åˆ°åœ¨ internal-library å’Œ external-library çš„å¼•ç”¨åç§°ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸åŒçš„åå­—ç©ºé—´ï¼šåœ¨ internal-library å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ `libs::sm-lib` åå­—ï¼Œè¯·æŸ¥é˜… å®šä¹‰ sm-lib Target ç« èŠ‚ï¼›åœ¨ external-library å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ `sm-lib::sm-lib` åå­—ã€‚è¿™æ ·åšæœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ã€‚ä½†ä½ å¯ä»¥è‡ªè¡Œå†³å®šä½ çš„å‘½åç­–ç•¥ã€‚



##### æˆ‘ä»¬çš„ sm-libConfig.cmake

åœ¨ libs/sm-lib/cmake å­ç›®å½•ä¸­ï¼Œæˆ‘ä»¬å‡†å¤‡äº† `sm-libConfig.cmake` æ§åˆ¶æ–‡ä»¶ï¼š

```cmake
include(CMakeFindDependencyMacro)
find_dependency(ZLIB REQUIRED)

## Import the targets
if (NOT TARGET sm-lib::sm-lib)
  include("${CMAKE_CURRENT_LIST_DIR}/sm-libTargets.cmake")
endif ()
```

å¯¹äºä¸€ä¸ªé™æ€åº“æ¥è¯´ï¼Œéœ€è¦åšçš„äº‹å¹¶ä¸å¤šï¼Œæˆ‘ä»¬åªéœ€è¦è§£å†³å†…éƒ¨å¯¹ ZLIB çš„ä¾èµ–å³å¯ã€‚

è¿™ä¸ªæ–‡ä»¶åœ¨ç¬¬å››æ¡ install æŒ‡ä»¤è§„åˆ™ä¸­è¢«å®šä¹‰ä¸ºä» source-tree å¤åˆ¶åˆ° install-treeã€‚







## Testing ç›¸å…³ - CTest

> åˆ©ç”¨ CTest è¿›è¡Œå•å…ƒæµ‹è¯•

- ctest(1) - <https://cmake.org/cmake/help/latest/manual/ctest.1.html>
- CTest Module - <https://cmake.org/cmake/help/latest/module/CTest.html#module:CTest>
- [Testing With CTest](https://gitlab.kitware.com/cmake/community/-/wikis/doc/ctest/Testing-With-CTest)

CTest æ˜¯ CMake çš„å†…å»ºå·¥å…·ã€‚

ä½ å¯ä»¥åœ¨å‘½ä»¤è¡Œç›´æ¥æ‰§è¡Œ `ctest --help`ã€‚ä½†åœ¨ä¸€ä¸ªé¡¹ç›®å·¥ç¨‹ä¸­ï¼Œæ›´ä¾¿åˆ©çš„æ–¹æ³•æ˜¯ï¼š

```bash
cmake --build build/ --target test
```





### ç®€ä»‹

[`enable_testing`](https://cmake.org/cmake/help/latest/command/enable_testing.html) ä¸ºå½“å‰ç›®å½•åŠå…¶æ‰€æœ‰å­ç›®å½•å¯ç”¨æµ‹è¯•èƒ½åŠ›ã€‚æ‰€è°“çš„æµ‹è¯•èƒ½åŠ›æ˜¯ç”± [`CTest`](https://cmake.org/cmake/help/latest/module/CTest.html#module:CTest)  module æä¾›çš„ã€‚å¦‚æœä½ æ‰§è¡Œäº† `include(CTest)` æŒ‡ä»¤ï¼Œåˆ™ [`enable_testing`](https://cmake.org/cmake/help/latest/command/enable_testing.html) å·²ç»è¢«è‡ªåŠ¨æ‰§è¡Œäº†ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä¸€ä¸ª OPTION å˜é‡ `BUILD_TESTING` æ¥åˆ¤å®šå¯ç”¨ä¸å¦ã€‚ä¸è¿‡åè¿‡æ¥ä¸€æ ·æˆç«‹ï¼Œå¦‚æœä¸åŠ ä»¥é¢å¤–è®¾ç½®ï¼Œåœ¨ enable_testing() ä¹‹åï¼ŒCTest å°±å·²ç»å¤„äºå·²è½½å…¥å°±ç»ªçš„çŠ¶æ€ã€‚

```cmake
include(CTest)
if(BUILD_TESTING)
  # ... CMake code to create tests ...
  message("tests enabled")
  add_subdirectory(tests)
endif()
```



ä¸€æ—¦å¯ç”¨äº†æµ‹è¯•èƒ½åŠ›ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ [add_test](https://cmake.org/cmake/help/latest/command/add_test.html) æŒ‡ä»¤æ¥æ·»åŠ æµ‹è¯•å‘½ä»¤è¡Œã€‚add_test æŒ‡ä»¤çš„è¯­æ³•ä¸ºï¼š

```cmake
add_test(NAME <name> COMMAND <command> [<arg>...]
         [CONFIGURATIONS <config>...]
         [WORKING_DIRECTORY <dir>]
         [COMMAND_EXPAND_LISTS])
```

æˆ‘ä»¬å¯ä»¥è¿™æ ·ç¼–å†™å®ä¾‹ï¼š

```cmake
add_test(NAME mytest
         COMMAND testDriver --config $<CONFIGURATION>
                            --exe $<TARGET_FILE:myexe>)
```

æˆ–è€…å½“æˆ‘ä»¬æœ‰ä¸€ä¸ª executable æ—¶ä¸ºå…¶é™„åŠ ä¸€ä¸ªtestï¼š

```cmake
project(app)
add_executable(app main.cc)

enable_testing()
add_subdirectory(tests)

# in tests/CMakeLists.txt

project(app_test)
add_executable(app_test test.cc)
add_test(app_test app)
```



> `ctest`æä¾›äº†ä¸°å¯Œçš„å‘½ä»¤è¡Œå‚æ•°ã€‚å…¶ä¸­ä¸€äº›å†…å®¹å°†åœ¨ä»¥åçš„ç¤ºä¾‹ä¸­æ¢è®¨ã€‚è¦è·å¾—å®Œæ•´çš„åˆ—è¡¨ï¼Œéœ€è¦ä½¿ç”¨`ctest --help`æ¥æŸ¥çœ‹ã€‚å‘½ä»¤`cmake --help-manual ctest`ä¼šå°†å‘å±å¹•è¾“å‡ºå®Œæ•´çš„ctestæ‰‹å†Œã€‚*



### study-cmake ä¸­çš„ shortcut

åœ¨ study-cmake é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç®€åŒ–äº†å’Œ testing ç›¸å…³çš„å†…å®¹ï¼Œå› æ­¤å¯¹äº z11-m1/app-auto å­æ¨¡å—æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•åœ°åœ¨å…¶ CMakeLists.txt åŠ å…¥å¦‚ä¸‹æŒ‡ä»¤æ¥ä½¿èƒ½ CTestï¼š

```cmake
project(sm-app-auto
        VERSION 1.0.0
        LANGUAGES CXX)
add_executable(sm-app-auto main.cc)
...
if (BUILD_TESTING)
    add_unit_test(${PROJECT_NAME} tests sm_lib_app_tests)
endif ()
```

ç„¶åæˆ‘ä»¬åœ¨  z11-m1/app-auto ä¸­åŠ å…¥ tests å­ç›®å½•å’Œç›¸åº”çš„æµ‹è¯•ä»£ç ï¼Œæµ‹è¯•ä»£ç è¢«æŒ‚æ¥åœ¨ sm_lib_app_tests è¿™ä¸ª Target ä¸­å½¢æˆäº†ä¸€ä¸ª executableï¼Œç›¸åº”çš„ tests/CMakeLists.txt ä¸ºï¼š

```cmake
cmake_minimum_required(VERSION 3.5)
project(sm_lib_app_tests)

add_executable(${PROJECT_NAME}
        main.cc
        )

target_link_libraries(${PROJECT_NAME}
        PRIVATE
        libs::sm-lib
        )
```

ä½ å¯ä»¥æ³¨æ„åˆ° tests å­ç›®å½•æ²¡æœ‰ä»»ä½•ç‰¹æ®Šçš„ CTest å†…å®¹ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ªç®€å•çš„ executable  Target è€Œå·²ã€‚

æ‰€æœ‰çš„å·¥ä½œéƒ½éšè—åœ¨ app-auto ä¸­çš„ `add_unit_test(${PROJECT_NAME} tests sm_lib_app_tests)` æŒ‡ä»¤é‡Œã€‚

ç„¶åæˆ‘ä»¬æ„å»ºæ•´ä¸ªé¡¹ç›®æˆåŠŸä¹‹åï¼ŒCTest æµ‹è¯•æµç¨‹å°†è¢«è‡ªåŠ¨è°ƒç”¨è€Œæ— éœ€äººå·¥ä»‹å…¥ï¼Œä½ ä¹Ÿä¸å¿…å…³å¿ƒä»€ä¹ˆæ ·çš„å‘½ä»¤è¡Œæ‰èƒ½å¯åŠ¨ ctestã€‚

#### èƒŒæ™¯

è¿™ä¸€åˆ‡æœ‰èµ–äºè¿™äº›é¢„å…ˆé…ç½®çš„å†…å®¹ï¼š

##### cmake/prerequisites.cmake

åœ¨ prerequisites.cmake ä¸­æˆ‘ä»¬æœ‰ä¸€ç»„ CTest åˆå§‹åŒ–æŒ‡ä»¤ï¼š

```cmake
# for testing
set(ENV{CTEST_OUTPUT_ON_FAILURE} 1)
set_property(GLOBAL PROPERTY UNIT_TEST_TARGETS)
mark_as_advanced(UNIT_TEST_TARGETS)
enable_testing()
# include(CTest)
```

##### cmake/utils.cmake

åœ¨ utils.cmake ä¸­æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå®æŒ‡ä»¤ï¼š`add_unit_test` å’Œ `apply_all_unit_tests`ã€‚

```
add_unit_test(target target_dirname target_test)
```

`add_unit_test` æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œtarget_test æ˜¯æµ‹è¯•ç”¨ä¾‹çš„ Target åå­—ï¼Œä¹Ÿå°±æ˜¯ "sm_lib_app_tests"ï¼Œtarget æ˜¯ä¸Šçº§ executable çš„ Target åå­—ï¼Œä¹Ÿå°±æ˜¯ "sm-app-auto"ï¼Œæˆ‘ä»¬ç”¨äº† `${PROJECT-NAME}` æ¥éšè—è¯¥ç¡¬ç¼–ç çš„å­—ç¬¦ä¸²ï¼Œtarget_dirname æ˜¯ tests å­ç›®å½•çš„åå­—ã€‚

`add_unit_test` ä¼šå°† target_dirname æ‰€æŒ‡ç¤ºçš„å­ç›®å½•é€šè¿‡ `add_subdirectory` æŒ‡ä»¤åŠ è½½è¿›æ¥ï¼Œç„¶åç”¨ add_test æŒ‡ä»¤å°† target_test æŒ‚æ¥åˆ° target ä¹‹ä¸Šï¼Œç„¶åæ³¨å†Œ target_test çš„åå­—ã€‚

##### CMakeLists.txt

åœ¨ source-tree æ ¹ç›®å½•çš„ CMakeLists.txt çš„æœ«å°¾ï¼Œæˆ‘ä»¬æœ‰ä¸€æ¡æŒ‡ä»¤è°ƒç”¨ï¼š

```cmake
# invoke CTest unittests automatically.
apply_all_unit_tests(all_tests)
```

é€šè¿‡ add_unit_test æ³¨å†Œçš„æ‰€æœ‰ target_test(s) åœ¨æ­¤æ—¶è¢«ç¼–åˆ¶ä¸º CTest å‘½ä»¤è¡Œï¼Œäº¤ç»™ POST_BUILD å»æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°äº†è‡ªåŠ¨æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹çš„æ•ˆæœã€‚



#### å°ç»“

æˆ‘ä»¬çš„è¿™ä¸€å¥—è£…å¤‡ä¸ç®—å¤æ‚ï¼Œä½†å¾ˆæœ‰æ•ˆåœ°è§£å†³äº†åˆå­¦è€…é¢å¯¹ CTest æ—¶å¯èƒ½é‡åˆ°çš„å„ç§åƒå¥‡ç™¾æ€ªçš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œç­‰åˆ°ä½ è¿ˆè¿‡è¿™ä¸ªé˜¶æ®µæ—¶ï¼Œè¿˜æ˜¯æœ‰å¿…è¦å»ç ”ç©¶ CTest ç›¸å…³æ–‡æ¡£ï¼Œåšåˆ°æ·±å…¥ç†è§£å’Œè‡ªå®šä¹‰ä¹Ÿä¸å›°éš¾ã€‚å¦å¤–ä¸€ç‚¹ï¼Œé¡¹ç›®å˜å¾—å¤§å‹äº†ä¹‹åï¼Œæ¯æ¬¡ build æ—¶éƒ½æ‰§è¡Œå…¨éƒ¨æµ‹è¯•ç”¨ä¾‹ï¼Œé‚£ä¹Ÿæ˜¯ç›¸å½“æµªè´¹ç”Ÿå‘½çš„ï¼Œæ­¤æ—¶ä½ éœ€è¦æŒæ¡ ctest å‘½ä»¤è¡Œçš„èƒ½åŠ›ï¼Œä»¥ä¾¿èƒ½å¤Ÿæœ‰é€‰æ‹©åœ°æ‰§è¡Œéƒ¨åˆ†ç”¨ä¾‹ï¼Œæˆ–è€…åœ¨ build æ—¶ç¦ç”¨å•å…ƒæµ‹è¯•è¿è¡Œã€‚

å¯¹äºæˆ‘ä»¬çš„ shortcut æ¥è¯´ï¼Œæ³¨é‡Šæ‰ apply_all_unit_tests æŒ‡ä»¤è¡Œå°±èƒ½è¾¾åˆ°ç¦ç”¨çš„ç›®çš„äº†ã€‚



### å…¶å®ƒæµ‹è¯•å·¥å…·

#### CDash

CDash æ˜¯ CMake æä¾›çš„ä¸ CTest é…å¥—çš„å·¥å…·ï¼Œå®ƒæ˜¯ä¸€ä¸ªweb æœåŠ¡å™¨ï¼ŒCTest çš„ç»“æœå¯ä»¥ä¼ é€’ç»™å®ƒä¹‹ååœ¨ web é¡µé¢ä¸Šæ˜¾ç¤ºä¸€ä¸ª Dashboardï¼Œå¯è§†åŒ–æ•ˆæœè¾ƒä½³ã€‚

ä¸è¿‡ä½ éœ€è¦ docker å®‰è£…å®ƒå¹¶è¿è¡Œæ‰è¡Œã€‚æˆ–è€…ä½ å¯ä»¥ä½¿ç”¨ CMake æä¾›çš„åœ¨çº¿ CDash æœåŠ¡ï¼š[https://my.cdash.org](https://my.cdash.org/)ã€‚

CMake Cookbook ä¸­ä»‹ç»äº†æœ‰å…³å†…å®¹ï¼Œè¯·è‡ªè¡Œæœç´¢å¹¶ç ”ç©¶ã€‚



#### å…¶å®ƒæµ‹è¯•å·¥å…·

Catch2

Google Test

Boost Test

è¿™äº›éƒ½æ˜¯æœ‰è§„æ¨¡çš„æµ‹è¯•å·¥å…·











ğŸ”š