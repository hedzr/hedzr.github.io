---
layout: single
title: 'cmake 05 - Basics - Part II'
date: 2020-11-24 10:23:00 +0800
last_modified: 2020-11-24 10:23:00 +0800
Author: hedzr
tags: [c++, cmake-hello, cmake, build, basics]
categories: cmake notes
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-11.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  CMake ç›¸å…³ï¼ŒBasics Part IIï¼šå˜é‡ã€ç”Ÿæˆå¼è¡¨è¾¾å¼ã€å…¶å®ƒ...
---



> æŒ‰ï¼š
>
> è¿™ä¸ªç³»åˆ—ä¸ cmake æœ‰å…³çš„è®°å½•ä¹Ÿå¥½ï¼Œç¬”è®°ä¹Ÿå¥½ï¼Œæˆä¹¦ä¹Ÿå¥½ï¼Œç›®å‰æš‚ä¸”å½’å±åœ¨ [cmake-hello](/tags/#cmake-hello) æ ‡è®°ä¹‹ä¸‹ã€‚



> **æŒ‰**ï¼š
>
> å½“å‰å…ˆæœŸå‡†å¤‡ç½—åˆ—å†…å®¹ï¼Œä½†ä»Šåå¯èƒ½ä¼šè¿›ä¸€æ­¥å¡«å……ä»¥ä¾¿ä»¤å…¶ä¸è‡³äºä»…ä»…æˆä¸ºä¸€ä¸ªå®˜æ–¹æ–‡æ¡£çš„è¯‘æœ¬ã€‚  
>
> ---
>
> æ­¤åå„ç« èŠ‚å†…å®¹å¹¶ä¸æ˜¯æŒ‰ç…§ä¸€æœ¬å‚è€ƒæ‰‹å†Œçš„å½¢å¼æ¥ç¼–å†™çš„ï¼Œè€Œæ˜¯åŸºäºä¸€ä¸ªæ¨¡æ¿å‹é¡¹ç›®è¿›è¡Œä»‹ç»ï¼Œä½†å°½åŠ›åšåˆ°æ¶µç›–é¢è¶…è¿‡ 50% è€Œä¸æ˜¯åƒä¸€èˆ¬çš„å…¥é—¨é¡µé¢é‚£æ ·æœ€å¤šæ¶‰åŠåˆ° 10% çš„å†…å®¹ã€‚  
>
> å¦‚æœä½ æƒ³è¦é˜…è¯»å–œé—»ä¹è§çš„å…¥é—¨é¡µé¢ä»¥æ±‚å¿«é€Ÿå¼€å§‹çš„è¯ï¼Œå¯ä»¥é˜…è¯»æ­¤å‰çš„å‡ ä¸ªç« èŠ‚ï¼Œé‚£é‡Œæ˜¯æŒ‰ç…§ Getting Started çš„é£æ ¼ç¼–å†™çš„ã€‚

---

è¿™é‡Œæ˜¯åŸºæœ¬è¯­æ³•ç¬¬äºŒéƒ¨åˆ†ï¼ŒåŒ…æ‹¬å˜é‡çš„è§£è¯´ï¼Œä»¥åŠä¸€äº›é™„åŠ å†…å®¹ã€‚









## å˜é‡

å˜é‡çš„åˆ›å»ºæ— éœ€å£°æ˜è¯­å¥ï¼Œé€šè¿‡ `set` æŒ‡ä»¤å¯ä»¥ä¸€æ¬¡æ€§å®Œæˆå¹¶ä¸ºå˜é‡åè®¾ç½®ä¸€ä¸ªå€¼ã€‚

### æ•°æ®ç±»å‹

å€¼çš„æ•°æ®ç±»å‹ä¸æ•æ„Ÿï¼Œåªæœ‰*å¸ƒå°”å€¼*ã€*å­—ç¬¦ä¸²*å’Œ*å­—ç¬¦ä¸²åˆ—è¡¨*ç­‰å‡ ç§ç±»å‹ã€‚

#### å¸ƒå°”å€¼

ä»¥ä¸‹è¿™äº›ä¼šè¢«è§†ä¸º FALSEï¼š

- OFF
- FALSE
- N
- NO
- 0
- "" (ç©ºä¸²)
- æ²¡è¢«æŒ‡æ´¾å€¼çš„å˜é‡
- NOTFOUND
- ä»»ä½•ç»“å°¾æ˜¯ -NOTFOUND çš„å­—ç¬¦ä¸²


ä»¥ä¸‹è¿™äº›ä¼šè¢«è§†ä¸º TRUE:

- ON
- TRUE
- Y
- YE
- YES
- 1
- å…¶ä»–ä¸å½’ç±»ä¸º FALSE çš„å­—ç¬¦ä¸²



#### å­—ç¬¦ä¸²

å­—ç¬¦ä¸²æ— éœ€å¼•å·åŒ…å›´ï¼Œå…¶ç•Œå®šæœ‰èµ–äºæŒ‡ä»¤çš„æ‹¬å·åŒ…å›´ã€‚

æ•°å­—è¡¨ç¤ºçš„å­—é¢é‡ä¾ç„¶æ˜¯å­—ç¬¦ä¸²ï¼Œcmake ä¸­æ²¡æœ‰æ‰€è°“çš„æ•°å€¼ç±»å‹ã€‚

```cmake
set(A foo)
set(B bar)
set(C "this is foo bar")
set(D 3.14159)
```

ä»¥ä¸Šå…¨éƒ½æ˜¯å­—ç¬¦ä¸²ã€‚

å¸¦æœ‰ç©ºç™½çš„å­—ç¬¦ä¸²å¿…é¡»ä»¥å¼•å·åŒ…å›´ï¼Œé˜²æ­¢è¢«è§†ä½œå­—ç¬¦ä¸²åˆ—è¡¨â€”â€”é™¤éä½ æƒ³è¦çš„æ­£æ˜¯å­—ç¬¦ä¸²åˆ—è¡¨ã€‚



#### å­—ç¬¦ä¸²åˆ—è¡¨

åœ¨ cmake ä¸­ï¼Œå­—ç¬¦ä¸²åˆ—è¡¨æ˜¯ä¸åŒäºå­—ç¬¦ä¸²çš„æ•°æ®ç±»å‹ï¼šç”±ç©ºç™½æˆ–è€…åˆ†å·åˆ†éš”çš„å­—ç¬¦ä¸²å½¢å¼è¢«è§†ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨ã€‚ä½ å¯ä»¥å°†å­—ç¬¦ä¸²åˆ—è¡¨æƒ³è±¡ä¸ºä¸€ä¸ª token æ•°ç»„ã€‚

è¯·æ³¨æ„ä»¥ä¸‹è¯­å¥å®Œå…¨ç­‰æ•ˆï¼š

```cmake
set(foo this is a list)
set(foo this;is;a;list)
```

foo å˜é‡çš„å®é™…å€¼å°†ä¼šæ˜¯ thisï¼Œisï¼Œaï¼Œlist å››ä¸ª token çš„æ•°ç»„å½¢å¼ã€‚

å­—ç¬¦ä¸²åˆ—è¡¨æœ‰åˆ©äºå¾ªç¯æ“ä½œï¼š

```cmake
foreach(f ${foo})
    message(${f})
endforeach(f)
```

è¿™å°†ä¼šéå† foo è¿™ä¸ª token æ•°ç»„åæ‰“å°æ¯ä¸ª tokenã€‚



### Quoted

æœ‰çš„æ—¶å€™ç”¨å¼•å·åŒ…å›´ä¸€ä¸ªå­—ç¬¦ä¸²æœ‰åŠ©äºè§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š

1. é¿å…æ­§ä¹‰
2. é˜²æ­¢å¸¦æœ‰ç©ºç™½çš„å­—ç¬¦ä¸²è¢«åˆ†è§£ä¸ºå­—ç¬¦ä¸²åˆ—è¡¨ç±»å‹



### Escaped

åœ¨æƒ³è¦é¿å…å˜é‡æ±‚å€¼çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨è½¬ä¹‰è¯­æ³•ï¼š

```cmake
message("\${foo} = ${foo}")
```

æ­¤å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `\t`, `\n` ç­‰ C é£æ ¼çš„è½¬ä¹‰å­—ç¬¦ã€‚



### å®šä¹‰å˜é‡

> å˜é‡åæ˜¯åŒºåˆ†å¤§å°å†™çš„ï¼

[set](https://cmake.org/cmake/help/latest/command/set.html) å‘½ä»¤çš„æ ¼å¼å¦‚ä¸‹ï¼š

```cmake
# è®¾ç½®å˜é‡
set(var value... [PARENT_SCOPE])

# è®¾ç½®ç¼“å­˜æ¡ç›®
set(var value... [CACHE BOOL|FIELPATH|PATH|STRING|INTERNAL <docstring> [FORCE]])

# è®¾ç½®ç¯å¢ƒå˜é‡
set(ENV{var} [value])
```

è¯¦ç»†æ–‡æ¡£è¯·æŸ¥é˜…å®˜ç½‘ã€‚

ç”±äº function/macro çš„æ¼”è¿›åŸå› ï¼Œè®¾ç½®å˜é‡å€¼æ—¶å¯ä»¥å¸¦ä¸Šåç¼€ `PARENT_SCOPE`ï¼Œè¿™æ˜¯ä¸“ç”¨äºåœ¨æŸä¸ª function/macro ä¸­ä¿®æ”¹ä¸Šçº§è°ƒç”¨è€…çš„å˜é‡çš„ç‰¹åˆ«æ‰‹æ®µã€‚



### æ£€æµ‹å˜é‡åæœ‰å¦è¢«å®šä¹‰è¿‡

```cmake
if(DEFINED var|CACHE var|end{var})
```



### å˜é‡æ±‚å€¼

å¼•ç”¨ä¸€ä¸ªå˜é‡æ˜¯é€šè¿‡ `${var}` çš„æ–¹å¼æ¥å±•å¼€çš„ï¼Œè¿™è¢«ç§°ä½œå˜é‡çš„æ±‚å€¼æ€§å±•å¼€ã€‚å˜é‡çš„å±•å¼€å¯ä»¥é€’å½’è¿›è¡Œï¼Œæ‰€ä»¥åµŒå¥—çš„ `$` è¡¨è¾¾å¼æ˜¯åˆæ³•ä¸”æœ‰æ•ˆçš„ã€‚ä¾‹å¦‚ï¼š

```cmake
set(var hello)
set(foo var)

message(${foo})
message(${${foo}})
# å°†ä¼šå¾—åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š
# var
# hello
```



#### æ•°å­¦è®¡ç®—

cmake ä¸­æ²¡æœ‰æ•°å€¼ç±»å‹ï¼Œå› è€Œä¹Ÿæ²¡æœ‰æ•°å€¼è®¡ç®—çš„è¿ç®—ç¬¦ã€‚

å½“éœ€è¦æ•°å­¦è®¡ç®—æ—¶å¯ä»¥å€ŸåŠ© math æŒ‡ä»¤æ¥å®Œæˆï¼š

```cmake
math(EXPR var "1 + 2 * 3")
message("var = ${var}")
```



#### é€šé…ç¬¦

TODO

> Glob æŒ‡ä»¤ä¸è¢«å»ºè®®ä½¿ç”¨ã€‚



#### æ­£åˆ™å¼è®¡ç®—

string æŒ‡ä»¤å…·æœ‰æ­£åˆ™å¼åŒ¹é…çš„è®¡ç®—èƒ½åŠ›ï¼š

```cmake
set(TEXT "ab,cc,df,gg")
string(REGEX MATCHALL "((.)\\2)" RESULT "${TEXT}")
message("Result: ${RESULT}") 
```

æ­¤å¤–ï¼Œif æŒ‡ä»¤ä¹Ÿæœ‰ç›¸ä¼¼çš„èƒ½åŠ›ï¼š

```cmake
if(<variable|string> MATCHES regex)
```

è¿˜æœ‰ä¸€äº›åœºæ™¯ï¼ˆwhileï¼‰å…·æœ‰æ­£åˆ™å¼çš„æ”¯æŒï¼Œä½ å¯ä»¥åœ¨ä½¿ç”¨æ—¶æŸ¥é˜…æŸä¸€æŒ‡ä»¤çš„å®˜æ–¹æ–‡æ¡£æ¥è·å¾—è¯¦æƒ…ã€‚



CMake çš„æ­£åˆ™å¼å…·æœ‰å¦‚ä¸‹çš„è¯­æ³•ï¼š

- `^` åŒ¹é…ä¸€è¡Œæˆ–ä¸€å­—ç¬¦ä¸²å¼€å¤´
- `$` åŒ¹é…ä¸€è¡Œæˆ–ä¸€å­—ç¬¦ä¸²ç»“å°¾
- `.` åŒ¹é…å•ä¸€å­—ç¬¦æˆ–ä¸€ä¸ªæ–°è¡Œ
- `[ ]` åŒ¹é…æ‹¬å·ä¸­çš„ä»»ä¸€å­—ç¬¦
- `[^ ]` åŒ¹é…ä¸åœ¨æ‹¬å·å†…çš„ä»»ä¸€å­—ç¬¦
- `[-]` åŒ¹é…æŒ‡å®šèŒƒå›´å†…çš„å­—ç¬¦
- `*` åŒ¹é…0æ¬¡æˆ–å¤šæ¬¡
- `+` åŒ¹é…ä¸€æ¬¡æˆ–å¤šæ¬¡
- `?` åŒ¹é…0æ¬¡æˆ–ä¸€æ¬¡
- `()` ä¿å­˜åŒ¹é…çš„è¡¨è¾¾å¼å¹¶ç”¨éšåçš„æ›¿æ¢å®ƒ





### ç¼“å­˜

å˜é‡ç°åœ¨å…·æœ‰ä½œç”¨åŸŸèŒƒå›´ã€‚

ä½ ä»¥å‰çŸ¥é“çš„éƒ½æ˜¯å…¨å±€å˜é‡ï¼Œä¾‹å¦‚ä½ åœ¨ä½¿ç”¨ set åšå˜é‡å®šä¹‰æ—¶æ€»ä¼šå»ºç«‹ä¸€ä¸ªå…¨å±€å˜é‡ã€‚

ä½†ç°åœ¨æƒ…å†µå·²æœ‰æ‰€ä¸åŒï¼š

- åœ¨ function ä¸­çš„ set è¯­å¥åªä¼šå£°æ˜ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼ˆlocal-scopeï¼‰ã€‚

- åœ¨ä¸€ä¸ª CMakeLists.txt ä¸­å£°æ˜çš„å˜é‡æ˜¯ directory-scope çš„ï¼Œå®ƒä»¬å¹¶ä¸èƒ½è‡ªåŠ¨è¢«å¸¦å…¥ add_subdirectory æ‰€å¼•å…¥çš„è„šæœ¬ä¹‹ä¸­ã€‚

- é€šè¿‡ `PARENT_SCOPE` åç¼€èƒ½å¤Ÿå‘ä¸Šè®¿é—®/æ“ä½œ/ä¿®æ”¹åˆ°ä¸Šçº§ä½œç”¨åŸŸä¸­çš„å˜é‡ã€‚

  ä¾‹å¦‚ä¸Šçº§ç›®å½•ä¸­çš„ `CMakeLists.txt` çš„è„šæœ¬ï¼Œæˆ–è€… function çš„è°ƒç”¨è€…ã€‚

- é€šè¿‡ CACHE æ–¹å¼ set ä¸€ä¸ªå˜é‡ï¼Œåˆ™è¯¥å˜é‡å¯ä»¥è·¨è¶Šç›®å½•çº§åˆ«çš„ä½œç”¨åŸŸé™å®š

- ä½¿ç”¨ mark_as_advance(var) æ ‡è®°ä¸€ä¸ªå˜é‡ä»¤å…¶å…·æœ‰å…¨å±€ä½œç”¨åŸŸã€‚

æ‰€è°“çš„ç¼“å­˜å˜é‡ï¼ŒæŠ€æœ¯ä¸Šè®²æ˜¯æŒ‡è¢«æŒä¹…åŒ–å­˜å‚¨åœ¨ `CMakeCache.txt` ä¸­çš„å˜é‡ã€‚å®ƒå¾ˆæœ‰ç”¨ï¼Œä½†ä¼˜å…ˆçº§è¾ƒä½ï¼šæ™®é€šçš„æ­£å¸¸çš„åŒåå˜é‡ä¼šæ©ç›–ï¼ˆshadowï¼‰ç¼“å­˜å˜é‡ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä»å‘½ä»¤è¡Œä¼ é€’å˜é‡æ–°å€¼æ¥æ”¹å˜å®ƒã€‚ç”±äº IDE çš„å­˜åœ¨ï¼Œç¼“å­˜å˜é‡ä¹Ÿæ˜¯è®©ä½ å¯ä»¥æå‰å‡†å¤‡å˜é‡é»˜è®¤å€¼çš„ä¸€ç§æ‰‹æ®µã€‚

ç¤ºä¾‹1ï¼š

```cmake
set(LIB_A_PATH "/some/default/path" CACHE PATH "Path to lib A")
```

å¦‚æœä½ åœ¨åå¤æ“ä½œä¸€ä¸ªç¼“å­˜å˜é‡ï¼Œè¯·æ³¨æ„é™¤äº†é¦–æ¬¡setä¹‹å¤–ï¼Œä»Šåçš„ set æ“ä½œé™¤éå¸¦æœ‰ FORCE åç¼€ï¼Œå¦åˆ™éƒ½ä¸ä¼šè¢«æŒä¹…åŒ–åˆ°ç¼“å­˜ä¸­ï¼›æ­¤å¤–ï¼ŒFORCE è¿˜ä¼šä»å½“å‰èŒƒå›´ä¸­åˆ é™¤æ™®é€šå˜é‡ï¼Œå¦‚æœæœ‰çš„è¯ã€‚æ‰€ä»¥ï¼š

```cmake
cmake_minimum_required(VERSION 2.4)
project(VariablesTest)

set(VAR "CACHED-init" CACHE STRING "A test")
message("VAR = ${VAR}")

set(VAR "NORMAL")
message("VAR = ${VAR}")

set(VAR "CACHED" CACHE STRING "A test" FORCE)
message("VAR = ${VAR}")
```

**First Runçš„è¾“å‡º**

```
VAR = CACHED-init
VAR = NORMAL
VAR = CACHED
```

**ç¬¬äºŒè½®çš„è¾“å‡º**

```
VAR = CACHED
VAR = NORMAL
VAR = CACHED
```







### å±æ€§

#### æ¦‚è¿°

ä»€ä¹ˆæ˜¯å±æ€§ï¼Ÿ

æœ€æ°å½“çš„æ€è€ƒæ–¹å¼æ˜¯ï¼Œä¸€ä¸ªTargetå¯¹è±¡çš„æˆå‘˜å˜é‡å³ä¸ºå±æ€§ã€‚

æˆ‘ä»¬å·²ç»ç†è§£åˆ°ç°åœ¨æ¯ä¸ª Target éƒ½æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸Šé¢é™„ç€äº†ä¸€ç³»åˆ—çš„ä¸œè¥¿ï¼Œæ‰€ä»¥å±æ€§è¿™ç§ä¸œè¥¿æ˜¯å…¶ä¸€ï¼š

```cmake
add_library(${PROJECT_NAME})
add_library(libs::${PROJECT_NAME} ALIAS ${PROJECT_NAME})

target_compile_features(${PROJECT_NAME} PRIVATE cxx_std_11)
target_sources(${PROJECT_NAME} PRIVATE src/${PROJECT_NAME}.cc)
target_include_directories(${PROJECT_NAME}
        PUBLIC
          $<INSTALL_INTERFACE:include>
          $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>
        PRIVATE
          ${ZLIB_INCLUDE_DIRS}
        )
target_link_libraries(${PROJECT_NAME} PRIVATE ${ZLIB_LIBRARIES})
```

è‡³äºä»€ä¹ˆ include_directories å•¦ï¼Œpublic_headers å•¦ï¼Œç»Ÿç»Ÿéƒ½æ˜¯ target ä¸Šçš„ä¸€ä¸ªå±æ€§ã€‚



#### set_property

```cmake
set_property(TARGET TargetName
             PROPERTY CXX_STANDARD 11)
```



#### set_target_properties

å½“ä½ ä½¿ç”¨ [set_target_properties](https://cmake.org/cmake/help/latest/command/set_target_properties.html) æŒ‡ä»¤æ—¶ï¼Œå¤§é‡çš„ target_xxx æŒ‡ä»¤éƒ½å¯ä»¥è¢«æ”¾å¼ƒï¼Œå› ä¸º set_target_properties èƒ½å¤Ÿå°† target_xxx æŒ‡ä»¤ä¸€ç½‘æ‰“å°½ã€‚è¿™å…¶å®ä¹Ÿå¾ˆå¤æ‚ï¼Œæ‰€ä»¥è¯¥æ€ä¹ˆæ”¹å†™æ—§çš„ cmake è„šæœ¬ä»¥åŠå¦‚ä½•è¿ç”¨ set_target_properties æŒ‡ä»¤éœ€è¦æ—¶æ—¶å‚é˜…ï¼š[Properties on Targets](https://cmake.org/cmake/help/latest/manual/cmake-properties.7.html#target-properties)ã€‚å®é™…çš„ç”¨æ³•å¯ä»¥çœ‹å¦‚ä¸‹çš„æ ·æœ¬ï¼š

```cmake
set_target_properties(app
    PROPERTIES
    LINK_FLAGS          -static
    LINK_FLAGS_RELEASE  -s
    )
```

å°éƒ¨åˆ†çš„ target_xxx æŒ‡ä»¤å¯èƒ½ä¾ç„¶æ˜¯é‡è¦çš„ï¼Œä¸èƒ½è¢« set_target_properties æ‰€ç®€å•åœ°æ›¿ä»£ã€‚ä¾‹å¦‚ target_include_directories å’Œ target_link_libraries éƒ½å…·æœ‰å¯è§æ€§é™å®šï¼ˆPUBLICï¼ŒPRIVATEï¼ŒINTERACEï¼‰ï¼Œæ‰€ä»¥å¯¹äºåº“ä½œè€…æ¥è¯´è¿™äº›å¯è§æ€§å¯èƒ½ç›¸å½“é‡è¦ï¼Œç›®å‰åœ¨ cmake 3.19 ä¸­å®ƒä»¬ä»ç„¶æ— æ³•ä½¿ç”¨ set_target_properties æ¥å®Œæˆé™å®šã€‚

ä½†å°éƒ¨åˆ†ç‰¹ä¾‹ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œä¾‹å¦‚ INTERFACE çš„æ›¿ä»£å“ï¼š

```cmake
set_target_properties(Foo::bar PROPERTIES
    INTERFACE_COMPILE_FEATURES "cxx_std_14"
    INTERFACE_INCLUDE_DIRECTORIES "${_IMPORT_PREFIX}/include/"
    INTERFACE_SOURCES "${_IMPORT_PREFIX}/include/foo/bar.hpp"
)
```



#### å‚è€ƒ

 [cmake-properties(7) â€” CMake 3.19.0 Documentation](https://cmake.org/cmake/help/latest/manual/cmake-properties.7.html#id1) 



### ç¯å¢ƒå˜é‡

#### æ“ä½œç³»ç»Ÿç¯å¢ƒå˜é‡

`set(ENV{var} ...)` çš„æ–¹å¼å¯ä»¥è®¾ç½®ç¯å¢ƒå˜é‡ã€‚

ç±»ä¼¼åœ°ï¼Œ`ENV{var}` è¡¨è¾¾å¼èƒ½å¤Ÿè®¿é—®åˆ°æ“ä½œç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ã€‚

```cmake
message("$ENV{USER}")
```



#### cmake çš„ç¯å¢ƒå˜é‡

å¯¹äº cmake æ¥è¯´ï¼Œä¸€ç³»åˆ—ç‰¹æ®Šçš„å†…å»ºå˜é‡è¢«è®¤ä¸ºæ˜¯ cmake çš„æ‰€è°“ç¯å¢ƒå˜é‡ï¼Œä½ å¯ä»¥å‚è€ƒ [cmake-env-variables (7)](https://cmake.org/cmake/help/latest/manual/cmake-env-variables.7.html) æ¥è·å¾—æœ‰å…³è¯´æ˜ã€‚









### æ€»ç»“

CMake çš„å˜é‡ç³»ç»Ÿï¼Œç¼“å­˜ç‰¹æ€§æ˜¯è®¾è®¡å¾—æ¯”è¾ƒç¾éš¾çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªé•¿å‘¨æœŸå¼€æºé¡¹ç›®ä¸å¾—ä¸é¢å¯¹çš„é—®é¢˜ã€‚

è™½ç„¶æˆ‘ä»¬ä¼šé‡åˆ°å¾ˆå¤šä¸€å¼€å§‹è®¾è®¡å¾—å¾ˆå·®çš„ä½œå“ï¼Œåæ¥è™½ç„¶ä¹ŸæˆåŠŸäº†ï¼Œä½†è®¾è®¡ä¹‹åˆçš„è´¥ç¬”æ— æ³•è¢«ä¿®è¡¥æ‰€å¸¦æ¥çš„é—®é¢˜å¾€å¾€ä¼šæ³¢åŠåˆ°åæ¥çš„å¾ˆå¤šè®¾è®¡å†³å®šã€‚ä½† CMake èº«ä¸Šå‘ç”Ÿçš„äº‹æƒ…å¯èƒ½å¹¶ä¸é‚£ä¹ˆç®€å•ï¼šé‚£äº›ä¸€å¼€å§‹è®¾è®¡çš„å¾ˆæˆåŠŸå¾ˆè§„èŒƒä¸¥è°¨çš„é¡¹ç›®ï¼Œå´åˆæ²¡èƒ½æˆåŠŸåœ°å»¶ç»­ä¸‹æ¥çš„é¡¹ç›®ï¼Œå®åœ¨æ˜¯å¤ªå¤šäº†ã€‚

CMake ä¸€å¼€å§‹çš„è®¾è®¡æ˜¯æˆåŠŸçš„å—ï¼Ÿ

è¿™ä¸ªé—®é¢˜ï¼Œæˆ–è®¸ä¸ä¼šæœ‰äººèƒ½å¾—å‡ºè¶³ä»¥ä»¤å¤šæ•°äººè®¤å¯çš„ç»“è®ºã€‚

CMake ç°åœ¨çš„è®¾è®¡æ˜¯â€œç°ä»£â€çš„å—ï¼Ÿ

çœŸçš„ï¼Œæˆ‘ä¸èƒ½å›ç­”ä½ ã€‚è¿™å¤ªå›°éš¾äº†ï¼Œæƒ³è¦å›ç­”å®ƒçš„è¯ã€‚



æ­£å› ä¸º cmake ä¸­çš„é€»è¾‘å«æ··ã€æ¦‚å¿µå«æ··çš„åœ°æ–¹å¾ˆå¤šï¼Œå› è€Œåæ¥çš„ cmake æ‰ä¼šå¤§åŠ›æ¨è¡Œ Modern é£æ ¼ï¼Œå¹¶é¼“åŠ±æ–°çš„æƒ¯ç”¨æ³•ã€‚













## ç”Ÿæˆå¼è¡¨è¾¾å¼

CMake ä¼šåœ¨ä¸€å¼€å§‹è§£æ Source Tree ä¸­çš„ CMakeLists.txt å¹¶ç”Ÿæˆæ„å»ºé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ makefile ç­‰ç­‰ã€‚è¿™æ˜¯æˆ‘ä»¬å·²ç»çŸ¥é“çš„é˜¶æ®µä¸€çš„å†…å®¹ï¼Œç„¶åæˆ‘ä»¬ä¼šé€šè¿‡ cmake --build å‘½ä»¤æ‰§è¡Œæ„å»ºé˜¶æ®µï¼Œè¿™ä¸€é˜¶æ®µæ ¹æ®æˆ‘ä»¬çš„å¼€å‘è¿›åº¦å°†ä¼šè¢«åå¤è¿›è¡Œï¼Œè€Œé˜¶æ®µä¸€æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œé™¤éæˆ‘ä»¬ä¿®æ”¹äº† CMakeLists.txt çš„è„šæœ¬å†…å®¹ã€‚

ç”Ÿæˆå¼è¡¨è¾¾å¼ï¼ˆGenerator Expressionsï¼‰æ˜¯ç”± cmake å¼•å…¥çš„æ–°çš„ç‰¹æ€§ã€‚å®ƒçš„ç‰¹åˆ«ä¹‹å¤„åœ¨äºå…¶æ±‚å€¼åŠ¨ä½œå‘ç”Ÿåœ¨é˜¶æ®µä¸€å®Œæˆä¹‹åã€‚æˆ–è€…è¯´ï¼Œç”Ÿæˆå¼è¡¨è¾¾å¼åœ¨é˜¶æ®µä¸€çš„ç»“æŸæ—¶åˆ†æ‰ä¼šè¢«ç»Ÿä¸€æ±‚å€¼ã€‚ä¹‹æ‰€ä»¥è¦è¿™ä¹ˆåšï¼Œæ˜¯å› ä¸º cmake éœ€è¦è§£æå®Œæ‰€æœ‰çš„ CMakeLists.txt ä¹‹åæ‰èƒ½ç¡®å®šå…¨éƒ¨å˜é‡ã€Targets ç­‰çš„é…ç½®ç»“æœï¼Œè€Œç”Ÿæˆå¼è¡¨è¾¾å¼çš„æ±‚å€¼è®¡ç®—æ˜¯éœ€è¦è¿™ä¸ªé…ç½®ç»“æœçš„å‚ä¸çš„ï¼Œä¾‹å¦‚ Targets çš„æœ€ç»ˆå±æ€§å®šä¹‰ç­‰ã€‚

ç”Ÿæˆå¼è¡¨è¾¾å¼çš„åŒ…å«ä¸‰ç§ç±»å‹ï¼š

1. [é€»è¾‘è¡¨è¾¾å¼](https://cmake.org/cmake/help/v3.2/manual/cmake-generator-expressions.7.html#logical-expressions)
2. [ä¿¡æ¯è¡¨è¾¾å¼](https://cmake.org/cmake/help/v3.2/manual/cmake-generator-expressions.7.html#informational-expressions)
3. [è¾“å‡ºè¡¨è¾¾å¼](https://cmake.org/cmake/help/v3.2/manual/cmake-generator-expressions.7.html#output-expressions)

ç”Ÿæˆå¼è¡¨è¾¾å¼åŸºæœ¬å½¢å¼ä¸º `$<KEYWORD:value>`ï¼Œå®ƒä¼šå¯¹ KEYWORD æ±‚å€¼ã€‚



### é€»è¾‘è¡¨è¾¾å¼

é€»è¾‘è¡¨è¾¾å¼å°†è¢«è®¡ç®—ä¸º 0 æˆ– 1ï¼Œåœ¨ cmake ä¸­è¿™ä¹Ÿæ˜¯å¸ƒå°”é‡ TRUE å’Œ FALSE çš„å«ä¹‰ã€‚ç”±äºè¿™ä¸€åŸå› ï¼Œé€»è¾‘è¡¨è¾¾å¼å¸¸å¸¸è¢«åµŒå…¥å¦ä¸€è¡¨è¾¾å¼ä¸­ï¼Œä¾‹å¦‚ï¼š

```cmake
$<$<CONFIG:Debug>:DEBUG_MODE>
```

`$<CONFIG:Debug>` æ˜¯ä¸€ä¸ªé€»è¾‘è¡¨è¾¾å¼ï¼Œå®ƒä¼šæµ‹è¯•å½“å‰çš„æ„å»ºç±»å‹æ˜¯ debug è¿˜æ˜¯ releaseã€‚å¤–å±‚çš„è¡¨è¾¾å¼æ±‚å€¼çš„ç»“æœä¸ºï¼šå¦‚æœæ„å»ºç±»å‹ä¸º debugï¼Œåˆ™ç»“æœä¸º DEBUG_MODEï¼Œå¦åˆ™ä¸ºç©ºã€‚

å…¨éƒ¨æœ‰æ•ˆçš„é€»è¾‘è¡¨è¾¾å¼è¯­æ³•è¯·å‚è€ƒå®˜ç½‘ï¼š[é€»è¾‘è¡¨è¾¾å¼](https://cmake.org/cmake/help/v3.2/manual/cmake-generator-expressions.7.html#logical-expressions)

æœ€å…³é”®çš„ä¸¤ä¸ªé€»è¾‘è¡¨è¾¾å¼ä¸ºï¼š

```cmake
$<0:...>      è¿”å›ç©ºä¸²
$<1:...>      è¿”å› ...
$<BOOL:...>   BOOL è¡¨è¾¾å¼ä¸º1 åˆ™è¿”å› ...ï¼›å¦åˆ™è¿”å›ç©ºä¸²
```

`$<$<CONFIG:Debug>:DEBUG_MODE>` çš„æ±‚å€¼å°±æ˜¯å€ŸåŠ©ä¸Šè¿°çš„åŸºæœ¬å½¢å¼æ±‚å–å¤–å±‚å€¼çš„ã€‚

å…¶å®ƒå¸¸è§çš„é€»è¾‘è¡¨è¾¾å¼è¿˜åŒ…æ‹¬ï¼š

```cmake
$<AND:?[,?]...>
1 if all ? are 1, else 0

The ? must always be either 0 or 1 in boolean expressions.

$<OR:?[,?]...>
0 if all ? are 0, else 1

$<NOT:?>
0 if ? is 1, else 1

$<STREQUAL:a,b>
1 if a is STREQUAL b, else 0

$<EQUAL:a,b>
1 if a is EQUAL b in a numeric comparison, else 0

$<CONFIG:cfg>
1 if config is cfg, else 0. This is a case-insensitive comparison. The mapping in MAP_IMPORTED_CONFIG_<CONFIG> is also considered by this expression when it is evaluated on a property on an IMPORTED target.

$<PLATFORM_ID:comp>
1 if the CMake-id of the platform matches comp, otherwise 0.

$<C_COMPILER_ID:comp>
1 if the CMake-id of the C compiler matches comp, otherwise 0.

$<CXX_COMPILER_ID:comp>
1 if the CMake-id of the CXX compiler matches comp, otherwise 0.

$<VERSION_GREATER:v1,v2>
1 if v1 is a version greater than v2, else 0.

$<VERSION_LESS:v1,v2>
1 if v1 is a version less than v2, else 0.

$<VERSION_EQUAL:v1,v2>
1 if v1 is the same version as v2, else 0.

$<C_COMPILER_VERSION:ver>
1 if the version of the C compiler matches ver, otherwise 0.

$<CXX_COMPILER_VERSION:ver>
1 if the version of the CXX compiler matches ver, otherwise 0.

$<TARGET_POLICY:pol>
1 if the policy pol was NEW when the â€˜headâ€™ target was created, else 0. If the policy was not set, the warning message for the policy will be emitted. This generator expression only works for a subset of policies.

$<COMPILE_FEATURES:feature[,feature]...>
1 if all of the feature features are available for the â€˜headâ€™ target, and 0 otherwise. If this expression is used while evaluating the link implementation of a target and if any dependency transitively increases the required C_STANDARD or CXX_STANDARD for the â€˜headâ€™ target, an error is reported. See the cmake-compile-features(7) manual for information on compile features.
```

å®ƒä»¬çš„ç”¨é€”å’Œç”¨æ³•ä¸éš¾ä»¥ç†è§£ã€‚



### ä¿¡æ¯è¡¨è¾¾å¼

ä¿¡æ¯è¡¨è¾¾å¼è¢«æ±‚å€¼ä¸ºæŸäº›æ–‡å­—ã€‚æ±‚å€¼ç»“æœå¯ä»¥è¢«ç›´æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š

```cmake
include_directories(/usr/include/$<CXX_COMPILER_ID>/)
```

å…¶å«ä¹‰å¦‚åŒä½ çŒœæƒ³çš„é‚£æ ·ï¼Œå®ƒå¯ä»¥è¢«å±•å¼€ä¸ºå…·ä½“å€¼ï¼š`/usr/include/GNU/` or `/usr/include/Clang/` ç­‰ç­‰ã€‚

ä½ ä¹Ÿå¯ä»¥ç»„åˆä½¿ç”¨å®ƒä»¬ï¼š

```cmake
$<$<VERSION_LESS:$<CXX_COMPILER_VERSION>,4.2.0>:OLD_COMPILER>
```

æµ‹è¯•ä½ çš„ç¼–è¯‘å™¨ç‰ˆæœ¬å·ï¼ˆ[`CMAKE_CXX_COMPILER_VERSION`](https://cmake.org/cmake/help/v3.2/variable/CMAKE_LANG_COMPILER_VERSION.html#variable:CMAKE__COMPILER_VERSION)ï¼‰æ˜¯ä¸æ˜¯å°äº 4.2.0ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›ä¸€ä¸ªå­—ä¸²â€œOLD_COMPILERâ€ã€‚

æœ‰æ•ˆçš„ä¿¡æ¯è¡¨è¾¾å¼æœ‰ï¼š

```cmake
$<CONFIGURATION>
Configuration name. Deprecated. Use CONFIG instead.

$<CONFIG>
Configuration name

$<PLATFORM_ID>
The CMake-id of the platform. See also the CMAKE_SYSTEM_NAME variable.

$<C_COMPILER_ID>
The CMake-id of the C compiler used. See also the CMAKE_<LANG>_COMPILER_ID variable.

$<CXX_COMPILER_ID>
The CMake-id of the CXX compiler used. See also the CMAKE_<LANG>_COMPILER_ID variable.

$<C_COMPILER_VERSION>
The version of the C compiler used. See also the CMAKE_<LANG>_COMPILER_VERSION variable.

$<CXX_COMPILER_VERSION>
The version of the CXX compiler used. See also the CMAKE_<LANG>_COMPILER_VERSION variable.

$<TARGET_FILE:tgt>
Full path to main file (.exe, .so.1.2, .a) where tgt is the name of a target.
è¿”å› Target â€œtgtâ€ çš„ä¸»æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚ä¾‹å¦‚ '/home/ss/projects/aa/bin/aa.so'

$<TARGET_FILE_NAME:tgt>
Name of main file (.exe, .so.1.2, .a).

$<TARGET_FILE_DIR:tgt>
Directory of main file (.exe, .so.1.2, .a).

$<TARGET_LINKER_FILE:tgt>
File used to link (.a, .lib, .so) where tgt is the name of a target.

$<TARGET_LINKER_FILE_NAME:tgt>
Name of file used to link (.a, .lib, .so).

$<TARGET_LINKER_FILE_DIR:tgt>
Directory of file used to link (.a, .lib, .so).

$<TARGET_SONAME_FILE:tgt>
File with soname (.so.3) where tgt is the name of a target.

$<TARGET_SONAME_FILE_NAME:tgt>
Name of file with soname (.so.3).

$<TARGET_SONAME_FILE_DIR:tgt>
Directory of with soname (.so.3).

$<TARGET_PDB_FILE:tgt>
Full path to the linker generated program database file (.pdb) where tgt is the name of a target.

See also the PDB_NAME and PDB_OUTPUT_DIRECTORY target properties and their configuration specific variants PDB_NAME_<CONFIG> and PDB_OUTPUT_DIRECTORY_<CONFIG>.

$<TARGET_PDB_FILE_NAME:tgt>
Name of the linker generated program database file (.pdb).

$<TARGET_PDB_FILE_DIR:tgt>
Directory of the linker generated program database file (.pdb).

$<TARGET_PROPERTY:tgt,prop>
Value of the property prop on the target tgt.

Note that tgt is not added as a dependency of the target this expression is evaluated on.

$<TARGET_PROPERTY:prop>
Value of the property prop on the target on which the generator expression is evaluated.

$<INSTALL_PREFIX>
Content of the install prefix when the target is exported via install(EXPORT) and empty otherwise.
```

å®ƒä»¬çš„ç”¨é€”å’Œç”¨æ³•ä¸éš¾ä»¥ç†è§£ã€‚



### è¾“å‡ºè¡¨è¾¾å¼

è¾“å‡ºè¡¨è¾¾å¼ï¼ˆå¸¸å¸¸ä¼šé€šè¿‡æŸäº›è¾“å…¥ï¼‰è®¡ç®—å‡ºå¦ä¸€ä¸ªç»“æœã€‚

ä»¥ JOIN ä¸ºä¾‹ï¼š

```
$<JOIN:list,txt> å°† list æ•°ç»„åˆå¹¶ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸”ä»¥txtä¸ºæ•°ç»„å…ƒç´ ä¹‹é—´çš„åˆ†éš”ç¬¦
```

æ‰€ä»¥æˆ‘ä»¬åœ¨ä½¿ç”¨å¦‚ä¸‹è¡¨è¾¾å¼æ—¶ï¼š

```cmake
-I$<JOIN:$<TARGET_PROPERTY:${PROJECT_NAME},INCLUDE_DIRECTORIES>, -I>
```

æˆ‘ä»¬å¯èƒ½ä¼šå¾—åˆ°è¿™æ ·çš„ç»“æœï¼š

```
-I/Users/someone/peoject/study-cmake/z11-m1/libs/sm-lib/include -I/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX11.0.sdk/usr/include
```

æœ‰æ•ˆçš„è¾“å‡ºè¡¨è¾¾å¼æœ‰ï¼š

```cmake
$<ANGLE-R>
A literal >. Used to compare strings which contain a > for example.

$<COMMA>
A literal ,. Used to compare strings which contain a , for example.

$<SEMICOLON>
A literal ;. Used to prevent list expansion on an argument with ;.

$<TARGET_NAME:...>
Marks ... as being the name of a target. This is required if exporting targets to multiple dependent export sets. The ... must be a literal name of a target- it may not contain generator expressions.

$<LINK_ONLY:...>
Content of ... except when evaluated in a link interface while propagating Transitive Usage Requirements, in which case it is the empty string. Intended for use only in an INTERFACE_LINK_LIBRARIES target property, perhaps via the target_link_libraries() command, to specify private link dependencies without other usage requirements.

$<INSTALL_INTERFACE:...>
Content of ... when the property is exported using install(EXPORT), and empty otherwise.

$<BUILD_INTERFACE:...>
Content of ... when the property is exported using export(), or when the target is used by another target in the same buildsystem. Expands to the empty string otherwise.

$<LOWER_CASE:...>
Content of ... converted to lower case.

$<UPPER_CASE:...>
Content of ... converted to upper case.

$<MAKE_C_IDENTIFIER:...>
Content of ... converted to a C identifier.

$<TARGET_OBJECTS:objLib>
List of objects resulting from build of objLib. objLib must be an object of type OBJECT_LIBRARY. This expression may only be used in the sources of add_library() and add_executable() commands.
```





### è°ƒè¯•

ç”Ÿæˆå¼è¡¨è¾¾å¼ä¸å¯èƒ½ç”¨ message çš„æ–¹å¼æ‰“å°å‡ºæ¥ï¼Œå› ä¸º message çš„è®¡ç®—å¤ªæ—©äº†ï¼Œè€Œç”Ÿæˆå¼è¡¨è¾¾å¼å°šæœªç¡®å®š CMakeLists.txt çš„æ‰€æœ‰å†…å®¹ï¼Œæ‰€ä»¥å®ƒè¿˜æ²¡æœ‰è¢«æ±‚å€¼ã€‚

æ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å°†éœ€è¦å¦å¤–çš„é€”å¾„æ¥å¯¹ç”Ÿæˆå¼è¡¨è¾¾å¼æ±‚å€¼å¹¶è°ƒè¯•è¯¥è¡¨è¾¾å¼ã€‚

file æŒ‡ä»¤å…·æœ‰æˆ‘ä»¬æƒ³è¦çš„èƒ½åŠ›ï¼š

```cmake
file(GENERATE OUTPUT <filename> CONTENT <string-with-generator-expression>)
```

ä¾‹å¦‚ï¼š

```cmake
file(GENERATE OUTPUT ${CMAKE_GENERATED_DIR}/abc.log CONTENT "$<INSTALL_INTERFACE:include> - $<BUILD_INTERFACE:${CMAKE_CURRENT_SOURCE_DIR}/include>")
```



æ­¤å¤–ï¼Œä½¿ç”¨å®šåˆ¶å‘½ä»¤çš„æ–¹æ³•ä¹Ÿå¯ä»¥ï¼š

```cmake
add_custom_command(TARGET mytarget POST_BUILD
  COMMAND ${CMAKE_COMMAND} -E echo 
  "target dir = $<TARGET_FILE_DIR:mytarget>")
```

ä½†è¿™ç§æ–¹æ³•åœ¨å¤æ‚çš„ç¯å¢ƒä¸­ï¼Œåœ¨æŸäº›IDEä¸­ï¼Œå¯èƒ½ä¸èƒ½è‰¯å¥½åœ°è¡¨ç°ã€‚











## å…¶å®ƒ

### ä¸ä»£ç é€šä¿¡

cmake å¯ä»¥å’Œ c++ æºä»£ç é€šè®¯ã€‚å‡†ç¡®åœ°è¯´ï¼Œcmake å¯ä»¥ä½¿ç”¨ m4 é£æ ¼å°† .in æ–‡ä»¶è¾“å‡ºä¸ºæºä»£ç æ–‡ä»¶ï¼Œä»è€Œå½¢æˆå˜ç›¸çš„ä»£ç ç”Ÿæˆæ•ˆæœã€‚è¯¦æƒ…è¯·é˜… [configure_file](https://cmake.org/cmake/help/latest/command/configure_file.html) æŒ‡ä»¤ã€‚

> ç†Ÿæ‚‰ autoconf ä½“ç³»çš„äººåº”è¯¥ä¼šå¯¹ m4 å…·æœ‰çˆ±æ¨äº¤åŠ çš„è®°å¿†ã€‚æˆ‘å°±æ˜¯å¦‚æ­¤ï¼Œåˆšå¼€å§‹æ—¶çœŸçš„æ‹¿ç€ makefile.in å’Œ config.h.in æ¯«æ— åŠæ³•ã€‚
>
> å®ƒä»¬ä¸æ˜¯ç®€ç®€å•å•çš„æ¨¡ç‰ˆä¸­çš„å˜é‡æ›¿æ¢ã€‚
>
> å¦‚æœåªæ˜¯è¿™ä¹ˆä¸ªå­—ç¬¦ä¸²æ›¿æ¢ä½ ä»¥ä¸ºæˆ‘çœŸçš„å°±ä¼šå¼„ä¸æ‡‚å—ï¼Ÿnaiveï¼æˆ‘æ˜¯å¯¹é‚£äº›ç¥ä»™ä¸€èˆ¬çš„ä»€ä¹ˆ HAVE_xxxï¼Œä»€ä¹ˆ #if MIPS_XXX ä»€ä¹ˆçš„æ¯«æ— æŠµæŠ—åŠ›å•Šï¼Œæƒ³è¦å¯»æ‰¾ä¸€å¥å‚è€ƒæ–‡å­—éƒ½æ‰¾ä¸åˆ°ï¼Œä½ å› 1990 å¹´å»è¯•è¯•çœ‹ï¼Œæœ‰åŠæ³•å°±ç®—æˆ‘è¾“ï¼ˆå“¦ï¼Œä¸å¤ªå®‰å…¨ï¼Œä½ å› 1990 çš„ä¸­å›½çš„å°å±±æ‘é‡Œå»è¯•è¯•çœ‹ï¼ŒåŠ å·ç”Ÿäººå°±åˆ«æ¥å‡‘çƒ­é—¹äº†â€”â€”ç°åœ¨çš„ç½‘è·¯çœŸçš„å¤ªç—›è‹¦äº†ï¼Œå†™æ–‡å­—ç‡æ€§ä¸€ä¸ç‚¹éƒ½ä¼šè¶…å±é™©â€”â€”çœŸçš„å¾ˆæƒ³å›åˆ°ç«æ˜Ÿå»ï¼‰ã€‚

å¥½ï¼Œå›åˆ°ä¸»é¢˜æ¥ã€‚

ç°åœ¨æ²¡æœ‰é‚£ä¹ˆå¤æ‚çš„ config.h äº†ï¼Œé™¤éä½ ä¼šè·¨è¶…å¤šå¹³å°ï¼Œå¦åˆ™ä½ è¿™è¾ˆå­ç¼–ç¨‹éƒ½å¯èƒ½ä¸é‡åˆ° HAVE_xxx é—®é¢˜ã€‚æ‰€ä»¥æˆ‘ä»¬ç°åœ¨æœ‰æ›´ç®€å•çš„å®ä¾‹æ¥è§£é‡Šä»£ç ç”Ÿæˆé—®é¢˜ã€‚

#### version.in å’Œç‰ˆæœ¬è¿­ä»£çš„ç®¡ç†

æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª `.version.cmake` æ–‡ä»¶æ¥ç»´æŒæ•´ä¸ª Source Tree çš„ç‰ˆæœ¬è¿­ä»£é—®é¢˜ï¼Œå¹¶ä»è¿™é‡Œå‡ºå‘è¡ç”Ÿå‡ºä¸€æ•´å¥—ç‰ˆæœ¬è¿­ä»£çš„ç®¡ç†æ–¹æ³•ã€‚

##### `./.version.cmake`

é¦–å…ˆå»ºç«‹ä¸€ä¸ª .version.cmake æ–‡ä»¶ ï¼Œå†…å®¹ä¸ºï¼š

```cmake
set(VERSION 0.3.1.2)
```

ç‰ˆæœ¬å·æ˜¯ä½ è‡ªå®šçš„ã€‚è¿™ä¸ªæ–‡ä»¶å†…å®¹å°½å¯èƒ½ç®€å•ï¼Œæ˜¯ä¸ºäº†è®© shell è¯­å¥èƒ½å¤Ÿå¾ˆæ–¹ä¾¿åœ°é€’å¢å®ƒï¼Œè¿›ä¸€æ­¥åœ°ï¼ŒCI å·¥å…·åœ¨é€šè¿‡ shell æŒ‡ä»¤æ“ä½œ `.version.cmake` åå°†èƒ½å¤Ÿå®Œæˆ nightly æ„å»ºä»»åŠ¡ã€‚

##### `./CMakeLists.txt`

åœ¨ Source Tree çš„é¡¶çº§ç›®å½•ä¸­çš„ `CMakeLists.txt` ä¸­é¦–å…ˆä¼šæœ‰å¦‚ä¸‹çš„åºåˆ—ï¼š

```cmake
cmake_minimum_required(VERSION 3.9..3.19)
set(CMAKE_SCRIPTS "cmake")
set(CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS}/modules;${CMAKE_SOURCE_DIR}/${CMAKE_SCRIPTS};${CMAKE_SOURCE_DIR};${CMAKE_MODULE_PATH}")
include(version-def)
...
...
project(study-cmake
        VERSION ${VERSION}
        DESCRIPTION "study for cmake"
        LANGUAGES C CXX)
...
...
include(versions-gen)
```

Line 3 è®© Source Tree ä¸­çš„ `.`, `./cmake`ï¼Œ`./cmake/modules` å‡èƒ½è¢«è‡ªåŠ¨æœç´¢å¾—åˆ°ã€‚

#####  `./cmake/version-def.cmake` 

äºæ˜¯æˆ‘ä»¬å¯ä»¥å»ºç«‹ `./cmake/version-def.cmake` æ–‡ä»¶ï¼š

```cmake
if (EXISTS ${CMAKE_SOURCE_DIR}/.version.cmake)
  include(.version)
else()
  message("version decl file ignored")
  set(VERSION 0.1.0.1)
endif ()
```

å®ƒä¼šè½½å…¥æ­¤å‰çš„ `.version.cmake` æ–‡ä»¶ä¸­çš„ VERSION å®šä¹‰ã€‚

è¯·æ³¨æ„ å‰é¢çš„ `CMakeLists.txt` ä¸­ï¼Œproject æŒ‡ä»¤ä¼šé‡‡çº³è¿™ä¸ª VERSION å˜é‡å€¼ã€‚

##### `../cmake/version-gen.cmake`

æœ€åæ¥è¯´æ˜æˆ‘ä»¬æ€ä¹ˆåšä»£ç ç”Ÿæˆã€‚

é¦–å…ˆçœ‹ version-gen.cmake çš„æ–‡ä»¶å†…å®¹çš„ç®€åŒ–ç‰ˆï¼š

```cmake
...
if (EXISTS "${CMAKE_SOURCE_DIR}/.git")
  execute_process(
          COMMAND git rev-parse --abbrev-ref HEAD
          WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
          OUTPUT_VARIABLE GIT_BRANCH
          OUTPUT_STRIP_TRAILING_WHITESPACE
  )

  execute_process(
          COMMAND git log -1 --format=%h
          WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
          OUTPUT_VARIABLE GIT_COMMIT_HASH
          OUTPUT_STRIP_TRAILING_WHITESPACE
  )
else (EXISTS "${CMAKE_SOURCE_DIR}/.git")
  set(GIT_BRANCH "")
  set(GIT_COMMIT_HASH "")
endif (EXISTS "${CMAKE_SOURCE_DIR}/.git")

# get_git_head_revision(GIT_REFSPEC GIT_SHA1)
string(SUBSTRING "${GIT_COMMIT_HASH}" 0 12 GIT_REV)
if (NOT GIT_COMMIT_HASH)
  set(GIT_REV "0")
endif ()

message(STATUS "- Git current branch: ${GIT_BRANCH}")
message(STATUS "- Git commit hash:    ${GIT_COMMIT_HASH}")
message(STATUS "- Git rev:            ${GIT_REV}")

if (CMAKE_GENERATED_DIR)
else ()
  message(FATAL " >> ERROR: please include target-dirs.cmake at first.")
  # we need CMAKE_GENERATED_DIR at present.
endif ()

if (EXISTS ${xVERSION_IN})
  message(STATUS "Generating version.h from ${xVERSION_IN} to ${CMAKE_GENERATED_DIR} - Version ${PROJECT_VERSION}...")
  configure_file(
          ${xVERSION_IN}
          ${CMAKE_GENERATED_DIR}/version.h
  )
  message(STATUS "Generated: ${CMAKE_GENERATED_DIR}/version.h")
endif ()
```

è¿™é‡Œæœ‰å¾ˆå¤šæŒ‡ä»¤ï¼Œä½†åŠŸç”¨å¹¶ä¸å›°éš¾ï¼Œæˆ‘ä»¬ä¼šæ‰¿è®¤ PROJECT_VERSION å˜é‡å€¼ï¼Œå®ƒæ˜¯æ¥è‡ªäº VERSION å˜é‡å®šä¹‰çš„ï¼ˆè¯·å›é¡¾ .version.cmake æ–‡ä»¶å’Œ project æŒ‡ä»¤åœ¨ CMakeLists.txt ä¸­çš„å®é™…è¿ç”¨ï¼‰ï¼Œæ­¤å¤–æˆ‘ä»¬ä¹Ÿè¯•å›¾æå– git ä¸­çš„ç‰ˆæœ¬å·ä¿¡æ¯ã€‚

æˆ‘ä»¬å¹¶ä¸åšå†³å®šï¼Œå†³å®šçš„ç­–ç•¥è¢«ç¼–å†™åœ¨ `./cmake/version.h.in` æ–‡ä»¶ä¸­ï¼Œå¹¶åœ¨ [configure_file](https://cmake.org/cmake/help/latest/command/configure_file.html) æŒ‡ä»¤çš„åŠ æŒä¸‹è¢«ç”Ÿæˆä¸ºä¸€ä¸ªæºä»£ç æ–‡ä»¶ `${CMAKE_GENERATED_DIR}/version.h`ã€‚è¿™ä¸ªæ–‡ä»¶æ‰€åœ¨çš„ç›®å½•è¢«åŠ å…¥åˆ° include_directories æœç´¢è·¯å¾„ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨æºä»£ç çš„ä»»ä½•ä½ç½®ä½¿ç”¨å®ƒï¼š

```c++
// all.h
#include "version.h"
```

##### `configure_file` æŒ‡ä»¤

[configure_file](https://cmake.org/cmake/help/latest/command/configure_file.html) æŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯è£…å…¥ä¸€ä¸ª input æ–‡ä»¶ï¼Œç»è¿‡ m4 é£æ ¼çš„å­—ç¬¦ä¸²æ›¿ä»£ä¹‹åäº§ç”Ÿä¸€ä¸ª output æ–‡ä»¶ã€‚

å¦‚æœä½ è¿˜åœ¨ autoconf å¹´ä»£ï¼Œé‚£ä¹ˆä½ å¯ä»¥åœ¨ input æ–‡ä»¶ä¸­å†™è¿™æ ·çš„å½¢å¼ï¼š

```
#cmakedefine var ...
```

æ ¹æ®æ¡ä»¶æ£€æµ‹ç»“æœçš„ä¸åŒï¼Œè¯¥è¯­å¥åœ¨è¾“å‡ºæ—¶å°†è¢«ä¿®æ”¹ä¸º `#define var` æˆ–è€… `/* #undef var */` çš„å½¢å¼ã€‚

ä½ è¿˜å¯ä»¥ä½¿ç”¨ `#cmakedefine01 var ...` è¯­å¥ï¼Œå®ƒå°†è¢«æ›¿æ¢æˆ `#define var 1` æˆ– `#define var 0` çš„å½¢å¼ã€‚

ä¾‹å¦‚å¦‚ä¸‹çš„ cmake è„šæœ¬ï¼š

```cmake
option(ENABLE_BOOST "Enable Boost" ON)
if(ENABLE_BOOST)
  set(BOOST_STRING "foo")
endif()
configure_file(config.h.in config.h)
```

å¯¹äº config.h.in å†…å®¹ä¸ºï¼š

```
#cmakedefine01 ENABLE_BOOST
#cmakedefine BOOST_STRING "@BOOST_STRING@"
```

åˆ™è¾“å‡º config.h å†…å®¹ä¸ºï¼š

```c++
#define ENABLE_BOOST 1
#define BOOST_STRING "foo"
```

è¯·æ³¨æ„åœ¨inæ–‡ä»¶æ¨¡ç‰ˆä¸­çš„ `@var@` æ–‡å­—å°†è¢«æ›¿æ¢ä¸º var å˜é‡çš„å…·ä½“å€¼ã€‚





##### `./cmake/version.h.in`

è¨€å½’æ­£ä¼ ï¼Œä¸€ä¸ª version.h.in çš„æ ·æœ¬ä¸ºï¼š

```c++
#ifndef ___VERSION_H
#define ___VERSION_H

#define xT(str)                str

/*  NB: this file is parsed by automatic tools so don't change its format! */
#define xMAJOR_VERSION      @PROJECT_VERSION_MAJOR@
#define xMINOR_VERSION      @PROJECT_VERSION_MINOR@
#define xPATCH_NUMBER       @PROJECT_VERSION_PATCH@
#define xRELEASE_NUMBER     @PROJECT_VERSION_TWEAK@

#define xPROJECT_NAME       xT("@PROJECT_NAME@")
#define xVERSION_STRING     xT("@PROJECT_VERSION@")
#define xARCHIVE_NAME       xT("@ARCHIVE_NAME@")

#define xGIT_BRANCH         xT("@GIT_BRANCH@")
#define xGIT_COMMIT_HASH    xT("@GIT_COMMIT_HASH@")

#endif //___VERSION_H
```

æˆ‘ä»¬åœ¨è¿™é‡Œåªç”¨åˆ°äº† configure_file çš„ å­—ç¬¦ä¸²æ›¿æ¢èƒ½åŠ›ã€‚



##### `./cmake-debug-build/generated/version.h`

è€Œæ‰€ç”Ÿæˆçš„ version.h å¯èƒ½ä¼šåƒè¿™æ ·ï¼š

```c++
#ifndef ___VERSION_H
#define ___VERSION_H

#define xT(str)                str

/*  NB: this file is parsed by automatic tools so don't change its format! */
#define xMAJOR_VERSION      0
#define xMINOR_VERSION      3
#define xPATCH_NUMBER       1
#define xRELEASE_NUMBER     2

#define xPROJECT_NAME       xT("study-cmake")
#define xVERSION_STRING     xT("0.3.1.2")
#define xARCHIVE_NAME       xT("study-cmake-0.3.1.2")

#define xGIT_BRANCH         xT("master")
#define xGIT_COMMIT_HASH    xT("55ced0f")

#endif //___VERSION_H
```









### è¿è¡Œå…¶å®ƒç¨‹åº

åœ¨ä¸Šä¸€èŠ‚çš„å®ä¾‹ä¸­æˆ‘ä»¬å®é™…ä¸Šæ¼”ç¤ºäº†è¿è¡Œå…¶å®ƒç¨‹åºçš„æ–¹æ³•ï¼š

```cmake
if (EXISTS "${CMAKE_SOURCE_DIR}/.git")
  execute_process(
          COMMAND git rev-parse --abbrev-ref HEAD
          WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
          OUTPUT_VARIABLE GIT_BRANCH
          OUTPUT_STRIP_TRAILING_WHITESPACE
  )

  execute_process(
          COMMAND git log -1 --format=%h
          WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
          OUTPUT_VARIABLE GIT_COMMIT_HASH
          OUTPUT_STRIP_TRAILING_WHITESPACE
  )
else (EXISTS "${CMAKE_SOURCE_DIR}/.git")
  set(GIT_BRANCH "")
  set(GIT_COMMIT_HASH "")
endif (EXISTS "${CMAKE_SOURCE_DIR}/.git")
```



### æ›´å¤š

æ›´å¤šå…¶å®ƒå†…å®¹å°†æ¥æˆ–ä¼šè¡¥å……ã€‚















ğŸ”š