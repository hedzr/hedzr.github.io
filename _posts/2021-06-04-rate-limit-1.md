---
layout: single
title: 'é™æµç®—æ³•ä¹‹ä¸€'
date: 2021-06-04 05:41:11 +0800
last_modified_at: 2021-06-04 12:41:11 +0800
Author: hedzr
tags: [rate limit, band width, token bucket, leaky bucket, traffic shaping, microservice, algorithm, golang]
categories: golang algorithm
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-10.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  é€Ÿç‡é™åˆ¶ï¼ˆRate Limitï¼‰ï¼Œä»¥ Golang è§†è§’ ...
---

Intro: åœ¨ Web Serverã€TCP é€šè®¯ã€API äº¤äº’ç­‰é¢†åŸŸä¸­ï¼Œé€Ÿç‡é™åˆ¶ï¼ŒRate Limitï¼Œä¸€èˆ¬æ˜¯é¢å‘è¯·æ±‚æ¬¡æ•°ã€æµé‡ç­‰å‚æ•°è¿›è¡Œé€Ÿç‡æ§åˆ¶ã€‚æœ‰çš„æ—¶å€™å®ƒåˆè¢«ç§°ä½œæµé‡æ§åˆ¶ã€‚



> Cover: 
>
> ![Rate Limit & Throttling Graph](https://raw.githubusercontent.com/hzimg/blog-pics/master/uPic/Rate-Limit-and-Throttling-Graph.jpg)
>
> FROM: https://rafaelcapucho.github.io/2016/10/enhance-the-quality-of-your-api-calls-with-client-side-throttling/

## é€Ÿç‡é™åˆ¶

åœ¨ Web Serverã€TCP é€šè®¯ã€API äº¤äº’ç­‰é¢†åŸŸä¸­ï¼Œé€Ÿç‡é™åˆ¶ï¼ŒRate Limitï¼Œä¸€èˆ¬æ˜¯é¢å‘è¯·æ±‚æ¬¡æ•°ã€æµé‡ç­‰å‚æ•°è¿›è¡Œé€Ÿç‡æ§åˆ¶ã€‚æœ‰çš„æ—¶å€™å®ƒåˆè¢«ç§°ä½œæµé‡æ§åˆ¶ã€‚

è°ˆè®ºæµé‡æ§åˆ¶æ—¶ï¼Œå¤§æŠµä¸Šè¦è€ƒè™‘åˆ°å¦‚ä¸‹ä¸¤ä¸ªæ–¹é¢ï¼š

1. æ’å®šé€Ÿç‡ï¼ˆConstant Bit Rateï¼ŒCBRï¼‰
2. å˜é€Ÿé€Ÿç‡ï¼ˆVarible Bit Rateï¼ŒVBRï¼‰

è¿™å¹¶ä¸æ˜¯ TCP é€šè®¯ä¸“æœ‰çš„æ¦‚å¿µã€‚äº‹å®ä¸Šï¼Œé€Ÿç‡æ§åˆ¶æ˜¯ä¸ªè·¨è¶Šå¤šå­¦ç§‘å­˜åœ¨çš„é€šç”¨æ¦‚å¿µã€‚ä¾‹å¦‚åœ¨éŸ³è§†é¢‘æ’­æ”¾æ—¶ï¼ˆç‰¹åˆ«æ˜¯åœ¨æµåª’ä½“æ’­æ”¾æ—¶ï¼‰ï¼Œè§£ç é€Ÿç‡ä¹Ÿæ˜¯éœ€è¦è¢«æ§åˆ¶çš„ï¼šå¦‚æœç¡¬ä»¶çš„è§†é¢‘ç¼“å†²åŒºé€Ÿç‡ä¸å¤Ÿï¼Œè§£ç å°±è¦ç­‰ç­‰ï¼›å¦‚æœæµæ•°æ®è·å–çš„å¤ªæ…¢ï¼Œä¹Ÿä¼šå¯¼è‡´è§£ç åœæ»â€”â€”ä½†åœ¨è¿™æ—¶å€™ï¼Œæ’­æ”¾å´ä¸å¯ä»¥æš‚åœ/æˆ–è€…è‡³å°‘å£°éŸ³ä¸å¯ä»¥åœé¡¿ã€‚æ­¤æ—¶åŒæ ·æ¶‰åŠåˆ°æµæ§é—®é¢˜ã€‚

é™¤äº†æµæ§çš„é€Ÿç‡é—®é¢˜ä¹‹å¤–ï¼ŒRate Limit æœ€é‡è¦çš„ä¸€ä¸ªè®¾è®¡ä¸ç¼–ç å› ç´ æ˜¯è¿›é¡¹æµé‡çš„å¯æŠ›å¼ƒæ€§ã€‚

å¯¹äº TCP åº•å±‚çš„å¸¦å®½æ§åˆ¶å’Œæµæ§æ¥è¯´ï¼Œæµé‡æ˜¯ä¸å‡†è®¸è¢«æŠ›å¼ƒçš„ï¼Œç›¸åï¼ŒTCP åè®®å¼ºåˆ¶è¦æ±‚ä¿è¯åŒ…çš„å¯è¾¾æ€§ã€‚æ‰€ä»¥åœ¨TCPåè®®ä¸­åè€Œä¼šä¸ºå¤±è´¥åŒ…åšé‡ä¼ ã€‚

åœ¨å¾®æœåŠ¡ç½‘å…³ä¸­ï¼Œå‡ºäºä¸ºä¸‹æ¸¸æœåŠ¡æä¾›å¹³æ»‘ç¨³å®šçš„æœåŠ¡è¯·æ±‚çš„ç›®çš„ï¼Œæµæ§å¯èƒ½è¢«è¦æ±‚æ˜¯ä¸å¯æŠ›å¼ƒçš„ï¼Œæ­¤æ—¶æµæ§ä¼šæ‘Šå¹³å³°å€¼è¯·æ±‚åˆ°æ›´é•¿çš„æ—¶é—´ç‰‡ä¸­ï¼Œé™ä½ä¸‹æ¸¸çš„ç¬æ—¶åŠŸç‡ã€‚

ä¸è¿‡ï¼Œå¯¹äºæä¾›å…¬ä¼— API æœåŠ¡çš„å‚å•†æ¥è¯´ï¼Œä»–ä»¬ä¼šåœ¨æœåŠ¡ç½‘å…³ä¸­åŠ å…¥é™æµé€»è¾‘ï¼Œå¦‚æœä½ å°è¯•å‘å‡ºé«˜é¢‘è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™äº›è¯·æ±‚ä¸­è¶Šé™çš„éƒ¨åˆ†å°†è¢«ç½‘å…³æŠ›å¼ƒï¼Œç½‘å…³å†…éƒ¨çš„ä¸‹æ¸¸æœåŠ¡ä¸ä¼šè§åˆ°è¿™éƒ¨åˆ†è¶Šé™è¯·æ±‚ã€‚

æ‰€ä»¥æµæ§ä¸é™æµç›¸ä¼¼ä¹Ÿä¸ç›¸ä¼¼ï¼Œä½ éœ€è¦æ˜ç¡®åŒºåˆ†ä»–ä»¬ã€‚

ä½†åœ¨ Rate Limiter çš„è®¾è®¡è¿‡ç¨‹ä¸­ï¼Œæ˜¯å¯ä»¥åœ¨ä¸€ä¸ªè½¯ä»¶ç»„ä»¶ä¸­åŒæ—¶æä¾›è¿™ä¸¤è€…çš„ï¼Œåªæ˜¯éœ€è¦è®¾è®¡è€…æ—¶æ—¶æ¸…é†’å°±è¡Œã€‚



## å®ç°æ–¹æ¡ˆ

ä¸ºäº†ä¸‹é¢çš„è®ºè¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ä»¥æ¯ç§’é’Ÿ100æ¬¡ï¼ˆ100 r/sï¼‰è¯·æ±‚ä½œä¸ºé€Ÿç‡é™åˆ¶çš„æŒ‡æ ‡ã€‚

### è®¡æ•°å™¨æ–¹å¼

ååº”åœ¨è„‘æµ·é‡Œçš„å…³äºé€Ÿç‡é™åˆ¶çš„å®ç°æ–¹æ¡ˆï¼Œé¦–å…ˆè‡ªç„¶ä¼šæ˜¯è®¡æ•°å™¨æ³•ã€‚å®ƒå¾ˆç®€å•æ˜äº†ï¼Œå‡å®šä½ æœ‰ä¸€ä¸ª counterï¼Œåˆå€¼ä¸º 100ï¼Œæ¯æ¬¡è¯·æ±‚åˆ™ counter å‡ 1ï¼Œç›´åˆ° counter ä¸ºé›¶æ—¶æ‰æ ¹æ®æ¡ä»¶ï¼ˆä¾‹å¦‚æ—¶é—´å·²ç»è¶…è¿‡äº† 1sï¼‰é‡ç½®ä¸ºåˆå€¼ã€‚

```go
type counter struct {
	Maximal int
	Period  time.Duration
	count   int
	tick    int64 // in nanosecond
}

func (s *counter) Take(count int) bool {
	if time.Now().UnixNano() > s.tick {
		// if timeout, reset counter regally at first
		s.count = 0
		s.tick = time.Now().Add(s.Period).UnixNano()
	}

	s.count += count            // it's acceptable in HPC scene
	return s.count <= s.Maximal // it's acceptable in HPC scene
}
```

è®¡æ•°å™¨æ³•çš„æ˜¾è‘—ç‰¹ç‚¹æ˜¯ç¼ºä¹å‡åŒ€æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´è‹¥åœ¨è®¡æ—¶å‘¨æœŸä¹‹ä¸­çªå‘å¤§æ‰¹é‡è¯·æ±‚æ—¶ï¼ŒTake() ä¹Ÿè®¸ä»ä¼šæˆåŠŸï¼ˆåªè¦è®¡æ•°å™¨å°šæœªè¶…æ ‡ï¼‰ã€‚ä½†å¾ˆæ˜¾ç„¶ï¼Œæ­¤æ—¶è¢«å‡†è®¸çš„ä¸€æ‰¹è¯·æ±‚å®é™…ä¸Šæ˜¯è¿‡äºé¢‘ç¹ï¼Œè¶…æ ‡çš„ã€‚

è¿™ç§æƒ…å½¢ä¸‹æˆ‘ä»¬çš„é™æµè§„åˆ™å°šä¸”ç®—æ˜¯ç¬¦åˆã€‚ä½†å½“åœ¨è®¡æ—¶å‘¨æœŸæœ«å°¾ï¼Œä»¥åŠä¸‹ä¸€ä¸ªè®¡æ—¶å‘¨æœŸå¼€å§‹æ—¶ï¼Œå¦‚æœåˆ†åˆ«è¿›å…¥äº†å¤§é‡çš„è¯·æ±‚ï¼Œå°½ç®¡è¿™äº›è¯·æ±‚ä»è¢«é€šè¿‡äº†ï¼Œä½†æˆ‘ä»¬çš„é™æµè§„åˆ™å®é™…ä¸Šå·²ç»è¢«æ‰“ç ´äº†ï¼šå¦‚æœæˆ‘ä»¬è€ƒå¯Ÿçš„å‘¨æœŸä»¥å‰ä¸€è®¡æ—¶å‘¨æœŸçš„ä¸­ç‚¹å¼€å§‹åˆ°ä¸‹ä¸€å‘¨æœŸçš„ä¸­ç‚¹çš„è¯ï¼Œè¿™ä¸€æ®µæ—¶é—´å†…æ‰€é€šè¿‡çš„è¯·æ±‚æ•°å¯èƒ½è¾¾åˆ°æˆ‘ä»¬çš„é™æµè§„åˆ™çš„ä¸¤å€ã€‚

æœ‰æ—¶å€™ï¼Œè®¡æ•°å™¨æ³•è¢«è¡¨è¿°ä¸ºå›ºå®šçª—å£æ³•ï¼ˆFixed Windowï¼‰ï¼Œè¿™å’Œæ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰æ˜¯ç›¸å¯¹åº”çš„ã€‚ä½ å¯ä»¥å°†è®¡æ•°å™¨æ³•ä¸­çš„æ—¶é—´èŒƒå›´ï¼ˆä¹Ÿå³æ¡ˆä¾‹ä¸­çš„1sï¼‰ç§°ä½œ 1s çš„ç»Ÿè®¡çª—å£ã€æˆ–è€…è®¡ç®—çª—å£ã€æˆ–è€…è§‚å¯Ÿçª—å£ã€‚



### **Sliding Log**

æœ‰æ—¶å€™ï¼ŒSliding Log æ³•è¢«å•åˆ—ä¸ºä¸€ç§ç®—æ³•ã€‚

æ­¤æ—¶å¤§å®¶è®¤ä¸ºå®ƒæ˜¯å’Œæ»‘åŠ¨çª—å£æœ‰æ‰€ä¸åŒçš„ä¸€ç§æ–¹æ³•ï¼šå®ƒå°†æ¶ˆè´¹è€…è¯·æ±‚æŒ‰ç…§æ—¶é—´æˆ³è¿›è¡Œåºåˆ—åŒ–å­˜å‚¨ï¼Œå¹¶è¿½è¸ªè¿™ä¸ªåºåˆ—ã€‚åœ¨ä¸€ä¸ªè¯·æ±‚è¿›å…¥æ—¶ï¼Œæ­¤å‰çš„ä¸€ç»„æ—¶é—´æˆ³åºåˆ—å°†è¢«æ±‚å’Œï¼Œè¿™ä¸ª Sum å€¼ä¸ç›¸åº”çš„ Duration ç›¸é™¤å°±èƒ½å¾—åˆ°è¿™ä¸€æ®µæ—¶é—´å†…çš„è¯·æ±‚é¢‘ç‡ã€‚å¦‚æœé¢‘ç‡å¤ªé«˜åˆ™è¯·æ±‚è¢«æ‹’ç»ï¼Œå¦åˆ™åˆ™é€šè¿‡ã€‚ä¸ºäº†å°½å¯èƒ½èŠ‚çœå†…å­˜ï¼Œç³»ç»Ÿåªä¿ç•™ä¸€å®šå®¹é‡çš„æ—¶é—´æˆ³è®°ã€‚

ä½†åœ¨æˆ‘ä»¬çœ‹æ¥ï¼ŒSliding Log å®é™…ä¸Šåªæ˜¯æ»‘çª—æ³•çš„ä¸€ç§ç‰¹å®šå®ç°æ–¹æ¡ˆã€‚



### æ»‘åŠ¨çª—å£æ³•

å‰æ–‡çš„è®¨è®ºå·²ç»ä»‹ç»åˆ°ï¼Œè¦æƒ³è§£å†³è®¡æ•°å™¨æ³•çš„ä¸å¹³æ»‘é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ›´ç»†çš„æ—¶é—´ç‰‡ç²’åº¦ã€‚ä¸è¿‡ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸æ€ä¹ˆå®¹æ˜“çš„ã€‚ä¸€æ–¹é¢ï¼Œé«˜ç²¾åº¦æ—¶é’Ÿå—åˆ¶äºç¡¬ä»¶è®¾æ–½çš„ä¸åŒï¼Œæ”¯æŒçš„åŠ›åº¦ä¹Ÿå¤§ä¸ç›¸åŒã€‚å¦ä¸€æ–¹é¢ï¼Œå¤šç»†çš„ç²’åº¦æ‰å«ç»†å‘¢ï¼Œ1msï¼Œè¿˜æ˜¯ 1nsï¼Œè¿™æ˜¯ä¸ªé—®é¢˜â€”â€”ä¸åŒçš„åœºæ™¯å¯¹æ­¤å¯èƒ½ä¼šæœ‰ä¸åŒçš„æƒ³æ³•ã€‚

æ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦æ›´æ¢ä¸€ä¸‹æ€è€ƒè§’åº¦ï¼Œä¸ºäº†æ±‚å¾—ç»†è…»çš„æ—¶é—´ç‰‡ï¼Œæ”¹ç”¨æ»‘åŠ¨çª—å£çš„æ–¹å¼æ¥é—´æ¥è¾¾åˆ°ä»»æ„æ—¶é—´ç‰‡ç²’åº¦ã€‚

æ‰€è°“æ»‘åŠ¨çª—å£æ³•ï¼Œå®é™…ä¸Šæ˜¯æŒ‡åœ¨è¯·æ±‚å‘ç”Ÿæ—¶ï¼Œå‘å‰æ£€æŸ¥ä¸€ä¸ªè§‚å¯Ÿçª—å£ï¼ˆä¾‹å¦‚ 1sï¼‰çš„æ—¶é—´ç‰‡ï¼Œå¦‚æœè¿™æ®µæ—¶é—´å†…çš„å·²ç»æ¥çº³çš„è¯·æ±‚æ•°å°šæœªè¶…æ ‡ï¼Œå°±é€šè¿‡è¯·æ±‚ï¼Œåä¹‹æ‹’ç»ã€‚è¿™æ ·ï¼Œæ— è®ºè¯·æ±‚ä»¥ä½•ç§é€Ÿç‡åˆ°æ¥ï¼Œæˆ‘ä»¬å§‹ç»ˆåœ¨è¯·æ±‚ç‚¹å‘å‰çš„ä¸€ä¸ªè®¡æ—¶å‘¨æœŸä¸­åšé€Ÿç‡é™åˆ¶æ£€æµ‹ï¼Œè¿™ä¸ªæ—¶é—´ç‰‡æ˜¯éšç€è¯·æ±‚ç‚¹è€Œæ¨ç§»çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å…¶ç§°ä½œæ»‘åŠ¨çª—å£ã€‚

> æ»‘åŠ¨çª—å£æ˜¯åœ¨è®¡ç®—æœºç§‘å­¦ä¸­è¢«å¹¿æ³›åº”ç”¨çš„ä¸€ä¸ªé€šç”¨æ¦‚å¿µã€‚ä¾‹å¦‚åœ¨ LZWï¼ˆLZ77ï¼‰å‹ç¼©ç®—æ³•ä¸­ï¼Œå­—ç¬¦ä¸²åŒ¹é…ä¸­ï¼ŒTCP é€šè®¯æµæ§ç­‰ç­‰åœºæ™¯éƒ½æœ‰æ»‘çª—å‡ºæ²¡ã€‚

æ»‘çª—æ³•çš„ç®—æ³•æ€è·¯å¾ˆå®¹æ˜“ç†è§£ã€‚

ä½†å¯¹äºé€Ÿç‡é™åˆ¶åœºæ™¯æ¥è¯´ï¼Œå®ƒçš„ç¼–ç¨‹å®ç°å¹¶ä¸å®¹æ˜“ï¼Œå› ä¸ºè¦æƒ³å‘å‰è¿½è¸ªå’Œç»Ÿè®¡ä»»æ„çª—å£å·²æˆæƒè¯·æ±‚æ•°ï¼Œå…¶å†…åŠ¡è®¡ç®—é‡ä¹Ÿä¸å°ã€‚

æˆ‘ä»¬å·²ç»çŸ¥é“å¯ä»¥å­˜å‚¨æ¯æ¬¡è¯·æ±‚çš„æ—¶é—´æˆ³è®°ï¼ˆSliding Log æ³•ï¼‰ï¼Œç„¶åæŒ‰æ—¶é’Ÿæ–¹å‘åå‘æ±‚å’Œæ¥ç¡®å®šæ–°è¯·æ±‚æ˜¯å¦å·²ç»è¶Šé™ã€‚è¿™æ˜¯ä¸€ç§è¡Œå¾—é€šçš„æ³•å­ã€‚å¦‚æœä½ åœ¨åšä¸€ä¸ªé«˜ååé‡çš„ API Serverï¼Œå®ƒçš„å­˜å‚¨å’Œè®¡ç®—ä»£ä»·å¯èƒ½ä¹Ÿä¸å°ã€‚

å¦ä¸€ç§æ–¹æ³•æ˜¯ï¼Œå°†æ—¶é—´ç‰‡çª—å£ç¡¬æ€§åˆ’åˆ†ä¸º 8 ä¸ªå°ç‰‡ï¼ˆpiecesï¼‰ï¼Œåˆ†åˆ«è®°å½•æ¯ä¸ªå°ç‰‡ä¸­çš„å·²æˆæƒæ•°ï¼Œå½“æ–°è¯·æ±‚åˆ°æ¥éœ€è¦åšæ»‘çª—å†…è¿½è¸ªæ—¶ï¼Œåªéœ€è¦å›ºå®šå‘å‰è®¡ç®—8ä¸ªå°ç‰‡çš„ç´¯è®¡å’Œå³å¯ã€‚è¿™æ ·å¯ä»¥å¤§å¹…åº¦é™ä½è®¡ç®—é‡ã€å†…å­˜æ¶ˆè€—é‡ï¼Œä½†æ˜¯ä¹Ÿå°±ç®—æ˜¯æ»‘çª—æ³•çš„ç²—ç³™ç‰ˆï¼šè‡³å°‘æ¯”è¾ƒäºè®¡æ•°å™¨æ³•ç²¾ç»†åº¦æœ‰å¤§å¹…åº¦æé«˜ã€‚

å¯¹äºé«˜é¢‘äº¤æ˜“æ¥è¯´ï¼Œåœ¨é€Ÿç‡é™åˆ¶è¿™ä¸€ä»»åŠ¡ä¸Šæ¶ˆè€—å¤§é‡çš„CPUæˆ–å†…å­˜æ˜¯ä¸å¯æ¥å—çš„ã€‚æ‰€ä»¥ç”Ÿäº§ç¯å¢ƒä¸­æœªå¿…ä¼šé‡‡ç”¨æ»‘çª—æ€è·¯è½åœ°åˆ°ä»£ç å®ç°ä¸Šã€‚



### æ¼æ¡¶æ³•ï¼ˆLeaky Bucketï¼‰

#### åŸºæœ¬åŸç†

ä»»æ„çª—å£ä¸­ï¼Œå·²ç»æˆæƒçš„è¯·æ±‚æ•°ä¸å®¹æ˜“è·å–ã€æˆ–è€…è®¡ç®—é‡åå¤§ï¼Œæ—¢ç„¶å¦‚æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åå…¶é“è€Œè¡Œï¼šå‡è®¾ä¸€ä¸ªæ’å®šå®¹é‡ï¼ˆ100 æ»´æ°´ï¼‰çš„æ°´æ¡¶æ¥æ°´ï¼Œæ°´é¾™å¤´å‡ºæ°´çš„é€Ÿç‡å–å†³äºè¯·æ±‚çš„å¤šå°‘ï¼Œè€Œæ°´æ¡¶ä¸‹æ–¹æœ‰ä¸€å¼€å£ï¼Œæ­£å¥½èƒ½ä»¥ 10ms çš„é€Ÿç‡åŒ€é€Ÿå‡ºæ°´ã€‚é‚£ä¹ˆæ— è®ºè¿›å…¥çš„è¯·æ±‚æœ‰å¤šå°‘ï¼Œä»–ä»¬è¢«è¿™ä¸ªæ°´æ¡¶ä»¥ç‰¹å®šçš„æ–¹å¼æ‰€çº¦æŸï¼Œå§‹ç»ˆæœ€å¤šåªèƒ½æœ‰ç­‰åŒäºæ°´æ¡¶å®¹é‡çš„è¯·æ±‚èƒ½è¢«æ”¾è¿‡ã€‚

å¦‚æœè¯·æ±‚é‡è¿‡é‡ï¼Œæ°´é¾™å¤´å‡ºæ°´è¿‡å¤šï¼Œåˆ™æ°´æ¡¶æº¢å‡ºï¼Œè¿™äº›å¤šä½™çš„è¯·æ±‚å°±è¢«æŠ›å¼ƒäº†ã€‚

å¦‚æœä¸æƒ³æŠ›å¼ƒæº¢å‡ºçš„è¯·æ±‚ï¼Œé‚£ä¹ˆä¸€èˆ¬æ˜¯é‡‡ç”¨è‡ªæ—‹çš„æ–¹å¼ç­‰å¾…æ°´æ¡¶ä¸æ»¡ï¼Œç„¶åå†æäº¤è¯·æ±‚ï¼Œç›´åˆ°æ‰€æœ‰è¯·æ±‚éƒ½è¢«æ”¾è¿‡ï¼Œè¿™å°±æ˜¯ä»¥æ—¶é—´ä¸ºä»£ä»·åšæ”¾è¿‡äº†ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬æ‰¾ä¸ªè¶³å¤Ÿå¤§çš„é¢å¤–çš„æ¡¶å§æº¢å‡ºçš„æ°´æ¥ä¸‹æ¥ï¼Œç„¶åé‡æ–°é€åˆ°æ°´é¾™å¤´ä¸Šå»æ»´æ°´å¥½äº†ã€‚

å¦‚æ­¤ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†é€Ÿç‡é™åˆ¶çš„æ°´æ¡¶æ€ç»´ç‰ˆï¼šæ¼æ¡¶æ³•ã€‚

![https://cdncontribute.geeksforgeeks.org/wp-content/uploads/leakyTap-1.png](https://raw.githubusercontent.com/hzimg/blog-pics/master/uPic/leakyTap-1.png)

> From: https://dev.to/swyx/networking-essentials-rate-limiting-and-traffic-shaping-43ii

æ ¹æ®å‡ºæ°´ç­–ç•¥çš„ä¸åŒï¼ŒéåŒ€é€Ÿçš„è¿›å…¥è¯·æ±‚åªè¦è¢«å‡†è®¸ï¼Œåˆ™å¯ä»¥è¢«åŸæ ·æ”¾å‡ºï¼Œæˆ–è€…æ˜¯è¢«æ•´å½¢åä»¥æ’å®šçš„é€Ÿç‡æ”¾å‡ºï¼ˆä¾‹å¦‚æ¯ 10ms æ”¾å‡ºä¸€ä¸ªè¯·æ±‚ï¼‰ã€‚

å¾ˆæ˜æ˜¾ï¼Œå¦‚æœä¸æƒ³æŠ›å¼ƒå¤šä½™çš„è¯·æ±‚ï¼Œé‚£ä¹ˆä½ å¿…é¡»ä¿è¯ä¸€æ®µæ—¶é—´å†…çš„æ€»è¯·æ±‚é‡ä¸ä¼šè¶…è¿‡é€Ÿç‡é™åˆ¶ã€‚å¦åˆ™è¿™äº›é˜»å¡çš„è¯·æ±‚ä¼šé€ æˆç“¶é¢ˆé—®é¢˜ã€‚



#### å¼€æºå®ç°

åœ¨å¾ˆå¤šå¼€æºå®ç°æ–¹æ¡ˆä¸­ï¼Œæ¼æ¡¶æ³•è¢«é™å®šä¸ºå¤å…¸å¼ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„åŒ€é€Ÿå‡ºæ°´æ¨¡å¼ï¼ˆåˆç§°ä½œå¸¦æµé‡æ•´å½¢ Traffic Shaping çš„æ¼æ¡¶ç®—æ³•ï¼‰ã€‚

è¿™ç±»å®ç°ä¸­ï¼Œé‡‡ç”¨çš„æ˜¯é€Ÿç‡è®¡ç®—ç®—æ³•ï¼Œå…¸å‹çš„å®ç°ï¼ˆä¾‹å¦‚ `kevinms/leakybucket-go`ï¼‰å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š

```go
// Makes it easy to test time based things.
var now = time.Now

// LeakyBucket represents a bucket that leaks at a constant rate.
type LeakyBucket struct {
	// The identifying key, used for map lookups.
	key string

	// How large the bucket is.
	capacity int64

	// Amount the bucket leaks per second.
	rate float64

	// The priority of the bucket in a min-heap priority queue, where p is the
	// exact time the bucket will have leaked enough to be empty. Buckets that
	// are empty or will be the soonest are at the top of the heap. This allows
	// for quick pruning of empty buckets that scales very well. p is adjusted
	// any time an amount is added to the Queue().
	p time.Time

	// The index is maintained by the heap.Interface methods.
	index int
}

func NewLeakyBucket(rate float64, capacity int64) *LeakyBucket {
	return &LeakyBucket{
		rate:     rate,
		capacity: capacity,
		p:        now(),
	}
}

func (b *LeakyBucket) Add(amount int64) int64 {
	count := b.Count()
	if count >= b.capacity {
		// The bucket is full.
		return 0
	}

	if !now().Before(b.p) {
		// The bucket needs to be reset.
		b.p = now()
	}
	remaining := b.capacity - count
	if amount > remaining {
		amount = remaining
	}
	t := time.Duration(float64(time.Second) * (float64(amount) / b.rate))
	b.p = b.p.Add(t)

	return amount
}
```

åœ¨ä¸Šé¢çš„å®ç°ä¸­ï¼ŒAdd() è¿”å› 0 è¡¨ç¤ºæ°´æ¡¶å·²æ»¡ï¼Œä¹Ÿå³è¯·æ±‚è·å‡†å¤±è´¥ã€‚

å®ƒçš„å®ç°ç¨å¾®æœ‰äº›ä¸åˆ©äºæˆ‘ä»¬æŒ‰æƒ¯æ€§å»ç†è§£ã€‚

æ­¤å¤–ï¼Œ`uber-go/ratelimit` å®ç°çš„å°±æ˜¯å®Œæ•´çš„æ¼æ¡¶æ³•åŒ€é€Ÿå‡ºæ°´æ–¹æ¡ˆï¼Œä¸ºäº†åšåˆ°åŒ€é€Ÿå‡ºæ°´ï¼Œåœ¨å®ƒçš„ Take() ä¸­ä»¥é˜»å¡æ–¹å¼è¿›è¡Œæ£€æµ‹ï¼Œé™¤éåˆ°è¾¾ 10ms è¾¹ç•Œï¼Œå¦åˆ™ä¸ä¼šè¿”å›ï¼Œä»è€Œè¾¾åˆ°äº†ç²¾ç¡®çš„åŒ€é€Ÿå‡ºæ°´ã€‚ç”±äºæ¶‰åŠåˆ°çš„æ¯ä¸ªè¯·æ±‚çš„çŠ¶æ€é‡æœ‰å¤šä¸ªï¼Œå› æ­¤ uber ä½¿ç”¨äº† unsafe.pointer çš„åŸå­æ“ä½œï¼Œè¿™å°±ä½¿å¾—å…¶ä»£ç ä¸æ˜¯é‚£ä¹ˆç›´è§‚ã€‚æ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰åœ¨è¿™é‡Œåˆ—ä¸¾å®ƒçš„å®ç°ä»£ç ã€‚

#### æˆ‘ä»¬çš„ç‰ˆæœ¬

è¿™ç±»å¤å…¸ç®—æ³•æœ‰æ—¶å€™ä¹Ÿè®¸å¹¶ä¸æ˜¯ç‰¹åˆ«å¥½çš„é€‰æ‹©ã€‚ä»–ä»¬çš„é—®é¢˜åœ¨äºåœ¨è¯·æ±‚è¿›å…¥æ—¶ä¼šåœ¨ Take() å¤„è¢«é˜»å¡ï¼Œå¦‚æ­¤ä¸€æ¥å…¥å£å¤„å¯èƒ½äº§ç”Ÿè¯·æ±‚å †ç§¯è€Œæ— æ³•æœ‰æ•ˆåœ°æŠ›å¼ƒå¤šä½™è¯·æ±‚ã€‚è¿›ä¸€æ­¥çš„è¡¨ç°ä¸ºé˜² DDOS èƒ½åŠ›è¾ƒå·®ã€‚å½“ç„¶ï¼Œå…¶å¥½å¤„åœ¨äºï¼Œåªè¦ç”Ÿäº§åœºæ™¯è¦æ±‚çš„æ˜¯è¿›å…¥è¯·æ±‚ä¸å‡†è®¸è¢«æŠ›å¼ƒï¼Œé‚£ä¹ˆå®ƒä»¬å°†è¢«æœ‰æ•ˆåœ°å †ç§¯ç›´åˆ°ä¸‹æ¸¸æœåŠ¡æœ€ç»ˆåƒè¿›ï¼Œè¿™æ ·çš„ç‰¹æ€§å¯¹äºå¾®æœåŠ¡å‰Šå³°æ˜¯æ°å½“çš„ã€‚

##### éé˜»å¡å®ç°

æ ¹æ®è¿™äº›å®ä½œä¸Šçš„è®¤è¯†ï¼Œæˆ‘ä»¬å¦è¡Œå®ç°äº†ä¸€å¥—æ¼æ¡¶ç®—æ³•ï¼ˆ[å®Œæ•´ repo](https://github.com/hedzr/rate)ï¼‰ï¼Œå…è®¸æä¾›éé˜»å¡å…¥å£æ–¹å¼ï¼š

```go
func New(maxCount int64, d time.Duration) *leakyBucket {
	return (&leakyBucket{
		int64(maxCount),
		make(chan struct{}),
		int64(d) / int64(maxCount),
		time.Now().UnixNano(),
		0,
	}).start(d)
}

type leakyBucket struct {
	Maximal     int64
	exitCh      chan struct{}
	rate        int64
	refreshTime int64 // in nanoseconds
	count       int64
}

func (s *leakyBucket) Count() int64            { return atomic.LoadInt64(&s.count) }
func (s *leakyBucket) Available() int64        { return int64(s.count) }
func (s *leakyBucket) Capacity() int64         { return int64(s.Maximal) }

func (s *leakyBucket) Close() {
	close(s.exitCh)
}

func (s *leakyBucket) start(d time.Duration) *leakyBucket {
	if s.rate < 1000 {
		log.Errorf("the rate cannot be less than 1000us, it's %v", s.rate)
		return nil
	}

	// fmt.Printf("rate: %v\n", time.Duration(s.rate))

	// go s.looper(d)
	return s
}

func (s *leakyBucket) looper(d time.Duration) {
	// nothing to do
}

func (s *leakyBucket) max(a, b int64) int64 {
	if a < b {
		return b
	}
	return a
}

func (s *leakyBucket) take(count int) (requestAt time.Time, ok bool) {
	requestAt = time.Now()

	s.count = s.max(0, s.count-(requestAt.UnixNano()-s.refreshTime)/s.rate*int64(count))
	s.refreshTime = requestAt.UnixNano()

	if s.count < s.Maximal {
		s.count += int64(count)
		ok = true
	}

	return
}

func (s *leakyBucket) Take(count int) (ok bool) {
	_, ok = s.take(count)
	return
}

func (s *leakyBucket) TakeBlocked(count int) (requestAt time.Time) {
	var ok bool
	requestAt, ok = s.take(count)
	for !ok {
		time.Sleep(time.Duration(s.rate - (1000 - 1)))
		_, ok = s.take(count)
	}
	time.Sleep(time.Duration(s.rate-int64(time.Now().Sub(requestAt))) - time.Millisecond)
	return
}
```

åœ¨è¿™å¥—å®ç°æ–¹æ¡ˆä¸­ï¼Œåˆ©ç”¨ Take() çš„æ— é˜»å¡æ•ˆæœï¼Œä½ å¯ä»¥æœ‰ä»¥ä¸‹çš„è‡ªå®šä¹‰é€‰æ‹©ï¼š

1. é¦–å…ˆä½ è¦é€šè¿‡éé˜»å¡çš„ Take() å°è¯•è·å¾—å‡†è®¸
2. å¦‚æœæœªèƒ½è·å‡†é€šè¿‡ï¼š
   1. å¦‚æœä½ ä¸æƒ³æŠ›å¼ƒè¯·æ±‚ï¼Œåˆ™è‡ªè¡Œå»ºç«‹ä¸€ä¸ª queue æ¥ç¼“å­˜å’Œå»¶åé‡æ–°å°è¯•è·å¾—å‡†è®¸ã€‚
   2. å¦‚æœä½ éœ€è¦æŠ›å¼ƒè¶Šé™è¯·æ±‚ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸åšå¥½äº†
3. å¯¹äºè·å‡†çš„è¯·æ±‚ï¼Œåœ¨ Take() è¿”å›åå¾—åˆ°çš„æ˜¯ä¸ç»è¿‡åŒ€é€Ÿæ•´å½¢çš„å‡ºæ°´ã€‚

##### å…¼å®¹äº uber-go/ratelimit

ä¸è¿‡ï¼Œå¦‚æœä½ æ˜¯åœ¨åˆ¶ä½œä¸€ä»½ç”¨äºå‰Šå³°ç›®çš„çš„ rate limiter ä¸­é—´ä»¶çš„è¯ï¼Œä½ å¯èƒ½è¿˜æ˜¯å¸Œæœ›åƒ uber é‚£æ ·çš„æ•ˆæœï¼šä¸æŠ›å¼ƒæœªè·å‡†è¯·æ±‚ï¼Œä¸”åŒ€é€Ÿå‡ºæ°´ã€‚è¿™æ²¡æœ‰å…³ç³»â€”â€”å°½ç®¡æœ‰ç‚¹ç²—åŠ£â€”â€”æˆ‘ä»¬è¿˜æ˜¯æä¾›äº†ä¸€ä»½é˜»å¡ç‰ˆæœ¬ TakeBlocked()ï¼Œå®ƒèƒ½å¤Ÿè®©è·å‡†è¯·æ±‚åŒ€é€Ÿæµå‡ºã€‚ä»¥æµ‹è¯•å‡½æ•°ä¸ºä¾‹ï¼š

```go
import "github.com/hedzr/rate/leakybucket"

func TestLeakyBucketLimiter(b *testing.T) {
	var counter int
	l := leakybucket.New(100, time.Second, false) // one req per 10ms
	defer l.Close()
	time.Sleep(300 * time.Millisecond)
	prev := time.Now()
	for i := 0; i < 20; i++ {
		ok := l.TakeBlocked(1)
		now := time.Now()
		counter++
		fmt.Println(i, now.Sub(prev))
		prev = now
		time.Sleep(1 * time.Millisecond)
	}
	b.Logf("%v requests allowed.", counter)
}
```

è¿è¡Œåçš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š

```bash
$ go test -v -race -test.run='^TestLeakyBucketLimiter$' ./leakybucket
==== RUN   TestLeakyBucketLimiter
0 9.468477ms
1 10.47512ms
2 12.589327ms
3 10.364861ms
4 11.820381ms
5 10.353834ms
6 12.504309ms
7 10.167151ms
8 11.623466ms
9 10.487361ms
10 10.72498ms
11 12.435839ms
12 11.73813ms
13 10.956558ms
14 11.893156ms
15 11.964504ms
16 11.856545ms
17 11.094344ms
18 10.978074ms
19 10.632583ms
    lb_test.go:36: 20 requests allowed.
--- PASS: TestLeakyBucketLimiter (0.53s)
PASS
ok      github.com/hedzr/rate/leakybucket       0.957s
```

è€Œå¦‚æœæ²¡æœ‰èƒ½å¤Ÿè·å‡†æ—¶ï¼Œè¯¥è¯·æ±‚å°†ä¼šä¸€ç›´é˜»å¡ä¸‹å»ï¼Œç›´åˆ°ä¸‹ä¸€æ¬¡è·å–æˆåŠŸâ€”â€”ç”±äºrate=10msï¼ˆå³1000ms/100æ¬¡ï¼‰çš„çº¦æŸçš„å­˜åœ¨ï¼Œæ‰€ä»¥é˜»å¡ä¹Ÿä¸ä¼šè¶…å‡º rate è¾¹ç•Œå¤ªå¤šã€‚

è™½ç„¶ä¸é‚£ä¹ˆç²¾ç¡®ï¼Œä¹Ÿå¾ˆæœ‰ç‚¹æ‹™åŠ£ï¼Œä½†æ˜¯æˆ‘ä»¬å¼„äº†ä¸€ä¸ªï¼Œå¯¹å§ã€‚

##### é¢å‘ Public API - ç®€åŒ–çš„ Gin ä¸­é—´ä»¶

å¦‚æœè¦å»ºç«‹ Public API çš„åœºæ™¯çš„è¯ï¼Œè¶Šé™è¯·æ±‚ï¼ˆå°¤å…¶æ˜¯æ¶æ„çš„è¯·æ±‚ï¼‰å¿…é¡»æ˜¯è¢«æŠ›å¼ƒçš„ï¼Œè¿™æ—¶å€™ uber çš„ ratelimit ç‰ˆæœ¬å°±ä¸åˆé€‚äº†ï¼Œæ­¤æ—¶éé˜»å¡ç‰ˆæœ¬æ‰æ˜¯æ°å½“çš„é€‰æ‹©ã€‚

ä¸€ä¸ªç®€åŒ–çš„ gin ä¸­é—´ä»¶å¯ä»¥è¿™æ ·æ¥å†™ï¼š

```go
func (r *Limiter) getRL(ctx gin.Context) rateapi.Limiter {
	if r.limiter == nil {
		r.limiter = leakybucket.New(100, time.Second, false)
	}
	return r.limiter
}

func (r *Limiter) SimpleMiddleware() gin.HandlerFunc {
	return func(ctx *gin.Context) {
		limiter := r.getRL(ctx)
		if err != nil {
			ctx.AbortWithError(429, err)
		} else if limiter != nil {
			if limiter.Take(1) {
				ctx.Writer.Header().Set("X-RateLimit-Remaining", fmt.Sprintf("%d", limiter.Available()))
				ctx.Writer.Header().Set("X-RateLimit-Limit", fmt.Sprintf("%d", limiter.Capacity()))
				ctx.Next()
			} else {
				err = errors.New("Too many requests")
				ctx.Writer.Header().Set("X-RateLimit-Remaining", fmt.Sprintf("%d", limiter.Available()))
				ctx.Writer.Header().Set("X-RateLimit-Limit", fmt.Sprintf("%d", limiter.Capacity()))
				ctx.AbortWithError(429, err)
			}
		} else {
			ctx.Next()
		}
	}
}
```

æŒ‰ç…§çº¦å®šä¿—æˆçš„æ ‡å‡†ï¼Œè¢«æŠ›å¼ƒçš„è¯·æ±‚ä¼šå¾—åˆ° response header é€šçŸ¥ï¼š

![image-20210606204438636](https://raw.githubusercontent.com/hzimg/blog-pics/master/uPic/image-20210606204438636.png)



##### Gin ä¸­é—´ä»¶

ä½œä¸ºä¸Šè¿°ç®€åŒ–ä»£ç çš„å®Œå–„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ª gin ratelimit ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥ç›´æ¥å–ç”¨ï¼š

```go
import "github.com/hedzr/rate/middleware"

func engine() *gin.Engine {
  r := gin.Default()
  r.Use(middleware.NewLimiterForGin(time.Second, 100, func(ctx *gin.Context) (string, error){
    key := ctx.Request.Header.Get("X-API-KEY")
		if key != "" {
			return key, nil
		}
		ctx.JSON(403, gin.H{"code": 2901, "message": "API key is missing"})
		return "", errors.New("API key is missing")
  }))
  return r
}
```

åœ¨ç¤ºä¾‹ä¸­ï¼Œä½ æä¾›ä¸€ä¸ª keygenFunc ç»™ä¸­é—´ä»¶ï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥è¿”å›ä¸€ä¸ªå”¯ä¸€çš„ keyï¼Œä¾‹å¦‚æŸä¸ª API Client æ‰€ç”³è¯·å¾—åˆ°çš„ API KEYï¼Œç„¶åä¸­é—´ä»¶å°±ä¼šä¸ºè¿™ä¸ª key å•ç‹¬ç»´æŠ¤ä¸€ä¸ª rate limiterã€‚

æ ¹æ®ä½ çš„ä¸šåŠ¡åœºæ™¯ï¼Œä½ å¯ä»¥é€‰æ‹©æ›´æ°å½“çš„ keygenFunc å› å­ã€‚æ¯”æ–¹è¯´ä¸æ˜¯åœ¨æ£€æµ‹ X-API-KEY headerï¼Œè€Œæ˜¯æ£€æµ‹ header ä¸­çš„ X-USER-TOKENï¼Œæˆ–è€…ä»¥ IP/GeoIP ä¸º key çš„ä¾æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è·å¾—å¯¹ç‰¹å®šç”¨æˆ·ã€ä¸åŒIPã€ç‰¹å®šåœ°åŒºçš„é™æµæ”¿ç­–ã€‚

å½“ç„¶ï¼Œåœ¨ HPC åœºæ™¯ï¼Œä½ å¯èƒ½è¿˜éœ€è¦åœ¨æˆ‘ä»¬æä¾›çš„è¿™ä¸ªä¸­é—´ä»¶çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥åœ°æ‹“å±•ï¼Œä¾‹å¦‚å¯¹å¤§è§„æ¨¡ API KEYs åœºæ™¯ä½ éœ€è¦æœ‰åˆ†åŒºåˆ†èŠ‚ç‚¹çš„æªæ–½ã€ä»¥é˜²æ­¢å•ä¸ªèŠ‚ç‚¹ä¸Šçš„å¤§é‡ rate limiters å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œç­‰ç­‰ã€‚

è€Œä¸€æ—¦é‡‡ç”¨äº†å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼è®¡ç®—ç­–ç•¥æ—¶ï¼Œä½ æ›´éœ€è¦æ”¹é€ å’Œé‡‡ç”¨åˆ†å¸ƒå¼çš„ ratelimit æ ¸å¿ƒç®—æ³•â€”â€”æˆ‘ä»¬æ‰€æä¾›çš„[å®Œæ•´ repo](https://github.com/hedzr/rate)å¹¶ä¸ç›´æ¥æ”¯æŒåˆ†å¸ƒå¼è®¡ç®—åœºæ™¯ã€‚



### ä»¤ç‰Œæ³•ï¼ˆToken Bucketï¼‰

æ¼æ¡¶æ³•é¢å‘è¿›å…¥è¯·æ±‚è¿›è¡Œæ•´å½¢ï¼ˆå»æ‰å¤šä½™çš„ï¼Œä»…è·å‡†è€…è¢«æ¼ä¸‹ï¼‰ï¼Œä½†æ˜¯å®ƒè™½ç„¶æ˜¯æˆ‘ä»¬é¢å¯¹æ»‘çª—éš¾ä»¥ç¼–ç è€Œè½¬æ¢çš„æ–°æ€è·¯ï¼Œå´å’Œæ»‘çª—çš„å·®å¼‚ç•¥å¤§ã€‚

æ‰€ä»¥ä»¤ç‰Œæ³•æ‰æ˜¯æ›´æ¥è¿‘æ»‘çª—æ³•æ€è·¯çš„è°ƒä¼˜ç®—æ³•ã€‚

æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å‡è®¾ä¸€ä¸ª producer ä»¥æ’å®šé€Ÿç‡ï¼ˆæ¯ 10ms ä¸€ä¸ªï¼‰åˆ¶é€ ä»¤ç‰Œï¼Œè€Œä¸€ä¸ªè¯·æ±‚è¢«è·å‡†æ—¶åˆ™æ¶ˆè€—ä¸€å—ä»¤ç‰Œã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå•ä½æ—¶é—´ç‰‡ä¸­å·²ç»æˆæƒäº†å¤šå°‘è¯·æ±‚å°±ä¸å†æ˜¯é‡ç‚¹ï¼Œé‡ç‚¹ç°åœ¨å˜ä¸ºä»¤ç‰Œæ¡¶ä¸­æœ‰å¦å¯ç”¨ä»¤ç‰Œçš„é—®é¢˜ã€‚

![https://gateoverflow.in/?qa=blob&qa_blobid=14382465908978628560](https://raw.githubusercontent.com/hzimg/blog-pics/master/uPic/14382465908978628560.jpeg)

> From: https://dev.to/swyx/networking-essentials-rate-limiting-and-traffic-shaping-43ii

ç”±äºä»¤ç‰Œæ€»æ˜¯è¢«åŒ€é€Ÿåˆ¶é€ çš„ï¼Œæ‰€ä»¥è¿›å…¥è¯·æ±‚ä¼šè¢«å‡åŒ€åœ°é™æµï¼ˆä¹Ÿå°±æ˜¯åœ¨ 10ms å‘¨æœŸçš„æ‰€æœ‰å¤šä½™çš„è¯·æ±‚éƒ½ä¸è¢«è·å‡†ï¼‰ï¼Œä»¤ç‰Œæ³•æ¯”è¾ƒäºå‰é¢å‡ ç§æ–¹æ³•æ¥è¯´åœ¨è¿™ä¸ªé¢†åŸŸæœ‰ç»å¯¹ä¼˜åŠ¿ã€‚

åè¿‡æ¥è¯´ï¼Œå¦‚æœè¿›å…¥è¯·æ±‚ä¸å¯ä»¥è¢«æŠ›å¼ƒçš„è¯ï¼Œä»¤ç‰Œæ³•å°±ä¼šå¸¦æ¥é¢å¤–çš„é˜»å¡å¼€é”€ï¼šæœªèƒ½è·å‡†çš„è¯·æ±‚éœ€è¦åœ¨ä¸€ä¸ªæ›´æ…¢çš„é˜Ÿåˆ—ä¸­ï¼ˆæˆ–è€…ç›´æ¥å°±åœ°é˜»å¡çš„æ–¹å¼ï¼‰é‡è¯•ç›´åˆ°è·å–åˆ°ä»¤ç‰Œè€Œé€šè¿‡æ—¶ä¸ºæ­¢ã€‚

äºæ˜¯æˆ‘ä»¬æœ‰è¿™æ ·çš„å®ç°ä»£ç ï¼š

```go
func New(maxCount int64, d time.Duration) *tokenBucket {
	return (&tokenBucket{
		int32(maxCount),
		d,
		int64(d) / int64(maxCount),
		make(chan struct{}),
		int32(maxCount),
	}).start(d)
}

type tokenBucket struct {
	Maximal int32
	period  time.Duration
	rate    int64
	exitCh  chan struct{}
	count   int32
}

func (s *tokenBucket) Count() int32            { return atomic.LoadInt32(&s.count) }
func (s *tokenBucket) Available() int64        { return int64(s.count) }
func (s *tokenBucket) Capacity() int64         { return int64(s.Maximal) }

func (s *tokenBucket) Close() {
	close(s.exitCh)
}

func (s *tokenBucket) start(d time.Duration) *tokenBucket {
	if s.rate < 1000 {
		log.Errorf("the rate cannot be less than 1000us, it's %v", s.rate)
		return nil
	}

	go s.looper(d)
	return s
}

func (s *tokenBucket) looper(d time.Duration) {
	ticker := time.NewTicker(d / time.Duration(s.Maximal))
	// fmt.Printf("token building spped is: 1req/%v\n", d/time.Duration(s.Maximal))
	defer func() {
		ticker.Stop()
	}()
	for {
		select {
		case <-s.exitCh:
			return
		case <-ticker.C:
			vn := atomic.AddInt32(&s.count, 1)
			if vn < s.Maximal {
				continue
			}

			vn %= s.Maximal
			if vn > 0 {
				atomic.StoreInt32(&s.count, s.Maximal)
			}
		}
	}
}

func (s *tokenBucket) take(count int) bool {
	if vn := atomic.AddInt32(&s.count, -1*int32(count)); vn >= 0 {
		return true
	}
	atomic.StoreInt32(&s.count, 0)
	return false
}

func (s *tokenBucket) Take(count int) bool {
	ok := s.take(count)
	return ok
}

func (s *tokenBucket) TakeBlocked(count int) (requestAt time.Time) {
	requestAt = time.Now().UTC()
	ok := s.take(count)
	for !ok {
		time.Sleep(time.Duration(s.rate - (1000 - 1)))
		ok = s.take(count)
	}
	// time.Sleep(time.Duration(s.rate-int64(time.Now().Sub(requestAt))) - time.Millisecond)
	return requestAt
}
```

åœ¨æˆ‘ä»¬çš„è¿™ä»½å®ç°ä¸­ï¼Œä¸æ¼æ¡¶æ³•ç›¸ä¼¼åœ°æ”¯æŒäº†ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¾‹å¦‚æ”¯æŒéé˜»å¡æˆ–è€…é˜»å¡ç‰ˆæœ¬ï¼Œç­‰ç­‰ã€‚Line 76 ç›®å‰è¢«æˆ‘ä»¬æ³¨é‡Šæ‰äº†ï¼Œå› ä¸ºæš‚æ—¶æˆ‘ä»¬ä¸å¸Œæœ›åœ¨ Token Bucket ç®—æ³•ä¸­åšåŒ€é€Ÿå‡ºæ°´çš„é¢å¤–å¤„ç†ï¼šäº‹å®ä¸Šï¼Œç”±äºä»¤ç‰Œæœ¬èº«çš„äº§å‡ºæ˜¯å‡åŒ€çš„ï¼Œæ‰€ä»¥åœ¨é™¤å¼€ä¸€äº›è¾¹ç•Œæ¡ä»¶çš„å…¶å®ƒå¤šæ•°æƒ…å†µä¸­ï¼Œæˆ‘ä»¬ç›´æ¥å°±èƒ½è·å¾—ç›¸å¯¹å‡åŒ€çš„å‡ºæ°´ã€‚è€ŒåŠ ä¸Š Line 76 çš„æ•ˆæœåªæ˜¯ç›¸å¯¹æ›´åŠ å‡åŒ€è€Œå·²ï¼Œæˆ‘è®¤ä¸ºè¿™ä¸ä¸€å®šæ˜¯å¿…é¡»çš„ã€‚

##### å…¶å®ƒç‰¹æ€§

åœ¨æˆ‘ä»¬çš„ä»¤ç‰Œæ¡¶å®ç°ä¸­ï¼Œç”±äºå·²ç»åšäº†ç®—æ³•æŠ½è±¡ï¼Œæ‰€ä»¥åœ¨æ¼æ¡¶æ³•ä¸­å·²ç»æè¿°è¿‡çš„ç‰¹æ€§ï¼Œå¯ä»¥æ¯«æ— éšœç¢åœ°æ”¹ä¸ºä»¤ç‰Œæ¡¶æ³•ã€‚å…·ä½“æ¥è¯´ï¼Œä½¿ç”¨æˆ‘ä»¬çš„ [rate](https://github.com/hedzr/rate) ç»„ä»¶çš„æ–¹å¼æ˜¯è¿™æ ·çš„ï¼š

```go
package main

import (
	"fmt"
	"github.com/hedzr/rate"
	"time"
)

func main() {
  // rate.LeakyBucket, rate.TokenBucket, ...
	l := rate.New(rate.LeakyBucket, 100, time.Second)
	for i := 0; i < 120; i++ {
		ok := l.Take(1)
		if !ok {
			fmt.Printf("#%d Take() returns not ok, counter: %v\n", i, rate.CountOf(l))
			time.Sleep(50 * time.Millisecond)
		}
	}
}
```

ä¸å…¶ç›¸ä¼¼åœ°ï¼Œåœ¨ web server æ¡†æ¶ä¸­ä»¥ä¸­é—´ä»¶çš„æ–¹å¼ä½¿ç”¨æˆ‘ä»¬çš„ rate ç»„ä»¶ï¼š

```go
import (
  "github.com/hedzr/rate"
  "github.com/hedzr/rate/middleware"
)

func engine() *gin.Engine {
	config := &middleware.Config{
		Name:          "A",
		Description:   "A",
		Algorithm:     stirng(rate.TokenBucket),
		Interval:      time.Second,
		MaxRequests:   1000,
		HeaderKeyName: "X-API-TOKEN",
		ExceptionKeys: nil,
	}
	r := gin.Default()
  rg := r.Group("/api")
  rg.Use(middleware.ForGin(config))
  // ...
  
  config2 := ...
  r.Post("/login", middleware.ForGin(config2), loginHandler)
	return r
}
```

å¦‚æœä½ ä¹Ÿåœ¨é‡‡ç”¨æˆ‘ä»¬çš„ [cmdr](https://github.com/hedzr/cmdr)ï¼Œ`middleware.LoadConfig("server.rate-limites")` æˆ–è€… `middleware.LoadConfigForGin("server.rate-limits", rg)` è¿˜å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–ä½ çš„ä»£ç ç¼–å†™ã€‚



##### å¯¹ looper åšå¢å¼º

åœ¨ looper() çš„å®ç°æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ä¸ªåŒ€é€Ÿ producer æ¥ç”Ÿäº§ä»¤ç‰Œã€‚

è€ƒè™‘åˆ°æ›´å¤šæ½œåœ¨çš„é™æµç­–ç•¥å¯èƒ½æ€§ï¼Œåœ¨è¿™é‡Œå®é™…ä¸Šå¯ä»¥è€ƒè™‘é‡‡ç”¨å˜é€Ÿæ–¹æ¡ˆã€‚ä¸€äº›å…¸å‹çš„å¯èƒ½æ€§æœ‰ï¼š

1. logN æˆ–è€… ln åŠ é€Ÿå™¨æ–¹æ¡ˆ
2. å¹³æ»‘å˜æ¯”åŒ€é€Ÿï¼šä»¥ä¸€ä¸ªæ—¶é—´ç‰‡ä¸ºç»Ÿè®¡å•ä½ï¼Œæ—¶åˆ»è°ƒæ•´ rate å€¼ï¼Œä»è€Œåœ¨çªå‘æµé‡æ¶ˆè€—äº†å¤§éƒ¨åˆ†ä»¤ç‰Œä¹‹åï¼Œé™ä½ä»Šåä¸€æ®µæ—¶é—´çš„ä»¤ç‰Œå‘æ”¾é€Ÿåº¦ã€‚åœ¨ Google Guava ä¸­å®ƒè¢«ç§°ä¸º SmoothBusrtyã€‚
3. å¹³æ»‘é¢„çƒ­åŒ€é€Ÿï¼šåˆè¢«ç§°ä½œ SmoothWarmUpã€‚åœ¨ä¸€ä¸ªæ—¶é—´ç‰‡çš„å‰ä¸€éƒ¨åˆ†æ—¶é—´é‡Œä»¥è¾ƒå¿«é€Ÿåº¦å‘æ”¾è¾ƒå¤šä»¤ç‰Œï¼Œæ­¤æ—¶å‘æ”¾ä»¤ç‰Œçš„é€Ÿåº¦å‘ˆç°å‡ºè´ŸåŠ é€Ÿåº¦ï¼›éšåï¼Œå‰©ä½™æ—¶é—´å†…å‰©ä½™ä»¤ç‰Œä»¥åŒ€é€Ÿæ”¾å‡ºã€‚
4. å…¶å®ƒæ›´å¤šæ–¹å¼ï¼šå–å†³äºå…·ä½“çš„ç”Ÿäº§åœºæ™¯ï¼Œå¯ä»¥é€šè¿‡å®šåˆ¶ looper ç®—æ³•æ¥æä¾›æ›´å¤šçš„ç­–ç•¥ï¼ˆç¤ºä¾‹ä»£ç ä¸­æœªäºˆä»¥å®ç°ï¼‰ã€‚

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»¤ç‰Œæ³•ä¸ä½†æ€è·¯æ˜“äºç†è§£ï¼Œä»£ç å®ç°ä¹Ÿæå…¶å®¹æ˜“ã€‚ä¸ä»…å¦‚æ­¤ï¼Œä»¤ç‰Œæ³•çš„è¿è¡Œå¼€é”€ä¹Ÿå·®ä¸å¤šåœ¨å„ç±»å®ç°ä¸­æ˜¯æœ€å°çš„ã€‚

> åœ¨å¼€æºå®ç°ä¸­ï¼Œjuju/ratelimit åŒæ ·åœ°å®ç°äº†ä»¤ç‰Œæ¡¶ç®—æ³•ã€‚





## æ¯”è¾ƒ

åœ¨å‰é¢çš„æ€è€ƒä¸­ï¼Œæˆ‘ä»¬å·²ç»æåˆ°äº†å„ä¸ªç®—æ³•çš„ä¸€äº›ç‰¹ç‚¹ã€‚

åœ¨æœ¬æ–‡èŒƒå›´å†…ï¼Œæœ€åçš„ä¸€ç‚¹æ—¶é—´ï¼Œå§‘ä¸”ç®€å•æ€»ç»“ä¸€ä¸‹å‡ ç§å…¸å‹ç®—æ³•çš„å¼‚åŒï¼š

- è®¡æ•°å™¨æ–¹å¼ï¼šæœ€å®¹æ˜“å®ç°ï¼Œä½†åº”å˜èƒ½åŠ›æœ€å·®ï¼Œæ•ˆç‡è¾ƒé«˜
- æ»‘åŠ¨çª—å£æ³•ï¼šç†è®ºæ˜“äºç†è§£ï¼Œå³å°½å¯èƒ½åœ°ç¼©å°è®¡é‡ç²’åº¦ï¼Œä»è€Œå°†è®¡æ•°å™¨çš„åº”å˜èƒ½åŠ›å¹³æ»‘åœ°æé«˜ã€‚ç„¶è€Œå¾ˆéš¾ä»¥ä»£ç é«˜æ•ˆå®ç°ã€‚
- æ¼æ¡¶æ³•ï¼šè¾ƒå¥½çš„å–èˆï¼Œé’ˆå¯¹è¿›é¡¹æµé‡è¿›è¡Œæ•´å½¢ï¼Œï¼ˆé€šå¸¸ï¼‰ä»¥åŒ€é€Ÿæ”¾å‡ºæµé‡ã€‚
- ä»¤ç‰Œæ³•ï¼šç›¸å¯¹æœ€ä¼˜çš„å–èˆï¼Œé’ˆå¯¹å‡ºå£è¿›è¡Œæ•´å½¢ï¼Œï¼ˆé€šå¸¸æˆ–å¯é€‰åœ°ï¼‰ä»¥è¿‘ä¼¼åŒ€é€Ÿæ”¾å‡ºæµé‡ã€‚éå¸¸å®¹æ˜“æ‹“å±•ä¸ºé’ˆå¯¹ä¸šåŠ¡åœºæ™¯è¿›è¡Œæ•´å½¢å®šåˆ¶ã€‚

å–å†³äºè¿›é¡¹æµé‡å¯å¦è¢«æŠ›å¼ƒï¼Œåœ¨ ratelimit å®ç°æ—¶è¦æ³¨æ„é‡‡ç”¨æ°å½“çš„æ–¹æ³•ï¼š

1. è€ƒè™‘æ˜¯å¦é‡‡ç”¨å¼‚æ­¥æ–¹å¼ï¼ˆå¦è¡Œå¤„ç†è¢«æŠ›å¼ƒæµé‡ï¼‰/ éé˜»å¡æ¨¡å¼ï¼ˆç”±è°ƒç”¨è€…è‡ªè¡Œå¤„ç†è¢«æŠ›å¼ƒæµé‡ï¼‰
   1. å¼‚æ­¥æ–¹å¼ä¸é€‚ç”¨äº API æ¥å£çš„é™æµåœºæ‰€æˆ–è€…ç”¨ä½œ web server middlerware
   2. å¼‚æ­¥æ–¹å¼ã€æˆ–è€…éé˜»å¡æ–¹å¼æœ‰æœ€å¥½çš„è¿›é¡¹æµé‡æ¥æ”¶æ€§èƒ½
2. éé˜»å¡æ¨¡å¼æˆ–é˜»å¡æ–¹å¼çš„é€‰æ‹©

åœ¨æˆ‘ä»¬çš„å®ç°ä»£ç  https://github.com/hedzr/rate ä¸­ï¼Œå¯¹äºé˜»å¡æ–¹å¼æ²¡æœ‰åšæœ€ä¼˜åŒ–å¤„ç†ï¼Œæ‰€ä»¥å‡ºå£å¹¶ä¸ç²¾ç¡®ã€‚å¦‚æœä½ å¯¹è¿™éƒ¨åˆ†ä»£ç å¼‚å¸¸æ„Ÿå…´è¶£ï¼Œæœ€ä½³çš„æºç å‚è€ƒåœ¨ï¼š

1. æ¼æ¡¶ï¼šhttps://github.com/uber-go/ratelimit
2. ä»¤ç‰Œï¼šhttps://github.com/juju/ratelimit



## TODO

è¿™ä¸€ç¯‡ä¸­ï¼Œç•¥å¾®æåŠäº† HPC ä¸­çš„ Rate Limit é—®é¢˜ã€‚ä¸è¿‡ï¼Œè¯¦ç»†è®¨è®ºå®ƒéœ€è¦å¦è¡Œç€å¢¨äº†ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥æå‰åšç®€çŸ­çš„ä»‹ç»ï¼š

1. HPC åœºæ™¯ä¸­ï¼Œé€Ÿç‡é™åˆ¶éœ€è¦è¢«åˆ†å¸ƒå¼åœ°å®ç°
2. åœ¨ç‰¹å®šçš„åˆ†å¸ƒå¼åœºæ™¯ä¸­ï¼Œåˆ†å¸ƒå¼çš„é€Ÿç‡é™åˆ¶å¯ä»¥è€ƒè™‘è¢«æå‡åˆ°å…¥å£ç‚¹ï¼ˆé€šå¸¸å¯èƒ½æ˜¯è´Ÿè½½å‡è¡¡å™¨ï¼Œæˆ–è€…æ˜¯ Microservice API Gateway å¤„ï¼‰å»åŒä¸€ä¸ªå¤„ç†ã€‚
3. å³ä½¿æ˜¯ç”± API GW å¤„ç†ï¼Œä¾ç„¶æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é€Ÿç‡é™åˆ¶å™¨ã€‚



## å‚è€ƒ

- https://github.com/uber-go/ratelimit
- https://github.com/juju/ratelimit
- https://github.com/kevinms/leakybucket-go
- https://github.com/hedzr/rate
- https://en.wikipedia.org/wiki/Bandwidth_management
- https://en.wikipedia.org/wiki/Token_bucket
- https://en.wikipedia.org/wiki/Leaky_bucket
-  [Networking Essentials: Rate Limiting and Traffic Shaping - DEV Community ğŸ‘©â€ğŸ’»ğŸ‘¨â€ğŸ’»](https://dev.to/swyx/networking-essentials-rate-limiting-and-traffic-shaping-43ii) 
-  [Scaling your API with rate limiters](https://stripe.com/blog/rate-limiters) 
-  [How To Design A Scalable Rate Limiting Algorithm](https://konghq.com/blog/how-to-design-a-scalable-rate-limiting-algorithm/) 
-  [NGINX Rate Limiting](https://www.nginx.com/blog/rate-limiting-nginx/) 





ğŸ”š

