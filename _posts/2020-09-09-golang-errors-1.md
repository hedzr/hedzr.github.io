---
layout: single
title: 'Golang errors ç¼–ç¨‹æ¨¡å‹ - Part I'
date: 2020-09-09 23:45:11 +0800
last_modified_at: 2020-09-11 20:32:11 +0800
Author: hedzr
tags: [errors, golang]
categories: golang errors
comments: true
toc: true
header:
  overlay_image: /assets/images/unsplash-image-10.jpg
  overlay_filter: rgba(128, 128, 0, 0.3)
excerpt: >-
  Golang errors æœ€ä½³å®è·µ ...

#  caption: "Photo credit: [**Unsplash**](https://unsplash.com)"
#  actions:
#    - label: "More Info"
#      url: "https://unsplash.com"
---



# Golang errors æœ€ä½³å®è·µ Part I

> è¿™ä¸ªç³»åˆ—çš„æ–‡ç« æœ‰ä¸€å®šçš„æ‘˜æŠ„ï¼Œæ¥è‡ªäºåŸæ–‡ï¼Œä¹ŸåŒ…æ‹¬è¯‘æ–‡ç­‰ç­‰ã€‚
>
> æŠ€å·§æ€»æ˜¯è¢«ä¸æ–­é‡å¤ï¼Œæœ¬ç³»åˆ—çš„ç›®çš„æ˜¯æ•´åˆ Golang é”™è¯¯æ¨¡å‹ï¼Œæ‰€ä»¥åªå¥½æŠ„ä¸€äº›ã€ç¼–ä¸€äº›ã€‚

>ç³»åˆ—è¢«åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š
>
>[ã€‡ã€ç›®å½•é¡µ](/golang/errors/golang-errors/)
>
>[ä¸€ã€æœ€ä½³å®è·µ](/golang/errors/golang-errors-1/)
>
>[äºŒã€è¾…åŠ©åº“](/golang/errors/golang-errors-2/) - [hedzr/errors](https://github.com/hedzr/errors)





## ä¸€ã€Error å¤„ç†æ¨¡å‹ - æœ€ä½³å®è·µ



### æˆ‘ä»¬è®² error æƒ¯ç”¨æ¨¡å‹æ—¶ï¼Œæ˜¯åœ¨è¯´ä»€ä¹ˆï¼Ÿ

è¿™æ˜¯ä¸ªå¾ˆéš¾æªè¾çš„ä¸œè¥¿ã€‚å¤§ä½“ä¸Šè®²ï¼Œæ€æ ·é¿å…ä¸ºä¼—äººæ‰€è¯Ÿç—…çš„é‚£äº› err æ£€æµ‹è¯­å¥ï¼Œé¿å…ä¸æ°å½“åœ°è¿ç”¨å’Œä½¿ç”¨å„ç§å’Œ error å¯¹è±¡æ„é€ ã€æŠ›å‡ºã€æ£€æµ‹ç›¸å…³çš„ç¼–ç æ‰‹æ³•ï¼Œæˆ‘ä»¬åœ¨ä¸‹æ–‡ä¸­å°†å…¶ç§°ä½œä¸º error çš„å¤„ç†æ¨¡å‹çš„æœ€ä½³å®è·µï¼Œä¹Ÿç®—ä½œæ˜¯ error ç›¸å…³å¼€å‘çš„æƒ¯ç”¨æ¨¡å‹ã€‚



#### é”™è¯¯ä»¥åŠé”™è¯¯ç°åœº

ä¸ºäº†æä¾›é”™è¯¯ç°åœºçš„é¢å¤–ä¿¡æ¯ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šï¼š

- åµŒå…¥ä¸€æ¡æ–‡å­—ä¿¡æ¯
- åµŒå…¥è‹¥å¹²ç°åœºå¤„çš„å˜é‡å…·ä½“å€¼
- æ”¶é›†ç°åœºçš„è°ƒç”¨æ ˆã€è¡Œå·ä¿¡æ¯
- ä¸ºåº•å±‚é”™è¯¯åšä¸€æ¬¡å¤–åŒ…è£…ï¼Œç»Ÿä¸€ä¸ºä½ çš„ MyBizError å¯¹è±¡
  - åœ¨æ•ä¿˜åœ°ç‚¹èƒ½å¤Ÿæ›´å¥½åœ°ç»Ÿä¸€å¤„ç†ä¸€åˆ‡ä¸šåŠ¡é€»è¾‘é”™è¯¯ MyBizError
  - åœ¨ä¸šåŠ¡é€»è¾‘å‡ºå£å¯ä»¥ç›´æ¥è¿”å› MyBizError å¯¹è±¡ï¼Œå‡ºå£èƒ½å¤Ÿè‡ªåŠ¨è½¬æ¢è¯¥å¯¹è±¡ä¸º API Error ä¿¡æ¯ç»“æ„ï¼ˆæ— è®ºæ˜¯ Json æ ¼å¼ï¼Œé”™è¯¯ç ï¼Œè¿˜æ˜¯å…¶å®ƒé€šä¿¡å±‚é¢é”™è¯¯ä¿¡æ¯ç»“æ„ï¼‰



æˆ‘ä»¬ä¼šåˆ©ç”¨é”™è¯¯å¤„ç†æ¨¡å‹æ¥åšè¿™äº›äº‹ï¼š

- æä¾›ç»™ç»ˆç«¯ç”¨æˆ·çš„å‹å¥½çš„æ–‡å­—ä¿¡æ¯

  ä¾‹å¦‚ç”¨æˆ·è¾“å…¥ä¿¡æ¯æ ¡éªŒé”™è¯¯æ—¶ï¼Œä½ åº”è¯¥æä¾›ä¸€äº›è¾…åŠ©æ–‡å­—å¸®åŠ©ç”¨æˆ·çº æ­£å…¶è¾“å…¥å†…å®¹

- æä¾›ç»™å¼€å‘å‘˜çš„æœ‰åˆ©äºé”™è¯¯æ’æŸ¥çš„é”™è¯¯ä¿¡æ¯

  ä¾‹å¦‚åç«¯ä¸èƒ½è°ƒç”¨ï¼ŒæŸæŸèµ„æºæ— æ³•è¿æ¥æˆ–è€…è¶…æ—¶



#### é”™è¯¯å¤„ç†çš„æ¼”è¿›

æŒ‰ç…§ä¸€äº›[^1]å®˜æ–¹çš„è§‚ç‚¹ï¼Œé”™è¯¯å¤„ç†å¯ä»¥å½’çº³å¦‚ä¸‹ï¼š

1. Sentinel errors
2. Error Types
3. Opaque errors

è¿™äº›ç±»åˆ«åˆ†åˆ«ä»£è¡¨äº†ä¸åŒçš„é”™è¯¯å¤„ç†æ¨¡å‹ï¼Œä¹Ÿä»£è¡¨ç€æ ‡å‡†åº“åœ¨è¿™æ–¹é¢çš„æ¼”è¿›å†å²ã€‚

> è¯·å‚é˜…ï¼š
>
> - Errors are just values[^1]
> - Don't just check errors, handle them gracefully[^1]

##### Sentinel errors

`Sentinel errors` è¡¨ç¤ºæ— æ³•ç»§ç»­çš„å…³é”®æ€§é”™è¯¯ã€‚æ­¤æ—¶ï¼Œä½ å¿…é¡»ç»ˆæ­¢æ­£åœ¨è¿›è¡Œçš„ä¸šåŠ¡æµç¨‹ï¼Œæ”¾å¼ƒè¿™æ¬¡äº¤æ˜“ã€‚

> Examples include values like `io.EOF` or low level errors like the constants in the `syscall` package, like `syscall.ENOENT`.
>
> There are even sentinel errors that signify that an error *did not* occur, like `go/build.NoGoError, and path/filepath.SkipDir from path/filepath.Walk.`

å¦ä¸€ä¸ªæ–¹é¢ï¼Œ`Sentinel errors` ä¹Ÿä»£è¡¨ç€å¼ºä¾èµ–å…³ç³»ã€‚æ— è®ºä½ åœ¨ä»€ä¹ˆåœ°æ–¹ï¼Œå¦‚æœæƒ³è¦è¿”å›ä¸€ä¸ª io.EOFï¼Œä½ å°±å¿…é¡»å¼•å…¥ io åŒ…ã€‚

ç”±äºè¿™äº›é”™è¯¯æ€»æ‰€å‘¨çŸ¥ä¸”æ˜ç¡®ï¼Œæ‰€ä»¥å¯¹å®ƒä»¬çš„æµ‹è¯•æ˜¯é€šè¿‡ç›¸ç­‰æ¯”è¾ƒæ¥æµ‹è¯•çš„ï¼š

```go
if err == io.EOF { ... }
```



##### Error Types

é”™è¯¯ç±»å‹ `Error Types`[^2] æ˜¯æŒ‡ä½ å®šä¹‰çš„ä¸€ä¸ªå®ç°äº† error æ¥å£çš„ç»“æ„ç±»å‹ã€‚ä¸ºäº†å­˜å‚¨ä¸€ä¸ªç°åœºçš„å‡ ä¸ªä¸Šä¸‹æ–‡ç›¸å…³çš„å˜é‡ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªä¸“é—¨çš„é”™è¯¯ç±»ï¼š

```go
type MyError struct {
	Msg string
	File string
	Line int
}

func (e *MyError) Error() string {
	return fmt.Sprintf("%s:%d: %sâ€, e.File, e.Line, e.Msg)
}

return &MyError{"Something happened", â€œserver.go", 42}
```

åœ¨è¿™é‡Œï¼Œ`MyError` ç±»å‹è·Ÿè¸ªæ–‡ä»¶å’Œè¡Œï¼Œä»¥åŠè§£é‡Šæ‰€å‘ç”Ÿæƒ…å†µçš„æ¶ˆæ¯ã€‚

å¯¹è‡ªå®šä¹‰çš„é”™è¯¯ç±»å‹ï¼Œä»¥å‰æ€»æ˜¯é‡‡ç”¨ err.(*OpErr) çš„æ–¹å¼æ¥æ£€æµ‹ï¼š

```go
err := something()
switch err := err.(type) {
case nil:
	// call succeeded, nothing to do
case *MyError:
	fmt.Println(â€œerror occurred on line:â€, err.Line)
default:
	// unknown error
}
```

å¦‚ä¸Šï¼Œä¼ ç»Ÿæ–¹å¼æ˜¯é‡‡ç”¨ç±»å‹è¯Šæ–­ï¼Œè¿™æ˜¯å·²ç»ç¡®ä¿¡ä¸å¥½çš„æ–¹å¼ï¼Œåœ¨ go 1.13 ä¹‹åæ›´æ¨èä½¿ç”¨ errors.As() [^3] æ¥æµ‹è¯•å®ƒã€‚

```go
var e *MyError
if errors.As(err, &e) {
  // handle error
}
```

è‡ªå®šä¹‰é”™è¯¯ç±»èƒ½å¤Ÿå¾ˆå¥½åœ°æä¾›é”™è¯¯ç°åœºçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä½†å®ƒä»ç„¶æ˜¯å¼ºä¾èµ–å…³ç³»çš„ã€‚

æ­¤å¤–ï¼Œè€å®è¯´ï¼Œerrors.As() ä¹Ÿå¹¶ä¸æ˜¯å¾ˆå¥½çš„æ”¹è¿›ã€‚



##### Opaque errors

`Opaque errors` å¯ä»¥è¢«è®¤ä¸ºæ˜¯éšæ€§é”™è¯¯ã€‚è¿™æ˜¯å› ä¸ºå½“é”™è¯¯å‘ç”Ÿæ—¶ï¼Œä½ æ— æ³•å–å¾—è¯¥é”™è¯¯çš„ç±»å‹ï¼Œæ— æ³•å®Œæˆç±»å‹è¯Šæ–­ã€‚æ ‡å‡†åº“ä¸­æœ‰ä¸å°‘è¿™æ ·çš„å®ä¾‹ï¼Œä¾‹å¦‚ç½‘ç»œæ“ä½œçš„è¶…æ—¶é”™è¯¯ç­‰ã€‚ä¹‹æ‰€ä»¥æ— æ³•å–å¾—é”™è¯¯ç±»å‹ï¼ŒåŸå› åœ¨äºç›¸åº”çš„é”™è¯¯ç±»å‹æ˜¯ non-exported çš„ã€‚

æ ‡å‡†åº“è¶Šæ¥è¶Šå¤šåœ°é‡‡ç”¨è¿™ç§å«æ··çš„ã€æŸ”æ€§çš„é”™è¯¯æŠ›å‡ºæ–¹å¼ï¼ŒåŸå› åœ¨äºä½ å¹¶ä¸éœ€è¦å¯¹é”™è¯¯è¿›è¡Œç±»å‹è¯Šæ–­ï¼Œæ›´ä¸éœ€è¦åœ¨å¤„ç†é”™è¯¯æ—¶ä¸å¾—ä¸å¼•å…¥å¯¹åº”åŒ…çš„ä¾èµ–å…³ç³»ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥é‡‡ç”¨è¡Œä¸ºè¯Šæ–­çš„æ–¹å¼æ¥æµ‹è¯•é”™è¯¯ï¼š

```go
if te, ok := err.(interface{ Temorary() bool}); ok && te.Temporary() {
  // handle temproray error
}
```





### é”™è¯¯å¤„ç†çš„åŸºæœ¬æ¨¡å‹

å¥½çš„æ¨¡å¼æ˜¯ï¼š

```go
ret1, ..., err := aFunction(...)
if err != nil {
  // handle error
  return ...
}

// go on doing something
ret1....
```

ä¸å¥½çš„æ¨¡å¼æ˜¯ï¼š

```go
ret1, ..., err := aFunction(...)
if err == nil {
  // doing something
  return ...
}

// handle error
```

ä¸å¥½çš„æ¨¡å¼ä¼šå¸¦æ¥é¢å¤–çš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œä¸å¤ªç¬¦åˆäººé˜…è¯»ä¸šåŠ¡é€»è¾‘çš„ä»ä¸Šåˆ°ä¸‹çš„éšå¼æœŸå¾…ã€‚



### èšåˆé”™è¯¯ä»¥åˆ©äº Coverage Test

ç„¶è€Œï¼Œè¿™å¹¶éç»å¯¹ã€‚

å½“ä¸ºäº†æ›´å¥½çš„ coverage æµ‹è¯•æ—¶ï¼Œåˆæˆ–è€…ä¸ºäº†é›†ä¸­å…¨éƒ¨é”™è¯¯åˆ†æ”¯åˆ°ä¸€å¤„æ—¶ï¼Œ`err == nil` ä¹Ÿæ˜¯å¸¸å¸¸è¢«ç”¨åˆ°çš„ï¼š

```go
var (
  err error
  ret1, ret2, ..., 
)

ret1, ..., err = aFunction(...)
if err == nil {
  ..., err = bFunction(...)
	if err == nil {
	  ..., err = cFunction(...)
		if err == nil {
		  return ...
    }
  }
}

// handle error
```

è¯·æ³¨æ„ï¼Œè¿™ç§ä¾‹å¤–ä¸å®œæ»¥ç”¨ã€‚

å®ƒçš„å¥½å¤„æ˜¯ï¼Œä½ å¯ä»¥ä¸å¿…ä¸ºäº†è¿™ä¸€ç»„ä»£ç æä¾›å……åˆ†çš„é”™è¯¯æ ·æœ¬è€Œé¡ºåˆ©å®Œæˆè¦†ç›–æµ‹è¯•ï¼Œè¿™å¯¹äºå·²ç»ç¡®çŸ¥çš„åºåˆ—æ¥è¯´å¯ä»¥çœå´ä¸å¿…è¦çš„å†—é•¿æµ‹è¯•ã€‚å…¶åå¤„ä¹Ÿæ˜¾è€Œæ˜“è§ï¼Œä½ è·³è¿‡äº†æä¾›ä¸´ç•Œæ ·æœ¬ä¹Ÿå°±æ”¾å¼ƒäº†éªŒè¯è¿™äº›æ ·æœ¬å¯èƒ½å¸¦æ¥çš„æ½œåœ¨çš„é—®é¢˜ã€‚



### é‡‡ç”¨ Deferã€Recover å’Œ Panic

ç•¥ï¼Œè¯·å‚è€ƒ [^4]



### ä¸è¦ç›´æ¥è¿”å› error

```go
sth, err = subfunc()
if err != nil {
  return nil
}
```

æ¢å¥è¯è¯´ï¼ŒDon't just check errors, handle them gracefully[^1]ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œä½œä¸ºsubfunc()çš„è°ƒç”¨è€…ï¼Œä½ åº”è¯¥æ”¶é›†æˆ–æä¾›ä¸€å®šçš„ç°åœºä¿¡æ¯ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›ç”± subfunc() æä¾›çš„é”™è¯¯ã€‚

> é™¤éï¼Œä½ çš„å‡½æ•°ä»…ä»…æ˜¯ä¸€ä¸ªåŒ…è£…è€…ã€‚
>
> æˆ‘ä»¬åœ¨ç¼–å†™å¤§å‹ä¸šåŠ¡é€»è¾‘ä»£ç æ—¶ï¼Œä¸ºäº†å°†ä¸€ä¸ªå®Œæ•´çš„é€»è¾‘ä¹¦å†™çš„æ›´æ˜“æ‡‚ï¼Œå¾€å¾€ä¼šå°†å…¶æ‹†åˆ†ä¸ºè‹¥å¹²å°å‡½æ•°ã€‚å¯¹äºè¿™äº›å°å‡½æ•°è€Œè¨€ï¼Œä»–ä»¬ä»…ä»…å……å½“äº†å¼€å‘è€…æ›´å‹å¥½çš„åŒ…è£…è€…è§’è‰²ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä¸å¿…åœ¨è¿™äº›åŒ…è£…å‡½æ•°ä½“ä¸­å¯¹åº•å±‚é”™è¯¯å†åŒ…è£…ï¼Œå¦‚æœä½ å·²ç»åœ¨ä¸šåŠ¡é€»è¾‘çš„æ€»å‡½æ•°ä¸­è¿›è¡Œäº†å…¨éƒ¨é”™è¯¯è¯†åˆ«ã€å¤„ç†å’Œå†åŒ…è£…å·¥ä½œçš„è¯ã€‚



å¦‚æœä½ æ•ä¿˜äº†ä¸€ä¸ªé”™è¯¯ï¼Œé‚£ä¹ˆä½ åº”è¯¥å¯¹å…¶è¿›è¡Œè‰¯å¥½çš„å¤„ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ€»æ˜¯ä¸€å¾‹panicæ˜¯ä¸å¯¹çš„ï¼Œæ€»æ˜¯ç®€å•åœ° log.Errorf ä¹Ÿæœªå¿…æ­£ç¡®ï¼Œè¦ä¸è¦ defer recover ä¹Ÿä¸€å®šè¦ä¾æ®å®é™…æƒ…å†µè¿›è¡Œå®Œå–„çš„é€‰æ‹©å’Œå†³å®šã€‚

ä¸ºäº†èƒ½è®©ä½¿ç”¨è€…èƒ½å¤Ÿå¾ˆå¥½åœ°æ•ä¿˜é”™è¯¯å¹¶åˆ†ç±»å¤„ç†å®ƒä»¬ï¼Œåº“ä½œè€…éœ€è¦ï¼š

1. æ ¹æ®åº“çš„é€»è¾‘ï¼Œå°è£…æ‰€æœ‰é”™è¯¯ï¼ˆæ— è®ºå®ƒä»¬æ¥è‡ªäºç¡¬ä»¶ã€OSã€ç½‘ç»œè¿˜æ˜¯åº“è‡ªèº«çš„ä¸åŒéƒ¨åˆ†çš„ä¸šåŠ¡é€»è¾‘ï¼‰ä¸ºå•ä¸€çš„ã€æˆ–è€…å‡ ç§ä¸»è¦çš„ error typesï¼Œæˆ–è€…å°†å®ƒä»¬å°è£…åˆ°å‡ ç§ä¸åŒçš„ behaviorsï¼Œä»¥ä¾¿ä½¿ç”¨è€…èƒ½å¤Ÿä»¥è‰¯å¥½çš„ä»£ç é£æ ¼å’Œç»“æ„æ•ä¿˜è¿™äº›é”™è¯¯
2. å¿…è¦æ—¶ï¼Œåº“ä½œè€…åº”è¯¥æ©ç›–æ— è¶³è½»é‡çš„å†…éƒ¨é”™è¯¯ï¼Œè¿™å–å†³äºåº“æœ¬èº«åº”è¯¥æä¾›æ€æ ·çš„ä¸šåŠ¡é€»è¾‘



### åœ¨ç»“æ„ä½“ä¸­ç¼“å­˜é”™è¯¯å¯¹è±¡

åœ¨ Rob Pike çš„ [Errors are values](https://blog.golang.org/errors-are-values)[^5] ä¸€æ–‡ä¸­ï¼Œä»–æåˆ°äº†æ ‡å‡†åº“ä¸­ä½¿ç”¨äº†ä¸€ç§ç®€åŒ–é”™è¯¯å¤„ç†ä»£ç çš„æŠ€å·§ï¼Œbufioçš„Writerå°±ä½¿ç”¨äº†è¿™ä¸ªæŠ€å·§ï¼š

```go
b := bufio.NewWriter(fd)
b.Write(p0[a:b])
b.Write(p1[c:d])
b.Write(p2[e:f])
// and so on
if b.Flush() != nil {
    return b.Flush()
}
```



å®é™…ä¸Šï¼Œè¿™ç§æ¨¡å¼åœ¨æ ‡å‡†åº“ä¸­è¢«å¹¿æ³›ä½¿ç”¨ï¼Œä¾‹å¦‚ [`archive/zip`](https://golang.org/pkg/archive/zip/) å’Œ [`net/http`](https://golang.org/pkg/net/http/) åŒ…ç­‰ç­‰ã€‚è¯¥è®¨è®ºæœ€æ˜¾è‘—çš„æ˜¯ï¼Œ [`bufio` åŒ…çš„ `Writer`](https://golang.org/pkg/bufio/) å®é™…ä¸Šæ˜¯ `errWriter` æƒ³æ³•çš„å®ç°ã€‚ å°½ç®¡ `bufio.Writer.Write` è¿”å›é”™è¯¯ï¼Œä½†ä¸»è¦æ˜¯åœ¨äºå®ç° [`io.Writer`](https://golang.org/pkg/io/#Writer) æ¥å£ã€‚ `bufio.Writer` çš„ `Write` æ–¹æ³•ä¸ä¼šç›´æ¥æŠ¥å‘Šé”™è¯¯ï¼Œè€Œæ˜¯ç”± `Flush` æŠ¥å‘Šé”™è¯¯ï¼Œå› æ­¤æˆ‘ä»¬çš„ç¤ºä¾‹å¯ä»¥åƒè¿™æ ·ç¼–å†™ï¼š

```go
b := bufio.NewWriter(fd)
b.Write(p0[a:b])
b.Write(p1[c:d])
b.Write(p2[e:f])
// and so on
if b.Flush() != nil {
    return b.Flush()
}
```

åœ¨å†…é‡Œï¼Œbufio.Writer.Write ä¼šæ£€æµ‹è‡ªå·±ç¼“å­˜çš„ errï¼Œå¦‚æœå·²ç»å‡ºé”™äº†ï¼ŒWrite ä¸ä¼šå†æ‰§è¡Œæ­£å¸¸çš„é€»è¾‘è€Œæ˜¯ç›´æ¥è¿”å›ã€‚



è‡³å°‘å¯¹äºæŸäº›åº”ç”¨ç¨‹åºï¼Œ è¿™ç§æ–¹æ³•æœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹ï¼šåœ¨é”™è¯¯å‘ç”Ÿä¹‹å‰æ— æ³•çŸ¥é“å®Œæˆäº†å¤šå°‘å¤„ç†ã€‚ å¦‚æœè¯¥ä¿¡æ¯å¾ˆé‡è¦ï¼Œåˆ™éœ€è¦é‡‡ç”¨æ›´ç»†ç²’åº¦çš„æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œé€šå¸¸ï¼Œæœ€åå…¨æœ‰æˆ–å…¨æ— æ£€æŸ¥å°±è¶³å¤Ÿäº†ã€‚

> ä¸ºäº†æ”¹å–„è¿™ä¸€é—®é¢˜ï¼Œ[hedzr/errors](https://github.com/hedzr/errors) æä¾›äº† `NewContainer` æ¥å¸®åŠ©ä½ åœ¨ç»“æ„ä½“ä¸­ç¼“å­˜å¤šä¸ªæ­¥éª¤æˆ–å¤šæ¬¡è¿­ä»£çš„å…¨éƒ¨é”™è¯¯ã€‚è¯¦è§æœ¬ç³»åˆ—æ–‡ç« çš„ä¸‹ä¸€éƒ¨åˆ†ï¼š[äºŒã€è¾…åŠ©åº“](/golang/errors/golang-errors-2/) - [hedzr/errors](https://github.com/hedzr/errors)



å®ƒçš„å®ç°æœºåˆ¶å¹¶ä¸å¤æ‚ï¼Œåœ¨ errWriter çš„å†…éƒ¨ç¼“å­˜äº†ä¸€ä¸ª error å¯¹è±¡ï¼š

```go
type errWriter struct {
    w   io.Writer
    err error
}

func (ew *errWriter) Write(buf []byte) {
    if ew.err != nil {
        return
    }
    _, ew.err = ew.w.Write(buf)
}

func (ew *errWriter) Flush() error {
  ew.w.Flush()
  return ew.err
}
```

ä»è€Œå°†å¤šä¸ªæ­¥éª¤çš„ Write äº§ç”Ÿçš„é”™è¯¯ç´¯ç§¯åˆ°äº† Flush() è¿”å›æ—¶å†è¿›è¡Œå¤„ç†ã€‚



### æµ‹è¯•å…¶è¡Œä¸ºè€Œä¸æ˜¯æµ‹è¯•å…¶ç±»å‹[^1]

ä»¥å‰æˆ‘ä»¬å¯èƒ½ä¹ æƒ¯äºè¿™æ ·å­æµ‹è¯•ä¸€ä¸ªé”™è¯¯ç±»å‹ï¼š

```go
if err, ok := err.(*MyError); ok { â€¦ }
```

ä¸è¿‡ï¼Œæ›´å¥½çš„æ–¹æ³•è‡³å°‘æœ‰ä¸¤ä¸ªï¼š

1. é€šè¿‡ Is(err, type) æµ‹è¯•
2. é€šè¿‡æµ‹è¯•å…¶è¡Œä¸º



#### æµ‹è¯•å…¶è¡Œä¸º

å¯¹äº os.temporaryErr è€Œè¨€ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ä¸‹é¢çš„æ–¹å¼æ¥æµ‹è¯•å®ƒï¼š

```go
type temporary interface {
	Temporary() bool
}

// IsTemporary returns true if err is temporary.
func IsTemporary(err error) bool {
	te, ok := err.(temporary)
	return ok && te.Temporary()
}
```

ç”šè‡³æˆ‘ä»¬å¯ä»¥é‡‡ç”¨å†…è”çš„æ–¹å¼ç®€åŒ–ä»£ç ï¼ˆä½†ä¼šç¨å¾®éšæ™¦ä¸€äº›ï¼‰ï¼š

```go
if te, ok := err.(interface{ Temorary() bool}); ok && te.Temporary() {
  // handle temproray error
}
```



### å°ç»“

ä¸Šé¢å¯¹ä¸€äº›æƒ…å½¢è¿›è¡Œäº†æ€»ç»“ã€‚è¿™é‡Œå·²ç»æ¶µç›–äº†æœ€ä¸»è¦çš„åœºæ™¯ï¼Œä¸è¿‡æ›´å¤šçš„åœºæ™¯ä»¥åŠå‡†åˆ™ä»ç„¶æœªèƒ½å°½å½•ï¼Œè¯·å‚è€ƒè„šæ³¨æåŠçš„æ–‡ç« ã€‚












[^1]: [Don't just check errors, handle them gracefully - Dave Cheney](https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully)
[^2]: [Error handling and Go - The Go Blog](https://blog.golang.org/error-handling-and-go) 
[^3]:  [Working with Errors in Go 1.13 - The Go Blog](https://blog.golang.org/go1.13-errors) 
[^4]:  [Defer, Panic, and Recover - The Go Blog](https://blog.golang.org/defer-panic-and-recover) 
[^5]: [Errors are values - The Go Blog](https://blog.golang.org/errors-are-values)







ğŸ”š